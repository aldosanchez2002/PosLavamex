<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavamex Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0,react-dom@18.2.0",
        "recharts": "https://esm.sh/recharts@2.12.2?deps=react@18.2.0,react-dom@18.2.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
</head>

<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
            XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area,
            ReferenceLine, ComposedChart
        } from 'recharts';
        import {
            TrendingUp, Users, Calendar, Clock, DollarSign, Activity,
            Award, ArrowUpRight, ArrowDownRight, Filter, Wallet, ShieldAlert, PiggyBank, Lock,
            Droplets, Percent, Briefcase, Car
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, getDocs, query, where, orderBy } from 'firebase/firestore';

        const firebaseConfig = {
            apiKey: "AIzaSyByIvJpBZv32Zd22fxlYWL9etzBa66Q2rE",
            authDomain: "poslavamex.firebaseapp.com",
            projectId: "poslavamex",
            storageBucket: "poslavamex.firebasestorage.app",
            messagingSenderId: "883264129",
            appId: "1:883264129:web:39a352e2ade3888b4f1b80"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Helpers ---
        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val);
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ef4444'];

        const KPICard = ({ title, value, subtext, icon: Icon, trend, color = "blue" }) => {
            const colorClasses = {
                blue: "bg-blue-100 text-blue-600",
                green: "bg-green-100 text-green-600",
                red: "bg-red-100 text-red-600",
                orange: "bg-orange-100 text-orange-600",
                purple: "bg-purple-100 text-purple-600",
                indigo: "bg-indigo-100 text-indigo-600",
                pink: "bg-pink-100 text-pink-600",
                cyan: "bg-cyan-100 text-cyan-600",
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div className="flex justify-between items-start mb-4">
                        <div className={`p-3 rounded-lg ${colorClasses[color] || colorClasses.blue}`}>
                            <Icon size={24} />
                        </div>
                        {trend && (
                            <span className={`flex items-center text-sm font-bold ${trend === 'up' ? 'text-green-500' : 'text-red-500'}`}>
                                {trend === 'up' ? <ArrowUpRight size={16} /> : <ArrowDownRight size={16} />}
                            </span>
                        )}
                    </div>
                    <h3 className="text-slate-500 text-sm font-medium mb-1 uppercase tracking-wide">{title}</h3>
                    <div className="text-3xl font-bold text-slate-800 mb-1">{value}</div>
                    {subtext && <div className="text-slate-400 text-xs">{subtext}</div>}
                </div>
            );
        };

        const AnalyticsDashboard = () => {
            // Authentication State
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');

            // Data State
            const [tickets, setTickets] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [bizExpenses, setBizExpenses] = useState([]);
            const [cashCounts, setCashCounts] = useState([]);
            const [employees, setEmployees] = useState([]);
            const [loading, setLoading] = useState(true);
            const [timeRange, setTimeRange] = useState('MONTH'); // Default to MONTH for better relevance

            useEffect(() => {
                if (!isAuthenticated) return; // Don't fetch data until logged in

                const fetchData = async () => {
                    try {
                        const ticketsPromise = getDocs(query(collection(db, "tickets"), orderBy("timestamp", "desc")));
                        const expensesPromise = getDocs(query(collection(db, "expenses"), orderBy("timestamp", "desc")));
                        const bizExpPromise = getDocs(query(collection(db, "business_expenses"), orderBy("timestamp", "desc")));
                        const cashCountsPromise = getDocs(query(collection(db, "cash_counts"), orderBy("timestamp", "desc")));
                        const empPromise = getDocs(query(collection(db, "employees")));

                        const [tSnap, eSnap, beSnap, ccSnap, empSnap] = await Promise.all([ticketsPromise, expensesPromise, bizExpPromise, cashCountsPromise, empPromise]);

                        setTickets(tSnap.docs.map(d => ({ id: d.id, ...d.data(), date: d.data().timestamp?.toDate() || new Date() })).filter(t => t.status === 'PAID' || t.status === 'ARCHIVED'));
                        setExpenses(eSnap.docs.map(d => ({ id: d.id, ...d.data(), date: d.data().timestamp?.toDate() || new Date() })).filter(e => e.status === 'APPROVED'));
                        setBizExpenses(beSnap.docs.map(d => ({ id: d.id, ...d.data(), date: d.data().timestamp?.toDate() || new Date() })));
                        setCashCounts(ccSnap.docs.map(d => ({ id: d.id, ...d.data(), date: d.data().timestamp?.toDate() || new Date() })));
                        setEmployees(empSnap.docs.map(d => ({ id: d.id, ...d.data() })));

                    } catch (err) {
                        console.error(err);
                        alert("Error cargando datos");
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [isAuthenticated]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (passwordInput === 'covington521') {
                    setIsAuthenticated(true);
                } else {
                    alert('Contraseña incorrecta');
                    setPasswordInput('');
                }
            };

            const processed = useMemo(() => {
                if (tickets.length === 0) return null;

                const now = new Date();
                const filterDate = (item) => {
                    if (timeRange === 'ALL') return true;
                    if (timeRange === 'YEAR') return item.date.getFullYear() === now.getFullYear();
                    if (timeRange === 'MONTH') return item.date.getMonth() === now.getMonth() && item.date.getFullYear() === now.getFullYear();
                    return true;
                };

                const fTickets = tickets.filter(filterDate);
                const fExpenses = expenses.filter(filterDate);
                const fBizExpenses = bizExpenses.filter(filterDate);
                const fCashCounts = cashCounts.filter(filterDate);

                // --- 1. Financials ---
                const totalRevenue = fTickets.reduce((acc, t) => acc + (t.price || 0), 0);

                // 1. Labor: Washer Commissions (Direct per ticket)
                const laborCommission = fTickets.reduce((acc, t) => acc + (t.commission || 0), 0);

                // 2. Labor: Fixed Salaries (Estimate based on duration)
                // MODIFIED: Filter first to get count, then sum
                const salariedEmployees = employees.filter(e => e.active && (parseFloat(e.baseSalary) || 0) > 0);
                const weeklyFixedLabor = salariedEmployees.reduce((acc, e) => acc + (parseFloat(e.baseSalary) || 0), 0);
                const salariedCount = salariedEmployees.length;

                // Filter for supervisors only for the Sales Commission calculation below
                const activeSupervisors = employees.filter(e => e.active && (e.role === 'SUPERVISOR' || e.isSupervisor === true));

                let daysInRange = 1;
                if (fTickets.length > 0) {
                    const dates = fTickets.map(t => t.date);
                    const minD = new Date(Math.min(...dates));
                    const maxD = new Date(Math.max(...dates));
                    daysInRange = Math.max(1, Math.ceil((maxD - minD) / (1000 * 60 * 60 * 24)) + 1);
                }
                const laborSalary = (weeklyFixedLabor / 7) * daysInRange;

                // 3. Labor: Supervisor Sales Commissions (% of Total Revenue)
                const supervisorSalesCommTotal = activeSupervisors.reduce((acc, emp) => {
                    const pct = parseFloat(emp.commissionPct) || parseFloat(emp.commissionPercent) || 0;
                    return acc + (totalRevenue * (pct / 100));
                }, 0);

                // 4. Labor: Bolero Commissions (% of Boleada Revenue)
                let totalBoleadaRevenue = 0;
                fTickets.forEach(t => {
                    if (t.extras && Array.isArray(t.extras)) {
                        t.extras.forEach(e => {
                            if (['BOLEADA', 'QA_BOLEADA'].includes(e.id)) {
                                totalBoleadaRevenue += (e.price || 0);
                            }
                        });
                    }
                });

                const activeBoleros = employees.filter(e => e.active && e.role === 'BOLERO');
                const boleroCommTotal = activeBoleros.reduce((acc, emp) => {
                    const pct = parseFloat(emp.commissionPct) || 50;
                    return acc + (totalBoleadaRevenue * (pct / 100));
                }, 0);

                // Total Labor Cost
                const totalLabor = laborCommission + laborSalary + supervisorSalesCommTotal + boleroCommTotal;

                // Operating Expenses (Non-Labor)
                const operationalExp = fExpenses.reduce((acc, e) => acc + (e.amount || 0), 0);
                const adminExp = fBizExpenses.reduce((acc, e) => acc + (e.amount || 0), 0);
                const totalOpExpenses = operationalExp + adminExp;

                const totalExpenses = totalLabor + totalOpExpenses;
                const netProfit = totalRevenue - totalExpenses;

                // Percentages
                const profitMarginPct = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
                const totalLaborPct = totalRevenue > 0 ? (totalLabor / totalRevenue) * 100 : 0;
                const totalOpExpensesPct = totalRevenue > 0 ? (totalOpExpenses / totalRevenue) * 100 : 0;

                // Detailed Labor Percentages
                const laborCommPct = totalRevenue > 0 ? (laborCommission / totalRevenue) * 100 : 0;
                const laborSupCommPct = totalRevenue > 0 ? (supervisorSalesCommTotal / totalRevenue) * 100 : 0;
                const laborBoleroCommPct = totalRevenue > 0 ? (boleroCommTotal / totalRevenue) * 100 : 0;
                const laborSalaryPct = totalRevenue > 0 ? (laborSalary / totalRevenue) * 100 : 0;

                const avgTicket = totalRevenue / (fTickets.length || 1);
                const avgTicketsPerDay = fTickets.length > 0 ? fTickets.length / daysInRange : 0;

                // --- NEW: Armor All Analysis ---
                // Regex to catch "armorall", "armor all", "armor-all", case insensitive
                const armorRegex = /armor\s*-?all/i;

                // Scan both operational and business expenses just in case it was categorized wrong
                const allExpensesForPeriod = [...fExpenses, ...fBizExpenses];

                const armorAllExpenses = allExpensesForPeriod.filter(e => {
                    const desc = e.description || e.note || e.concept || '';
                    return armorRegex.test(desc);
                });

                const totalArmorAllCost = armorAllExpenses.reduce((acc, e) => acc + (parseFloat(e.amount) || 0), 0);
                const armorAllPerWash = fTickets.length > 0 ? totalArmorAllCost / fTickets.length : 0;

                // --- Top 10 Gastos ---
                const topGastos = allExpensesForPeriod
                    .sort((a, b) => (parseFloat(b.amount) || 0) - (parseFloat(a.amount) || 0))
                    .slice(0, 10);

                // --- 2. Trends (Monthly) ---
                const monthlyStats = {};
                // Helper to init month object
                const getMonthObj = (date) => {
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyStats[key]) monthlyStats[key] = { name: key, revenue: 0, expenses: 0, profit: 0, labor: 0 };
                    return monthlyStats[key];
                }

                fTickets.forEach(t => { const m = getMonthObj(t.date); m.revenue += (t.price || 0); m.labor += (t.commission || 0); });
                fExpenses.forEach(e => { const m = getMonthObj(e.date); m.expenses += (e.amount || 0); });
                fBizExpenses.forEach(e => { const m = getMonthObj(e.date); m.expenses += (e.amount || 0); });

                // Calculate profit per month (Simplified for chart)
                Object.values(monthlyStats).forEach(m => { m.profit = m.revenue - m.expenses - m.labor; });
                const chartFinancials = Object.values(monthlyStats).sort((a, b) => a.name.localeCompare(b.name));

                // --- Daily Trends (Tickets, Venta, Pinos, Snacks) ---
                const dailyStats = {};
                fTickets.forEach(t => {
                    const dStr = new Intl.DateTimeFormat('es-MX', { day: '2-digit', month: 'short' }).format(t.date);
                    if (!dailyStats[dStr]) {
                        dailyStats[dStr] = { dateLabel: dStr, sortKey: t.date.getTime(), tickets: 0, venta: 0, pinos: 0, snacks: 0 };
                    }
                    const ds = dailyStats[dStr];
                    ds.tickets += 1;
                    ds.venta += (t.price || 0);
                    ds.snacks += (t.snackCount || 0);

                    if (t.extras && Array.isArray(t.extras)) {
                        t.extras.forEach(e => {
                            if (['PINO', 'QA_PINO'].includes(e.id)) {
                                ds.pinos += 1;
                            }
                        });
                    }
                });
                const chartDailyTrends = Object.values(dailyStats).sort((a, b) => a.sortKey - b.sortKey);

                // --- 3. Expense Composition ---
                const chartExpenses = [
                    { name: 'Comisión Lavadores', value: laborCommission },
                    { name: 'Comisión Supervisores', value: supervisorSalesCommTotal },
                    { name: 'Comisión Bolero', value: boleroCommTotal },
                    { name: 'Salarios Base', value: laborSalary },
                    { name: 'Gastos Operativos', value: operationalExp },
                    { name: 'Gastos Admin', value: adminExp }
                ].filter(i => i.value > 0);

                // --- 4. Employee Performance ---
                const empStats = {};
                fTickets.forEach(t => {
                    const washers = t.washers || (t.washer ? [t.washer] : []);
                    washers.forEach(w => {
                        if (!empStats[w]) empStats[w] = { name: w, tickets: 0 };
                        empStats[w].tickets += 1;
                    });
                });
                const chartEmployees = Object.values(empStats).sort((a, b) => b.tickets - a.tickets).slice(0, 10);

                // --- 7. Service Popularity ---
                const serviceStats = {};
                fTickets.forEach(t => {
                    const svcName = t.service?.label || 'Solo Extras';
                    if (!serviceStats[svcName]) serviceStats[svcName] = { name: svcName, value: 0 };
                    serviceStats[svcName].value += 1;
                });
                const chartServices = Object.values(serviceStats).sort((a, b) => b.value - a.value);

                return {
                    totalRevenue, totalExpenses, netProfit, profitMarginPct, avgTicket, ticketCount: fTickets.length,
                    avgTicketsPerDay,
                    laborCommission, laborSalary, supervisorSalesCommTotal, boleroCommTotal, totalLabor,
                    laborCommPct, laborSalaryPct, laborSupCommPct, laborBoleroCommPct, totalLaborPct,
                    totalOpExpenses, totalOpExpensesPct,
                    armorAllPerWash, totalArmorAllCost, salariedCount,
                    chartFinancials, chartExpenses, chartEmployees, chartServices,
                    chartDailyTrends, topGastos
                };

            }, [tickets, expenses, bizExpenses, cashCounts, employees, timeRange]);

            // Authentication View
            if (!isAuthenticated) {
                return (
                    <div className="flex h-screen items-center justify-center bg-slate-100 p-4">
                        <form onSubmit={handleLogin} className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-slate-200">
                            <div className="flex justify-center mb-6">
                                <div className="bg-slate-100 p-4 rounded-full">
                                    <Lock size={32} className="text-slate-600" />
                                </div>
                            </div>
                            <input
                                type="password"
                                value={passwordInput}
                                onChange={(e) => setPasswordInput(e.target.value)}
                                placeholder="Contraseña"
                                className="w-full border p-4 rounded-xl mb-4 bg-slate-50 focus:bg-white transition-colors"
                                autoFocus
                            />
                            <button type="submit" className="w-full bg-slate-900 text-white p-4 rounded-xl font-bold hover:bg-slate-800 transition-colors shadow-lg shadow-slate-200">
                                ENTRAR
                            </button>
                        </form>
                    </div>
                );
            }

            if (loading) return (
                <div className="flex h-screen items-center justify-center text-slate-500">
                    <Activity className="animate-spin mr-2" /> Cargando inteligencia de negocio...
                </div>
            );

            if (!processed) return <div className="p-10 text-center">No hay datos disponibles.</div>;

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
                    <header className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                <Activity className="text-blue-600" /> Dashboard Gerencial
                            </h1>
                        </div>
                        <div className="bg-white p-1 rounded-lg border flex shadow-sm">
                            {['ALL', 'YEAR', 'MONTH'].map(range => (
                                <button
                                    key={range}
                                    onClick={() => setTimeRange(range)}
                                    className={`px-4 py-2 text-sm font-bold rounded-md transition-all ${timeRange === range ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:bg-slate-50'}`}
                                >
                                    {range === 'ALL' ? 'Histórico' : (range === 'YEAR' ? 'Este Año' : 'Este Mes')}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* SECTION 1: FINANCIAL HEALTH */}
                    <div>
                        <h2 className="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2"><PiggyBank size={20} /> Estatus Financiero</h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <KPICard
                                title="Ingreso Bruto"
                                value={formatCurrency(processed.totalRevenue)}
                                subtext={`${processed.ticketCount} vehículos`}
                                icon={DollarSign}
                                color="blue"
                            />
                            <KPICard
                                title="Nómina"
                                value={formatCurrency(processed.totalLabor)}
                                subtext={`${processed.totalLaborPct.toFixed(1)}% de Ingreso`}
                                icon={Users}
                                color="orange"
                            />
                            <KPICard
                                title="Gastos Operativos"
                                value={formatCurrency(processed.totalOpExpenses)}
                                subtext={`${processed.totalOpExpensesPct.toFixed(1)}% de Ingreso`}
                                icon={ArrowDownRight}
                                color="red"
                            />
                            <KPICard
                                title="Utilidad Neta"
                                value={formatCurrency(processed.netProfit)}
                                subtext={`${processed.profitMarginPct.toFixed(1)}% de Ingreso`}
                                icon={Wallet}
                                color={processed.netProfit > 0 ? "green" : "red"}
                            />
                        </div>

                        {/* SECONDARY METRICS: ARMOR ALL & TICKET AVG */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <KPICard
                                title="Ticket Promedio"
                                value={formatCurrency(processed.avgTicket)}
                                subtext="Ingreso por auto"
                                icon={TrendingUp}
                                color="purple"
                            />
                            <KPICard
                                title="Promedio Autos/Día"
                                value={processed.avgTicketsPerDay.toFixed(1)}
                                subtext="Vehículos diarios"
                                icon={Car}
                                color="cyan"
                            />
                            <KPICard
                                title="ArmorAll / Lavado"
                                value={formatCurrency(processed.armorAllPerWash)}
                                subtext={`Gasto Total: ${formatCurrency(processed.totalArmorAllCost)}`}
                                icon={Droplets}
                                color="indigo"
                            />
                        </div>

                        {/* LABOR BREAKDOWN CARDS */}
                        <div className="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
                            <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl flex flex-col items-center text-center">
                                <div className="text-xs font-bold text-orange-400 uppercase tracking-wide mb-1">Comisión Lavadores</div>
                                <div className="text-2xl font-bold text-orange-700">{processed.laborCommPct.toFixed(1)}%</div>
                                <div className="text-xs text-orange-600">{formatCurrency(processed.laborCommission)}</div>
                            </div>

                            <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl flex flex-col items-center text-center">
                                <div className="text-xs font-bold text-orange-400 uppercase tracking-wide mb-1">Comisión Ventas (Sup)</div>
                                <div className="text-2xl font-bold text-orange-700">{processed.laborSupCommPct.toFixed(1)}%</div>
                                <div className="text-xs text-orange-600">{formatCurrency(processed.supervisorSalesCommTotal)}</div>
                            </div>

                            <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl flex flex-col items-center text-center">
                                <div className="text-xs font-bold text-orange-400 uppercase tracking-wide mb-1">Comisión Bolero</div>
                                <div className="text-2xl font-bold text-orange-700">{processed.laborBoleroCommPct.toFixed(1)}%</div>
                                <div className="text-xs text-orange-600">{formatCurrency(processed.boleroCommTotal)}</div>
                            </div>

                            <div className="bg-orange-50 border border-orange-100 p-4 rounded-xl flex flex-col items-center text-center">
                                <div className="text-xs font-bold text-orange-400 uppercase tracking-wide mb-1">Salarios Base ({processed.salariedCount})</div>
                                <div className="text-2xl font-bold text-orange-700">{processed.laborSalaryPct.toFixed(1)}%</div>
                                <div className="text-xs text-orange-600">{formatCurrency(processed.laborSalary)}</div>
                            </div>

                            <div className="bg-orange-100 border border-orange-200 p-4 rounded-xl flex flex-col items-center text-center">
                                <div className="text-xs font-bold text-orange-500 uppercase tracking-wide mb-1">Total Mano de Obra</div>
                                <div className="text-2xl font-bold text-orange-800">{processed.totalLaborPct.toFixed(1)}%</div>
                                <div className="text-xs text-orange-700">{formatCurrency(processed.totalLabor)}</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {timeRange !== 'MONTH' && (
                                <div className="bg-white p-6 rounded-xl shadow-sm border h-96 lg:col-span-2">
                                    <h3 className="font-bold text-slate-700 mb-4">Rentabilidad Mensual</h3>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={processed.chartFinancials}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                            <XAxis dataKey="name" style={{ fontSize: '12px' }} />
                                            <YAxis style={{ fontSize: '12px' }} tickFormatter={(val) => `$${val / 1000}k`} />
                                            <Tooltip formatter={(val) => formatCurrency(val)} />
                                            <Legend />
                                            <Area type="monotone" dataKey="revenue" fill="#bfdbfe" stroke="#3b82f6" name="Ingresos" />
                                            <Line type="monotone" dataKey="profit" stroke="#16a34a" strokeWidth={3} name="Utilidad Neta" />
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                            )}
                            <div className={`bg-white p-6 rounded-xl shadow-sm border h-96 ${timeRange === 'MONTH' ? 'lg:col-span-3' : ''}`}>
                                <h3 className="font-bold text-slate-700 mb-4">Distribución de Costos</h3>
                                <ResponsiveContainer width="100%" height="90%">
                                    <PieChart>
                                        <Pie
                                            data={processed.chartExpenses}
                                            cx="40%"
                                            cy="50%"
                                            innerRadius={80}
                                            outerRadius={110}
                                            paddingAngle={5}
                                            dataKey="value"
                                        >
                                            {processed.chartExpenses.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                            ))}
                                        </Pie>
                                        <Tooltip formatter={(val) => formatCurrency(val)} />
                                        <Legend style={{ fontSize: '12px' }} layout="vertical" verticalAlign="middle" align="right" />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* TOP 10 GASTOS */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border mt-6">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><ArrowDownRight className="text-red-500" /> Top 10 Gastos Mayores</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 border-b">
                                        <tr>
                                            <th className="p-3">Fecha</th>
                                            <th className="p-3">Descripción</th>
                                            <th className="p-3 text-right">Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {processed.topGastos.length === 0 ? <tr><td colSpan="3" className="p-4 text-center text-slate-400">No hay gastos en este periodo.</td></tr> : processed.topGastos.map((g, idx) => (
                                            <tr key={`${g.id}-${idx}`} className="border-b last:border-0 hover:bg-slate-50">
                                                <td className="p-3 text-slate-600">{g.date.toLocaleDateString()}</td>
                                                <td className="p-3 font-medium text-slate-800">{g.description}</td>
                                                <td className="p-3 text-right font-bold text-red-600">{formatCurrency(g.amount)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* NEW SECTION: DAILY TRENDS */}
                    <div>
                        <h2 className="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2 mt-8"><Activity size={20} /> Tendencias Diarias</h2>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border h-80">
                                <h3 className="font-bold text-slate-700 mb-4">Tickets Diarios</h3>
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={processed.chartDailyTrends}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="dateLabel" style={{ fontSize: '10px' }} />
                                        <YAxis />
                                        <Tooltip />
                                        <Line type="monotone" dataKey="tickets" stroke="#8b5cf6" strokeWidth={2} name="Tickets" />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border h-80">
                                <h3 className="font-bold text-slate-700 mb-4">Venta Diaria</h3>
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={processed.chartDailyTrends}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="dateLabel" style={{ fontSize: '10px' }} />
                                        <YAxis tickFormatter={(val) => `$${val / 1000}k`} />
                                        <Tooltip formatter={(val) => formatCurrency(val)} />
                                        <Line type="monotone" dataKey="venta" stroke="#10b981" strokeWidth={2} name="Venta" />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border h-80">
                                <h3 className="font-bold text-slate-700 mb-4">Pinos Vendidos Diarios</h3>
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={processed.chartDailyTrends}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="dateLabel" style={{ fontSize: '10px' }} />
                                        <YAxis />
                                        <Tooltip />
                                        <Line type="monotone" dataKey="pinos" stroke="#f59e0b" strokeWidth={2} name="Pinos" />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border h-80">
                                <h3 className="font-bold text-slate-700 mb-4">Snacks Vendidos Diarios</h3>
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={processed.chartDailyTrends}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="dateLabel" style={{ fontSize: '10px' }} />
                                        <YAxis />
                                        <Tooltip />
                                        <Line type="monotone" dataKey="snacks" stroke="#f43f5e" strokeWidth={2} name="Snacks" />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* SECTION 3: STAFF & PRODUCT */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border h-96">
                            <h3 className="font-bold text-slate-700 mb-4">Top Empleados (Vehículos Lavados)</h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={processed.chartEmployees} layout="vertical" margin={{ left: 20 }}>
                                    <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
                                    <XAxis type="number" />
                                    <YAxis dataKey="name" type="category" width={150} style={{ fontSize: '11px', fontWeight: 'bold' }} />
                                    <Tooltip />
                                    <Bar dataKey="tickets" fill="#6366f1" radius={[0, 4, 4, 0]} name="Vehículos" barSize={20} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border h-96">
                            <h3 className="font-bold text-slate-700 mb-4">Servicios Más Vendidos</h3>
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={processed.chartServices} margin={{ bottom: 20 }}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" style={{ fontSize: '10px' }} interval={0} angle={-15} textAnchor="end" />
                                    <YAxis />
                                    <Tooltip />
                                    <Bar dataKey="value" fill="#f59e0b" radius={[4, 4, 0, 0]} name="Cantidad" />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<AnalyticsDashboard />);
    </script>
</body>

</html>