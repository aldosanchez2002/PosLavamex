<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavamex POS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map to handle module imports from CDNs -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
</head>

<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { User, DollarSign, Car, CheckCircle, FileText, Settings, Trash2, LogOut, Users, Calculator } from 'lucide-react';

        // --- CONFIGURATION & DATA ---

        const SIZES = [
            { id: 'AUTO', label: 'Auto' },
            { id: 'SUV_CHICA', label: 'SUV Chica' },
            { id: 'PICKUP', label: 'Pick-Up' },
            { id: 'SUV_GDE', label: 'SUV Gde' },
        ];

        const SERVICES = [
            { id: 'GENERAL', label: 'Lavado General' },
            { id: 'WAX', label: 'Lavado + Cera' },
            { id: 'COMPLETE', label: 'Paquete Completo' },
            { id: 'PREMIUM', label: 'Paquete Premium' },
            { id: 'PRESIDENTIAL', label: 'Paquete Presidencial' },
        ];

        const PRICES = {
            GENERAL: { AUTO: 200, SUV_CHICA: 240, PICKUP: 360, SUV_GDE: 360 },
            WAX: { AUTO: 540, SUV_CHICA: 640, PICKUP: 820, SUV_GDE: 820 },
            COMPLETE: { AUTO: 840, SUV_CHICA: 1040, PICKUP: 1160, SUV_GDE: 1640 },
            PREMIUM: { AUTO: 1180, SUV_CHICA: 1440, PICKUP: 1620, SUV_GDE: 2100 },
            PRESIDENTIAL: { AUTO: 1540, SUV_CHICA: 1940, PICKUP: 2320, SUV_GDE: 2320 },
        };

        const COMMISSIONS = {
            GENERAL: { AUTO: 70, SUV_CHICA: 84, PICKUP: 126, SUV_GDE: 126 },
            WAX: { AUTO: 189, SUV_CHICA: 224, PICKUP: 287, SUV_GDE: 287 },
            COMPLETE: { AUTO: 294, SUV_CHICA: 364, PICKUP: 406, SUV_GDE: 574 },
            PREMIUM: { AUTO: 413, SUV_CHICA: 504, PICKUP: 567, SUV_GDE: 735 },
            PRESIDENTIAL: { AUTO: 539, SUV_CHICA: 679, PICKUP: 812, SUV_GDE: 812 },
        };

        function App() {
            const [view, setView] = useState('GREETER');
            const [exchangeRate, setExchangeRate] = useState(20.50);

            const [employees, setEmployees] = useState(['Aldo', 'Pedro', 'Juan', 'Maria']);

            // Load tickets/history from LocalStorage if available, else empty array
            const [tickets, setTickets] = useState(() => {
                const saved = localStorage.getItem('lavamex_tickets');
                return saved ? JSON.parse(saved) : [];
            });
            const [history, setHistory] = useState(() => {
                const saved = localStorage.getItem('lavamex_history');
                return saved ? JSON.parse(saved) : [];
            });

            // Save to LocalStorage on change
            useEffect(() => {
                localStorage.setItem('lavamex_tickets', JSON.stringify(tickets));
            }, [tickets]);

            useEffect(() => {
                localStorage.setItem('lavamex_history', JSON.stringify(history));
            }, [history]);

            // Greeter State
            const [selectedSize, setSelectedSize] = useState(null);
            const [selectedService, setSelectedService] = useState(null);
            const [selectedWasher, setSelectedWasher] = useState(null);

            // Cashier State
            const [activeTicketId, setActiveTicketId] = useState(null);
            const [paymentMxn, setPaymentMxn] = useState('');
            const [paymentUsd, setPaymentUsd] = useState('');

            const createTicket = () => {
                if (!selectedSize || !selectedService || !selectedWasher) return;

                const price = PRICES[selectedService.id][selectedSize.id];
                const commission = COMMISSIONS[selectedService.id][selectedSize.id];

                const newTicket = {
                    id: Date.now().toString().slice(-4),
                    timestamp: new Date(),
                    size: selectedSize,
                    service: selectedService,
                    washer: selectedWasher,
                    price: price,
                    commission: commission,
                    status: 'PENDING'
                };

                setTickets([...tickets, newTicket]);
                setSelectedSize(null);
                setSelectedService(null);
                setSelectedWasher(null);
                alert(`Ticket #${newTicket.id} Creado para ${newTicket.washer}`);
            };

            const processPayment = () => {
                const ticket = tickets.find(t => t.id === activeTicketId);
                if (!ticket) return;

                const mxnVal = parseFloat(paymentMxn) || 0;
                const usdVal = parseFloat(paymentUsd) || 0;
                const usdConverted = usdVal * exchangeRate;
                const totalPaid = mxnVal + usdConverted;
                const change = totalPaid - ticket.price;

                if (change < 0) {
                    alert(`Faltan fondos. Faltan $${Math.abs(change).toFixed(2)} MXN`);
                    return;
                }

                const paidTicket = {
                    ...ticket,
                    status: 'PAID',
                    paidAt: new Date(),
                    paymentDetails: { mxn: mxnVal, usd: usdVal, rate: exchangeRate, total: totalPaid, change: change }
                };

                setHistory([...history, paidTicket]);
                setTickets(tickets.filter(t => t.id !== activeTicketId));
                setActiveTicketId(null);
                setPaymentMxn('');
                setPaymentUsd('');
            };

            const deleteTicket = (id) => {
                if (confirm('¿Eliminar ticket?')) {
                    setTickets(tickets.filter(t => t.id !== id));
                }
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);
            };

            const calculatePayroll = () => {
                const payroll = {};
                employees.forEach(emp => {
                    payroll[emp] = { count: 0, total: 0, details: [] };
                });

                history.forEach(item => {
                    if (payroll[item.washer]) {
                        payroll[item.washer].count += 1;
                        payroll[item.washer].total += item.commission;
                        payroll[item.washer].details.push(item);
                    }
                });
                return payroll;
            };

            const GreeterView = () => (
                <div className="flex flex-col h-full">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 h-full overflow-auto p-4">
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center"><Car className="w-5 h-5 mr-2" /> 1. Tamaño</h3>
                            <div className="space-y-2">
                                {SIZES.map(size => (
                                    <button key={size.id} onClick={() => setSelectedSize(size)} className={`w-full p-4 text-left rounded-lg border-2 transition-all ${selectedSize?.id === size.id ? 'border-blue-600 bg-blue-50 text-blue-700 font-bold' : 'border-gray-200 hover:border-gray-300'}`}>{size.label}</button>
                                ))}
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                            <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center"><FileText className="w-5 h-5 mr-2" /> 2. Servicio</h3>
                            <div className="space-y-2">
                                {SERVICES.map(service => {
                                    const pricePreview = selectedSize ? PRICES[service.id][selectedSize.id] : null;
                                    return (
                                        <button key={service.id} onClick={() => setSelectedService(service)} disabled={!selectedSize} className={`w-full p-4 text-left rounded-lg border-2 transition-all flex justify-between ${!selectedSize ? 'opacity-50 cursor-not-allowed' : selectedService?.id === service.id ? 'border-blue-600 bg-blue-50 text-blue-700 font-bold' : 'border-gray-200 hover:border-gray-300'}`}>
                                            <span>{service.label}</span>
                                            {pricePreview && <span>${pricePreview}</span>}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col">
                            <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center"><User className="w-5 h-5 mr-2" /> 3. Lavador</h3>
                            <div className="grid grid-cols-2 gap-2 mb-6">
                                {employees.map(emp => (
                                    <button key={emp} onClick={() => setSelectedWasher(emp)} className={`p-3 text-center rounded-lg border-2 transition-all ${selectedWasher === emp ? 'border-green-600 bg-green-50 text-green-700 font-bold' : 'border-gray-200 hover:border-gray-300'}`}>{emp}</button>
                                ))}
                            </div>
                            <div className="mt-auto bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-gray-500">Total a Pagar:</span>
                                    <span className="text-2xl font-bold text-gray-800">{selectedSize && selectedService ? formatCurrency(PRICES[selectedService.id][selectedSize.id]) : '$0.00'}</span>
                                </div>
                                <button onClick={createTicket} disabled={!selectedSize || !selectedService || !selectedWasher} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95 ${!selectedSize || !selectedService || !selectedWasher ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}>IMPRIMIR TICKET</button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const CashierView = () => {
                const selectedTicket = tickets.find(t => t.id === activeTicketId);
                return (
                    <div className="flex h-full gap-6 p-4">
                        <div className="w-1/3 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
                            <div className="p-4 border-b bg-gray-50 font-bold text-gray-700">Tickets ({tickets.length})</div>
                            <div className="overflow-auto flex-1 p-2 space-y-2">
                                {tickets.length === 0 && <div className="text-center text-gray-400 mt-10">Vacío</div>}
                                {tickets.map(ticket => (
                                    <div key={ticket.id} onClick={() => setActiveTicketId(ticket.id)} className={`p-3 rounded-lg border cursor-pointer hover:shadow-md transition-all ${activeTicketId === ticket.id ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 bg-white'}`}>
                                        <div className="flex justify-between items-start mb-1"><span className="font-bold text-gray-800">#{ticket.id}</span><span className="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">{ticket.size.label}</span></div>
                                        <div className="text-sm text-gray-600">{ticket.service.label}</div>
                                        <div className="flex justify-between items-center mt-2"><span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Lav: {ticket.washer}</span><span className="font-bold text-blue-600">{formatCurrency(ticket.price)}</span></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 p-8 flex flex-col justify-center items-center">
                            {!selectedTicket ? <div className="text-gray-400 flex flex-col items-center"><LogOut className="w-16 h-16 mb-4 opacity-20" /><p>Selecciona un ticket</p></div> : (
                                <div className="w-full max-w-md">
                                    <div className="text-center mb-8"><h2 className="text-3xl font-bold text-gray-800 mb-1">{formatCurrency(selectedTicket.price)} MXN</h2><p className="text-gray-500">#{selectedTicket.id} • {selectedTicket.washer}</p></div>
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Efectivo MXN</label><input type="number" value={paymentMxn} onChange={e => setPaymentMxn(e.target.value)} className="w-full p-2 border rounded-lg" placeholder="0.00" /></div>
                                        <div><label className="block text-sm font-medium text-gray-700 mb-1">Efectivo USD</label><input type="number" value={paymentUsd} onChange={e => setPaymentUsd(e.target.value)} className="w-full p-2 border rounded-lg" placeholder="0.00" /><div className="text-xs text-right text-gray-500 mt-1">Rate: ${exchangeRate}</div></div>
                                    </div>
                                    <div className="bg-gray-50 p-4 rounded-lg mb-6 text-sm">
                                        <div className="flex justify-between font-bold text-lg"><span>Cambio:</span><span className={((parseFloat(paymentMxn) || 0) + ((parseFloat(paymentUsd) || 0) * exchangeRate) - selectedTicket.price) < 0 ? 'text-red-500' : 'text-green-600'}>{formatCurrency(((parseFloat(paymentMxn) || 0) + ((parseFloat(paymentUsd) || 0) * exchangeRate)) - selectedTicket.price)}</span></div>
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => deleteTicket(selectedTicket.id)} className="p-4 rounded-xl border border-red-200 text-red-500 hover:bg-red-50"><Trash2 className="w-5 h-5" /></button>
                                        <button onClick={processPayment} disabled={((parseFloat(paymentMxn) || 0) + ((parseFloat(paymentUsd) || 0) * exchangeRate)) < selectedTicket.price} className="flex-1 py-4 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 shadow-lg">COBRAR</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const PayrollView = () => {
                const payrollData = calculatePayroll();
                return (
                    <div className="p-8 max-w-5xl mx-auto">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800 flex items-center"><DollarSign className="w-6 h-6 mr-2 text-green-600" /> Reporte de Nómina</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            {Object.keys(payrollData).map(emp => (
                                <div key={emp} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <div className="text-sm text-gray-500 uppercase tracking-wider font-bold mb-1">{emp}</div>
                                    <div className="text-3xl font-bold text-green-700">{formatCurrency(payrollData[emp].total)}</div>
                                    <div className="text-sm text-gray-400 mt-2">{payrollData[emp].count} Autos</div>
                                </div>
                            ))}
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b"><tr><th className="p-4 text-gray-600">ID</th><th className="p-4 text-gray-600">Lavador</th><th className="p-4 text-gray-600">Servicio</th><th className="p-4 text-gray-600 text-right">Comisión</th></tr></thead>
                                <tbody className="divide-y">
                                    {history.map((item, idx) => (
                                        <tr key={idx} className="hover:bg-gray-50"><td className="p-4 text-gray-500">#{item.id}</td><td className="p-4 font-medium">{item.washer}</td><td className="p-4">{item.service.label} <span className="text-xs text-gray-500">({item.size.label})</span></td><td className="p-4 text-right font-bold text-green-700">{formatCurrency(item.commission)}</td></tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const AdminView = () => (
                <div className="p-8 max-w-2xl mx-auto">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6">
                        <h3 className="font-bold text-gray-700 mb-4">Tipo de Cambio</h3>
                        <input type="number" value={exchangeRate} onChange={(e) => setExchangeRate(parseFloat(e.target.value))} className="border rounded-lg p-3 w-32 text-lg" />
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 className="font-bold text-gray-700 mb-4">Empleados</h3>
                        {employees.map(emp => <div key={emp} className="flex justify-between p-3 bg-gray-50 mb-2 rounded-lg"><span>{emp}</span><button onClick={() => setEmployees(employees.filter(e => e !== emp))} className="text-red-500">x</button></div>)}
                        <div className="flex gap-2 mt-4"><input type="text" id="newEmp" placeholder="Nuevo" className="border rounded-lg p-2 flex-1" /><button onClick={() => { const el = document.getElementById('newEmp'); if (el.value) { setEmployees([...employees, el.value]); el.value = ''; } }} className="bg-blue-600 text-white px-4 py-2 rounded-lg">Agregar</button></div>
                    </div>
                </div>
            );

            return (
                <div className="bg-gray-100 h-screen flex flex-col font-sans text-gray-900">
                    <div className="bg-slate-900 text-white p-4 shadow-md flex justify-between items-center z-10">
                        <div className="flex items-center gap-2"><div className="bg-blue-500 p-2 rounded-lg"><Car className="w-6 h-6 text-white" /></div><div><h1 className="font-bold text-xl tracking-tight">LAVAMEX</h1><div className="text-xs text-blue-300">Rate: ${exchangeRate}</div></div></div>
                        <div className="flex bg-slate-800 p-1 rounded-lg">
                            <button onClick={() => setView('GREETER')} className={`px-4 py-2 rounded-md flex items-center gap-2 text-sm font-medium ${view === 'GREETER' ? 'bg-blue-600' : 'text-gray-400'}`}><CheckCircle className="w-4 h-4" /> Entrada</button>
                            <button onClick={() => setView('CASHIER')} className={`px-4 py-2 rounded-md flex items-center gap-2 text-sm font-medium ${view === 'CASHIER' ? 'bg-blue-600' : 'text-gray-400'}`}><Calculator className="w-4 h-4" /> Caja</button>
                            <button onClick={() => setView('PAYROLL')} className={`px-4 py-2 rounded-md flex items-center gap-2 text-sm font-medium ${view === 'PAYROLL' ? 'bg-blue-600' : 'text-gray-400'}`}><Users className="w-4 h-4" /> Nómina</button>
                            <button onClick={() => setView('ADMIN')} className={`px-4 py-2 rounded-md ${view === 'ADMIN' ? 'bg-blue-600' : 'text-gray-400'}`}><Settings className="w-4 h-4" /></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-hidden">
                        {view === 'GREETER' && <GreeterView />}
                        {view === 'CASHIER' && <CashierView />}
                        {view === 'PAYROLL' && <PayrollView />}
                        {view === 'ADMIN' && <AdminView />}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>