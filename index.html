<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lavamex POS</title>

    <!-- UTILITIES: Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- COMPILER: Babel for in-browser JSX transformation (Dev only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- IMPORTS: ES Modules for React and Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        /* Utility to hide scrollbars while maintaining functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ------------------------------------------------------------------
        // SECTION 1: IMPORTS & SETUP
        // ------------------------------------------------------------------
        import React, { useState, useEffect, useContext, createContext } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            User, DollarSign, Car, CheckCircle, FileText, Settings, Trash2,
            LogOut, Users, Calculator, Printer, Wifi, Lock, Archive, Pencil,
            PlusCircle, Coffee, History, ArrowLeft, Save, UserCheck, Activity,
            Database, PlayCircle, AlertTriangle, Upload, Loader2, Calendar, CreditCard,
            TrendingUp, Banknote, TrendingDown, AlertCircle, Check, X, Briefcase
        } from 'lucide-react';

        import { initializeApp, getApps, getApp } from 'firebase/app';
        import {
            getFirestore, collection, addDoc, updateDoc, doc, onSnapshot,
            query, orderBy, serverTimestamp, writeBatch, setDoc, getDocs,
            where, deleteDoc
        } from 'firebase/firestore';

        // ------------------------------------------------------------------
        // SECTION 2: FIREBASE CONFIGURATION
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyByIvJpBZv32Zd22fxlYWL9etzBa66Q2rE",
            authDomain: "poslavamex.firebaseapp.com",
            projectId: "poslavamex",
            storageBucket: "poslavamex.firebasestorage.app",
            messagingSenderId: "883264129",
            appId: "1:883264129:web:39a352e2ade3888b4f1b80"
        };

        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);

        // ------------------------------------------------------------------
        // SECTION 3: CONSTANTS & DEFAULTS
        // ------------------------------------------------------------------
        const SIZES = [
            { id: 'AUTO', label: 'Auto' },
            { id: 'SUV_CHICA', label: 'SUV Chica' },
            { id: 'PICKUP', label: 'Pick-Up / SUV MD' },
            { id: 'SUV_GDE', label: 'SUV Gde' }
        ];

        const SERVICES = [
            { id: 'GENERAL', label: 'Lavado General' },
            { id: 'WAX', label: 'Lavado + Cera' },
            { id: 'COMPLETE', label: 'Paquete Completo' },
            { id: 'PREMIUM', label: 'Paquete Premium' },
            { id: 'PRESIDENTIAL', label: 'Paquete Presidencial' }
        ];

        const DEFAULTS = {
            PINS: {
                GREETER: 'MDAwMA==', // 0000
                CASHIER: 'MTIzNA==', // 1234
                ADMIN: 'OTk5OQ=='    // 9999
            },
            EXCHANGE_RATE: 18.10,
            SNACK_PRICE: 25,
            INITIAL_CASH_MXN: 0,
            INITIAL_CASH_USD: 0,
            INITIAL_EMPLOYEES: [
                { name: 'Aldo', active: true },
                { name: 'Sergio', active: true },
                { name: 'Juan', active: true },
                { name: 'Rodrigo', active: true }
            ],
            PRICES: {
                GENERAL: { AUTO: 200, SUV_CHICA: 240, PICKUP: 360, SUV_GDE: 360 },
                WAX: { AUTO: 540, SUV_CHICA: 640, PICKUP: 820, SUV_GDE: 820 },
                COMPLETE: { AUTO: 840, SUV_CHICA: 1040, PICKUP: 1160, SUV_GDE: 1640 },
                PREMIUM: { AUTO: 1180, SUV_CHICA: 1440, PICKUP: 1620, SUV_GDE: 2100 },
                PRESIDENTIAL: { AUTO: 1540, SUV_CHICA: 1940, PICKUP: 2320, SUV_GDE: 2320 },
            },
            COMMISSIONS: {
                GENERAL: { AUTO: 70, SUV_CHICA: 84, PICKUP: 126, SUV_GDE: 126 },
                WAX: { AUTO: 189, SUV_CHICA: 224, PICKUP: 287, SUV_GDE: 287 },
                COMPLETE: { AUTO: 294, SUV_CHICA: 364, PICKUP: 406, SUV_GDE: 574 },
                PREMIUM: { AUTO: 413, SUV_CHICA: 504, PICKUP: 567, SUV_GDE: 735 },
                PRESIDENTIAL: { AUTO: 539, SUV_CHICA: 679, PICKUP: 812, SUV_GDE: 812 },
            },
            EXTRAS: [
                { id: 'MOTOR', label: 'Lavado Motor', price: 400, commission: 140 },
                { id: 'CHASIS', label: 'Chasis', price: 400, commission: 140 },
                { id: 'AROMA', label: 'Aroma', price: 30, commission: 10.50 },
                { id: 'BOLEADA', label: 'Boleada', price: 60, commission: 30 },
                { id: 'LIMP_ZONA', label: 'Limpieza por Zona', price: 200, commission: 70 },
                { id: 'LIMP_FOCOS', label: 'Limpieza de Focos', price: 340, commission: 120 },
            ]
        };

        // ------------------------------------------------------------------
        // SECTION 4: HELPER FUNCTIONS (Business Logic & DB Wrapper)
        // ------------------------------------------------------------------

        // CENTRALIZED DATABASE LOGIC WRAPPER
        const handleDbAction = async (actionFn) => {
            try {
                await actionFn();
            } catch (e) {
                alert("Error: " + e.message);
                console.error(e);
            }
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        };

        const getLocalDateStr = (d = new Date()) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        };

        const getMonthStr = (d = new Date()) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            return `${y}-${m}`;
        };

        const calculateTicketTotals = (serviceId, sizeId, extraList, prices, commissions, snackCount = 0, currentSnackPrice = 25) => {
            const basePrice = (serviceId && sizeId && prices[serviceId]?.[sizeId]) || 0;
            const baseComm = (serviceId && sizeId && commissions[serviceId]?.[sizeId]) || 0;
            const extrasPrice = extraList.reduce((a, b) => a + b.price, 0);
            const extrasComm = extraList.reduce((a, b) => a + b.commission, 0);
            const snackCost = snackCount * currentSnackPrice;

            return {
                basePrice,
                totalPrice: basePrice + extrasPrice + snackCost,
                totalCommission: baseComm + extrasComm
            };
        };

        const calculatePayroll = (employees, history, deductions, currentCommissions, currentExtras) => {
            const payroll = {};
            employees.forEach(emp => {
                const serviceGrid = {};
                SERVICES.forEach(svc => {
                    serviceGrid[svc.id] = {};
                    SIZES.forEach(sz => serviceGrid[svc.id][sz.id] = 0);
                });
                payroll[emp.name] = {
                    count: 0, total: 0, serviceGrid, extrasData: {},
                    deductionTotal: 0, deductionDetails: [], netPay: 0
                };
            });

            history.forEach(item => {
                const washersList = item.washers || (item.washer ? [item.washer] : []);
                if (washersList.length === 0) return;
                const washerCount = washersList.length;

                let extrasCommissionTotal = 0;
                const extrasShares = (item.extras || []).map(ex => {
                    const dbExtra = currentExtras ? currentExtras.find(dbEx => dbEx.id === ex.id) : null;
                    const commissionValue = dbExtra ? (dbExtra.commission || 0) : (ex.commission || 0);
                    const share = commissionValue / washerCount;
                    extrasCommissionTotal += commissionValue;
                    return { label: ex.label, share };
                });

                let baseCommissionTotal = 0;
                if (item.service && item.size && currentCommissions && currentCommissions[item.service.id]) {
                    baseCommissionTotal = currentCommissions[item.service.id][item.size.id] || 0;
                } else {
                    const totalStoredCommission = item.commission || 0;
                    const storedExtrasTotal = (item.extras || []).reduce((acc, e) => acc + (e.commission || 0), 0);
                    baseCommissionTotal = Math.max(0, totalStoredCommission - storedExtrasTotal);
                }
                const baseShare = baseCommissionTotal / washerCount;

                washersList.forEach(washerName => {
                    if (!payroll[washerName]) return;
                    const p = payroll[washerName];
                    p.count += 1;
                    p.total += (baseShare + (extrasCommissionTotal / washerCount));
                    if (item.service && item.size) {
                        p.serviceGrid[item.service.id][item.size.id] = (p.serviceGrid[item.service.id][item.size.id] || 0) + 1;
                    }
                    extrasShares.forEach(ex => {
                        if (!p.extrasData[ex.label]) p.extrasData[ex.label] = { count: 0, total: 0 };
                        p.extrasData[ex.label].count += 1;
                        p.extrasData[ex.label].total += ex.share;
                    });
                });
            });

            deductions.forEach(d => {
                if (payroll[d.employee]) {
                    payroll[d.employee].deductionTotal += d.amount;
                    payroll[d.employee].deductionDetails.push({ date: d.timestamp, desc: d.description, amount: d.amount });
                }
            });

            Object.keys(payroll).forEach(key => { payroll[key].netPay = payroll[key].total - payroll[key].deductionTotal; });
            return payroll;
        };

        const validatePin = (input) => {
            try {
                const encoded = btoa(input);
                if (encoded === DEFAULTS.PINS.GREETER) return 'GREETER';
                if (encoded === DEFAULTS.PINS.CASHIER) return 'CASHIER';
                if (encoded === DEFAULTS.PINS.ADMIN) return 'ADMIN';
            } catch (e) { return null; }
            return null;
        };

        const calculateChange = (mxn, usd, rate, totalCost) => {
            const mxnVal = parseFloat(mxn) || 0;
            const usdVal = parseFloat(usd) || 0;
            const totalGiven = mxnVal + (usdVal * rate);
            return totalGiven - totalCost;
        };

        const toggleSelection = (list, item, limit = null) => {
            const isObj = typeof item !== 'string';
            const exists = isObj ? list.some(x => x.id === item.id) : list.includes(item);
            if (!exists && limit && list.length >= limit) return list;
            return exists ? list.filter(x => isObj ? x.id !== item.id : x !== item) : [...list, item];
        };

        // ------------------------------------------------------------------
        // SECTION 5: PRINTING SERVICE (WEB SHARE API)
        // ------------------------------------------------------------------
        const PrintService = {
            print: async (content) => {
                // 1. Format content exactly as the App requires
                const str = "<HTML>" + content;

                // 2. Use the System Share Menu (Equivalent to Intent.ACTION_SEND)
                if (navigator.share) {
                    try {
                        await navigator.share({
                            text: str
                        });
                    } catch (err) {
                        // User cancelled share or error
                        console.error("Share failed:", err);
                    }
                } else {
                    // Fallback for desktops or unsupported browsers
                    alert("Tu navegador no soporta compartir. Copia el texto manualmente.");
                    console.log(str);
                }
            },

            // SHARED HEADER FOR RECEIPT AND TICKET
            // Includes styling for tight spacing (line-height)
            getReceiptHeader: () => `
                <div style="text-align:center; font-weight:bold; font-size: 14px; line-height: 1.2;">
                    <div>CARWASH LAVAMEX</div>
                    <div>WATERFILL 216 CP 32553</div>
                    <div>CD. JUAREZ CHIH.</div>
                    <div>RFC. CACN760904AN7</div>
                </div>
                <div style="text-align:center; margin: 4px 0; line-height: 1;">--------------------------------</div>
            `,

            // SPANISH DATE FORMAT
            getFormattedDate: () => {
                return new Intl.DateTimeFormat('es-MX', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                }).format(new Date());
            },

            getJobTicketHtml: (ticket, shortId) => {
                const washers = ticket.washers ? ticket.washers.join(', ') : ticket.washer;
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? ticket.extras.map(e => `<div>+ ${e.label}</div>`).join('')
                    : '';

                // Using specific line-height and margin:0 to reduce paper waste
                return `
            <div style="font-family: monospace; line-height: 1.1; color: #000;">
                ${PrintService.getReceiptHeader()}
                <div style="font-size:18px; margin: 2px 0;"><b>TICKET: #${shortId}</b></div>
                <div style="font-size:18px; margin: 2px 0;">${washers}</div>
                <div style="font-size:16px; margin: 2px 0;">${ticket.size ? ticket.size.label : ''}</div>
                <div style="font-size:16px; margin: 2px 0;">${ticket.service ? ticket.service.label : 'Extras Only'}</div>
                <div style="margin: 2px 0;">${extrasHtml}</div>
                ${ticket.vehicleDesc ? `<div style="margin: 2px 0;">(${ticket.vehicleDesc})</div>` : ''}
                <div style="text-align:center; margin: 5px 0;">--------------------------------</div>
            </div>
        `;
            },

            getReceiptHtml: (ticket, payment, shortId, currentSnackPrice) => {
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? ticket.extras.map(e => `<div style="margin: 1px 0;">+ ${e.label} $${e.price}</div>`).join('')
                    : '';

                const displayBasePrice = ticket.basePrice || 0;
                const method = payment.method === 'CARD' ? 'TARJETA' : 'EFECTIVO';
                const effSnackPrice = currentSnackPrice || 25;

                const carAscii = `
  ______
 /|_||_\\\`.__
(   _    _ _\\
=\`-(_)--(_)-'  hjw
`;

                // Using specific line-height and margin:0 to reduce paper waste
                return `
            <div style="font-family: monospace; line-height: 1.1; color: #000;">
                ${PrintService.getReceiptHeader()}
                <div style="margin: 1px 0;">Ticket: #${shortId}</div>
                <div style="margin: 1px 0;">Fecha: ${PrintService.getFormattedDate()}</div>
                <div style="margin: 1px 0;">Metodo: ${method}</div>
                <div style="text-align:center; margin: 4px 0; line-height: 1;">--------------------------------</div>
                <div style="font-weight:bold; margin: 1px 0;">${ticket.service ? ticket.service.label : 'General'} $${displayBasePrice}</div>
                ${extrasHtml}
                ${ticket.snackCount > 0 ? `<div style="margin: 1px 0;">+ Snacks (${ticket.snackCount}) $${ticket.snackCount * effSnackPrice}</div>` : ''}
                <div style="text-align:center; margin: 4px 0; line-height: 1;">--------------------------------</div>
                <div style="font-size:18px; font-weight:bold; margin: 4px 0;">TOTAL: $${ticket.price}</div>
                ${payment.method === 'CASH' ? `<div style="margin: 1px 0;">Recibido: $${(payment.mxn + (payment.usd * payment.rate)).toFixed(2)}</div><div style="margin: 1px 0;">Cambio: $${payment.change.toFixed(2)}</div>` : ''}
                <div style="text-align:center; margin-top:8px; margin-bottom: 2px;">Gracias por su preferencia</div>
                <div style="font-family: monospace; white-space: pre; text-align: center; line-height: 10px; font-size: 10px; overflow: hidden; font-weight: bold;">${carAscii}</div>
            </div>
        `;
            },

            getCorteHtml: (data) => {
                return `
            <div style="font-family: monospace; line-height: 1.1; color: #000;">
                ${PrintService.getReceiptHeader()}
                <div style="font-size:16px; font-weight:bold; text-align:center; margin: 2px 0;">CORTE ${data.type}</div>
                <div style="text-align:center; margin: 2px 0;">${data.dateLabel}</div>
                <div style="text-align:center; margin: 4px 0; line-height: 1;">--------------------------------</div>
                <div style="margin: 2px 0;"><b>Ventas: $${data.totals.total}</b></div>
                <div style="margin: 2px 0;">Tickets: ${data.tickets.length}</div>
                <br>
                <div style="margin: 2px 0;"><b>Efectivo: $${data.totals.cashTotal}</b></div>
                <div style="margin: 2px 0;">(USD Caja: $${data.totals.cashUsd.toFixed(2)})</div>
                <div style="margin: 2px 0;">(MXN Calc: $${data.totals.cashMxn.toFixed(2)})</div>
                <div style="margin: 2px 0;"><b>Tarjeta: $${data.totals.card}</b></div>
                <div style="text-align:center; margin: 4px 0; line-height: 1;">--------------------------------</div>
                <div style="margin: 2px 0;"><b>NETO EN CAJA:</b></div>
                <div style="margin: 2px 0;">MXN: $${data.totals.cashNetMxn.toFixed(2)}</div>
                <div style="margin: 2px 0;">USD: $${data.totals.cashNetUsd.toFixed(2)}</div>
                <div style="text-align:center; margin: 4px 0; line-height: 1;">--------------------------------</div>
                ${data.totals.expenses > 0 ? `<div style="margin: 2px 0;">Gastos: -$${data.totals.expenses}</div>` : ''}
            </div>
        `;
            }
        };

        // ------------------------------------------------------------------
        // SECTION 7: CONTEXT & PROVIDER
        // ------------------------------------------------------------------
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [role, setRole] = useState(() => localStorage.getItem('lavamex_role') || null);
            const [view, setView] = useState('GREETER');
            const [employees, setEmployees] = useState([]);
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [deductions, setDeductions] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [editingTicket, setEditingTicket] = useState(null);

            // Global settings
            const [exRate, setExRate] = useState(DEFAULTS.EXCHANGE_RATE);
            const [snackPrice, setSnackPrice] = useState(DEFAULTS.SNACK_PRICE);
            const [initialCash, setInitialCash] = useState({ mxn: 0, usd: 0 });
            const [prices, setPrices] = useState({});
            const [commissions, setCommissions] = useState({});
            const [extrasList, setExtrasList] = useState([]);

            // UI State
            const [payment, setPayment] = useState({ mxn: '', usd: '' });
            const [activeId, setActiveId] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Auth Logic
            const login = (r) => {
                setRole(r);
                localStorage.setItem('lavamex_role', r);
                if (r) setView(r === 'ADMIN' ? 'ADMIN' : (r === 'CASHIER' ? 'CASHIER' : 'GREETER'));
            };

            const logout = () => {
                setRole(null);
                localStorage.removeItem('lavamex_role');
                setView('GREETER');
            };

            // --- FIREBASE LISTENERS ---
            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, "employees"), orderBy("name")), (snap) => {
                    if (snap.empty && employees.length === 0) {
                        DEFAULTS.INITIAL_EMPLOYEES.forEach(e => addDoc(collection(db, "employees"), e));
                    }
                    setEmployees(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                const unsubP = onSnapshot(doc(db, "settings", "prices"), (docSnap) => {
                    if (docSnap.exists()) setPrices(docSnap.data());
                    else setDoc(doc(db, "settings", "prices"), DEFAULTS.PRICES);
                });
                const unsubC = onSnapshot(doc(db, "settings", "commissions"), (docSnap) => {
                    if (docSnap.exists()) setCommissions(docSnap.data());
                    else setDoc(doc(db, "settings", "commissions"), DEFAULTS.COMMISSIONS);
                });
                const unsubE = onSnapshot(collection(db, "extras"), (snap) => {
                    const dbItems = snap.docs.map(d => ({ ...d.data(), docId: d.id }));
                    const cleanList = DEFAULTS.EXTRAS.map(def => {
                        const match = dbItems.find(item => item.id === def.id);
                        return match ? { ...def, ...match } : def;
                    });
                    setExtrasList(cleanList);
                    if (snap.empty) DEFAULTS.EXTRAS.forEach(e => addDoc(collection(db, "extras"), e));
                });
                const unsubG = onSnapshot(doc(db, "settings", "general"), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.exchangeRate) setExRate(data.exchangeRate);
                        if (data.snackPrice) setSnackPrice(data.snackPrice);
                        setInitialCash({ mxn: data.initialCashMxn || 0, usd: data.initialCashUsd || 0 });
                    } else {
                        setDoc(doc(db, "settings", "general"), {
                            exchangeRate: DEFAULTS.EXCHANGE_RATE,
                            snackPrice: DEFAULTS.SNACK_PRICE,
                            initialCashMxn: DEFAULTS.INITIAL_CASH_MXN,
                            initialCashUsd: DEFAULTS.INITIAL_CASH_USD
                        });
                    }
                });
                return () => { unsubP(); unsubC(); unsubE(); unsubG(); };
            }, []);

            useEffect(() => {
                const qT = query(collection(db, "tickets"), orderBy("timestamp", "desc"));
                const unsubT = onSnapshot(qT, (snap) => {
                    const active = [], hist = [];
                    snap.forEach(d => {
                        const dat = {
                            id: d.id, ...d.data(),
                            timestamp: d.data().timestamp?.toDate() || new Date(),
                            paidAt: d.data().paidAt?.toDate() || null
                        };
                        if (dat.status === 'PENDING') active.push(dat);
                        else hist.push(dat);
                    });
                    setTickets(active);
                    setHistory(hist);
                });
                const unsubD = onSnapshot(collection(db, "deductions"), (snap) => {
                    setDeductions(snap.docs.map(d => {
                        const data = d.data();
                        return {
                            id: d.id, ...data,
                            timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : (data.timestamp || new Date())
                        };
                    }));
                });
                const qE = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
                const unsubE = onSnapshot(qE, (snap) => {
                    setExpenses(snap.docs.map(d => ({
                        id: d.id, ...d.data(),
                        timestamp: d.data().timestamp?.toDate() || new Date()
                    })));
                });
                return () => { unsubT(); unsubD(); unsubE(); };
            }, []);

            // --- ACTIONS (USING HANDLEDBACTION) ---
            const updateGlobalSettings = (newRate, newSnackPrice, initMxn, initUsd) => handleDbAction(async () => {
                await setDoc(doc(db, "settings", "general"), {
                    exchangeRate: newRate, snackPrice: newSnackPrice, initialCashMxn: initMxn, initialCashUsd: initUsd
                }, { merge: true });
            });

            const saveTicket = (data) => handleDbAction(async () => {
                if (isSubmitting) return;
                setIsSubmitting(true);
                try {
                    const snacks = editingTicket ? (editingTicket.snackCount || 0) : 0;
                    const serviceId = data.service ? data.service.id : null;
                    const sizeId = data.size ? data.size.id : null;
                    const totals = calculateTicketTotals(serviceId, sizeId, data.extras, prices, commissions, snacks, snackPrice);
                    const ticketData = {
                        ...data, price: totals.totalPrice, commission: totals.totalCommission, basePrice: totals.basePrice,
                        snackCount: snacks, status: 'PENDING', timestamp: serverTimestamp()
                    };

                    if (editingTicket) {
                        await updateDoc(doc(db, "tickets", editingTicket.id), ticketData);
                        setEditingTicket(null);
                        if (role === 'CASHIER') setView('CASHIER');
                    } else {
                        const ref = await addDoc(collection(db, "tickets"), ticketData);
                        const html = PrintService.getJobTicketHtml({ ...ticketData, timestamp: new Date() }, ref.id.slice(-4).toUpperCase());
                        PrintService.print(html);
                    }
                } finally { setIsSubmitting(false); }
            });

            const updateSnacks = (id, count) => handleDbAction(async () => {
                const t = tickets.find(x => x.id === id); if (!t) return;
                const newCount = Math.max(0, count);
                const totals = calculateTicketTotals(t.service.id, t.size.id, t.extras || [], prices, commissions, newCount, snackPrice);
                await updateDoc(doc(db, "tickets", id), { snackCount: newCount, price: totals.totalPrice });
            });

            const toggleAttendance = (empId, empName, isActive) => handleDbAction(async () => {
                await updateDoc(doc(db, "employees", empId), { active: isActive });
                const dateKey = getLocalDateStr();
                const monthKey = dateKey.slice(0, 7);
                await setDoc(doc(db, "attendance", dateKey), {
                    date: dateKey, month: monthKey, records: { [empName]: isActive }
                }, { merge: true });
            });

            const addEmployee = (name) => handleDbAction(() => addDoc(collection(db, "employees"), { name, active: true }));

            const deleteTicket = (id) => handleDbAction(async () => {
                if (confirm("¿Seguro que deseas borrar este ticket?")) {
                    await updateDoc(doc(db, "tickets", id), { status: 'CANCELLED' });
                }
            });

            const addDebt = (e, c) => handleDbAction(() => addDoc(collection(db, "deductions"), {
                employee: e, amount: c * snackPrice, status: 'PENDING', timestamp: serverTimestamp()
            }));

            const addExpense = (desc, amount) => handleDbAction(async () => {
                await addDoc(collection(db, "expenses"), {
                    description: desc, amount: parseFloat(amount), status: 'PENDING', createdBy: role, timestamp: serverTimestamp()
                });
                alert("Gasto registrado, pendiente de aprobación.");
            });

            const updateExpense = (id, data) => handleDbAction(() => updateDoc(doc(db, "expenses", id), data));

            const resolveExpense = (id, status) => handleDbAction(() => updateDoc(doc(db, "expenses", id), {
                status: status, processedAt: serverTimestamp(), processedBy: role
            }));

            const processPayment = () => handleDbAction(async () => {
                if (isSubmitting) return;
                const t = tickets.find(x => x.id === activeId); if (!t) return;
                const total = (parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate);
                if (total < t.price) return alert("Falta dinero");

                setIsSubmitting(true);
                try {
                    const details = { mxn: parseFloat(payment.mxn) || 0, usd: parseFloat(payment.usd) || 0, rate: exRate, change: total - t.price, method: 'CASH' };
                    await updateDoc(doc(db, "tickets", t.id), { status: 'PAID', paidAt: serverTimestamp(), paymentDetails: details });

                    const html = PrintService.getReceiptHtml(t, details, t.id.slice(-4).toUpperCase(), snackPrice);
                    PrintService.print(html);

                    setActiveId(null); setPayment({ mxn: '', usd: '' });
                } finally { setIsSubmitting(false); }
            });

            const processCardPayment = () => handleDbAction(async () => {
                if (isSubmitting) return;
                const t = tickets.find(x => x.id === activeId); if (!t) return;
                setIsSubmitting(true);
                try {
                    const details = { mxn: t.price, usd: 0, rate: exRate, change: 0, method: 'CARD' };
                    await updateDoc(doc(db, "tickets", t.id), { status: 'PAID', paidAt: serverTimestamp(), paymentDetails: details });

                    const html = PrintService.getReceiptHtml(t, details, t.id.slice(-4).toUpperCase(), snackPrice);
                    PrintService.print(html);

                    setActiveId(null); setPayment({ mxn: '', usd: '' });
                } finally { setIsSubmitting(false); }
            });

            const startEdit = (ticket) => { setEditingTicket(ticket); setView('GREETER'); };
            const cancelEdit = () => { setEditingTicket(null); if (role === 'CASHIER') setView('CASHIER'); };

            const value = {
                role, login, logout, view, setView, employees, tickets, history, deductions, expenses,
                prices, commissions, extrasList, exRate, snackPrice, initialCash, updateGlobalSettings,
                editingTicket, startEdit, cancelEdit, activeId, setActiveId, payment, setPayment,
                saveTicket, updateSnacks, toggleAttendance, addEmployee, deleteTicket, addDebt,
                addExpense, updateExpense, resolveExpense, processPayment, processCardPayment,
                db, isSubmitting
            };

            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };

        // ------------------------------------------------------------------
        // SECTION 8: COMPONENTS (Refactored)
        // ------------------------------------------------------------------

        // REUSABLE COMPONENTS
        const Button = ({ onClick, children, variant = 'primary', className = '', ...props }) => {
            const base = "p-3 rounded-xl font-bold transition-transform active:scale-95 shadow-sm flex items-center justify-center gap-2";
            const styles = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-gray-300",
                danger: "bg-red-100 text-red-700 border border-red-200 hover:bg-red-200",
                secondary: "bg-white border border-gray-200 text-gray-600 hover:bg-gray-50",
                success: "bg-green-600 text-white hover:bg-green-700",
                warning: "bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200",
                ghost: "bg-transparent text-gray-500 hover:bg-gray-100",
                blueLight: "bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200",
                orangeLight: "bg-orange-100 text-orange-700 border border-orange-200 hover:bg-orange-200"
            };
            const variantStyle = styles[variant] || styles.primary;
            return <button onClick={onClick} className={`${base} ${variantStyle} ${className}`} {...props}>{children}</button>;
        };

        const Modal = ({ title, onClose, children, icon: Icon, footer }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                    <h3 className="font-bold mb-4 text-lg text-gray-800 flex items-center">
                        {Icon && <Icon className="mr-2" />} {title}
                    </h3>
                    <div className="mb-6">{children}</div>
                    {footer ? footer : (
                        <Button onClick={onClose} variant="secondary" className="w-full">Cerrar</Button>
                    )}
                </div>
            </div>
        );

        const LoginScreen = () => {
            const { login } = useContext(AppContext);
            const [pin, setPin] = useState('');
            const handleLogin = () => {
                const role = validatePin(pin);
                if (role) login(role); else { alert('PIN Incorrecto'); setPin(''); }
            };
            return (
                <div className="flex h-screen bg-gray-900 justify-center items-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                        <h1 className="text-3xl font-bold mb-6 text-gray-800">LAVAMEX POS</h1>
                        <div className="flex flex-col gap-4">
                            <input type="password" inputMode="numeric" value={pin} onChange={e => setPin(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} placeholder="PIN" className="w-full p-4 border rounded-lg text-center text-3xl tracking-widest mb-2" autoFocus />
                            <Button onClick={handleLogin} className="w-full p-4 text-lg">ENTRAR</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const GreeterView = () => {
            const { employees, saveTicket, editingTicket, cancelEdit, prices, extrasList, isSubmitting } = useContext(AppContext);
            const [size, setSize] = useState(null);
            const [service, setService] = useState(null);
            const [washers, setWashers] = useState([]);
            const [extras, setExtras] = useState([]);
            const [desc, setDesc] = useState('');
            const [vDesc, setVDesc] = useState('');
            const [vPrice, setVPrice] = useState('');

            useEffect(() => {
                if (editingTicket) {
                    setSize(editingTicket.size); setService(editingTicket.service); setWashers(editingTicket.washers || []); setExtras(editingTicket.extras || []); setDesc(editingTicket.vehicleDesc || '');
                } else {
                    setSize(null); setService(null); setWashers([]); setExtras([]); setDesc('');
                }
            }, [editingTicket]);

            const toggle = (item) => setWashers(prev => toggleSelection(prev, item, 2));
            const toggleExtra = (item) => setExtras(prev => toggleSelection(prev, item));
            const addExtra = (item) => setExtras(prev => [...prev, item]);
            const removeExtra = (item) => setExtras(prev => { const idx = prev.findIndex(x => x.id === item.id); if (idx === -1) return prev; const newArr = [...prev]; newArr.splice(idx, 1); return newArr; });
            const addVarios = () => { const price = parseFloat(vPrice); if (!vDesc || !price || price <= 0) return alert("Error."); setExtras(prev => [...prev, { id: `VARIOS-${Date.now()}`, label: vDesc, price, commission: 0 }]); setVDesc(''); setVPrice(''); };
            const canSubmit = washers.length > 0 && ((size && service) || extras.some(e => e.id === 'BOLEADA' || e.id.startsWith('VARIOS')));
            const handleSubmit = () => { if (!canSubmit) return; saveTicket({ size, service, washers, extras, desc }); if (!editingTicket) { setSize(null); setService(null); setWashers([]); setExtras([]); setDesc(''); } };

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    {editingTicket && (
                        <div className="bg-yellow-200 p-3 text-center font-bold text-yellow-900 flex justify-between items-center px-4 shadow-sm z-10 shrink-0">
                            <span className="flex items-center gap-2 text-sm"><Pencil className="w-4 h-4" /> EDITANDO #{editingTicket.id.slice(-4).toUpperCase()}</span>
                            <Button onClick={cancelEdit} variant="secondary" className="text-xs py-1 h-8">Cancelar</Button>
                        </div>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 flex-1 overflow-y-auto">
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><Car className="w-5 h-5 mr-2" /> 1. Tamaño</h3>
                            <div className="space-y-2">{SIZES.map(s => <button key={s.id} onClick={() => setSize(s)} className={`w-full p-4 text-left rounded-lg border-2 transition-all ${size?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 hover:bg-gray-50'}`}>{s.label}</button>)}</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><FileText className="w-5 h-5 mr-2" /> 2. Servicio</h3>
                            <div className="space-y-2 mb-4">
                                {SERVICES.map(s => {
                                    const price = size && prices[s.id] ? prices[s.id][size.id] : null;
                                    return <button key={s.id} disabled={!size} onClick={() => setService(s)} className={`w-full p-3 text-left rounded-lg border-2 flex justify-between items-center transition-all ${service?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 opacity-90 hover:bg-gray-50'}`}><span>{s.label}</span>{price !== null && <span className="bg-white px-2 py-1 rounded text-sm shadow-sm border">${price}</span>}</button>;
                                })}
                            </div>
                            <h3 className="font-bold mb-2 text-gray-700 text-sm">Extras</h3>
                            <div className="grid grid-cols-1 gap-2">
                                {extrasList.map(e => {
                                    const count = extras.filter(x => x.id === e.id).length;
                                    if (e.id === 'BOLEADA') {
                                        return (
                                            <div key={e.id} className={`w-full p-2 rounded-lg border text-sm flex justify-between items-center transition-all ${count > 0 ? 'bg-indigo-50 border-indigo-600 font-bold text-indigo-800' : 'border-gray-200 hover:bg-gray-50'}`}>
                                                <span className="flex-1">{e.label} (+${e.price})</span>
                                                <div className="flex items-center gap-2"><button onClick={() => removeExtra(e)} disabled={count === 0} className="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded-full font-bold">-</button><span className="w-6 text-center font-bold">{count}</span><button onClick={() => addExtra(e)} className="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded-full font-bold">+</button></div>
                                            </div>
                                        );
                                    }
                                    return <button key={e.id} onClick={() => toggleExtra(e)} className={`w-full p-3 rounded-lg border text-sm flex justify-between items-center transition-all ${extras.some(x => x.id === e.id) ? 'bg-indigo-50 border-indigo-600 font-bold text-indigo-800' : 'border-gray-200 hover:bg-gray-50'}`}><span>{e.label}</span><span>+${e.price}</span></button>;
                                })}
                            </div>
                            <div className="mt-4 border-t pt-2">
                                <h3 className="font-bold mb-2 text-gray-700 text-sm">Varios (Costo Extra)</h3>
                                <div className="flex gap-2 mb-2"><input value={vDesc} onChange={e => setVDesc(e.target.value)} placeholder="Motivo" className="w-full p-2 border rounded text-sm" /><input type="number" value={vPrice} onChange={e => setVPrice(e.target.value)} placeholder="$" className="w-20 p-2 border rounded text-sm" /><Button onClick={addVarios} className="py-2 px-3"><PlusCircle size={16} /></Button></div>
                                {extras.filter(e => e.id.startsWith('VARIOS')).map(e => (
                                    <div key={e.id} className="flex justify-between items-center text-sm p-2 bg-gray-50 border rounded mb-1"><span>{e.label}</span><div className="flex items-center gap-2"><span className="font-bold">${e.price}</span><button onClick={() => setExtras(prev => prev.filter(x => x.id !== e.id))} className="text-red-500"><Trash2 size={14} /></button></div></div>
                                ))}
                            </div>
                        </div>
                        <div className="md:col-span-2 bg-white p-4 rounded-xl shadow border flex flex-col h-full">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><User className="w-5 h-5 mr-2" /> 3. Lavadores ({washers.length}/2)</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4 flex-1 content-start">
                                {employees.filter(e => e.active).map(e => <button key={e.name} onClick={() => toggle(e.name)} className={`p-4 rounded-lg border-2 text-center font-medium transition-all ${washers.includes(e.name) ? 'bg-green-100 border-green-600 text-green-800 shadow-inner' : 'border-gray-200 hover:bg-gray-50'}`}>{e.name}</button>)}
                            </div>
                            <div className="mt-auto pt-4 border-t">
                                <input
                                    value={desc}
                                    onChange={e => setDesc(e.target.value)}
                                    placeholder="DESCRIPCIÓN"
                                    className="w-full p-4 border-4 border-blue-600 rounded-xl mb-4 text-xl font-bold bg-blue-50 text-blue-900 placeholder-blue-400 focus:bg-white transition-colors text-center"
                                />
                                <Button onClick={handleSubmit} disabled={!canSubmit || isSubmitting} className={`w-full py-5 text-xl shadow-lg ${!canSubmit ? 'bg-gray-300' : ''}`}>
                                    {isSubmitting ? <Loader2 className="animate-spin" /> : (editingTicket ? <><Save className="w-6 h-6" /> GUARDAR</> : <><Printer className="w-6 h-6" /> CREAR ORDEN</>)}
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CashierView = () => {
            const { tickets, activeId, setActiveId, payment, setPayment, processPayment, processCardPayment, deleteTicket, startEdit, updateSnacks, addDebt, addExpense, employees, exRate, toggleAttendance, isSubmitting, role, snackPrice } = useContext(AppContext);
            const t = tickets.find(x => x.id === activeId);
            const [showSnack, setShowSnack] = useState(false);
            const [showAttendance, setShowAttendance] = useState(false);
            const [showExpense, setShowExpense] = useState(false);
            const [snackEmp, setSnackEmp] = useState('');
            const [expDesc, setExpDesc] = useState('');
            const [expAmt, setExpAmt] = useState('');

            const handleAddExpense = () => { if (!expDesc || !expAmt) return; addExpense(expDesc, expAmt); setExpDesc(''); setExpAmt(''); setShowExpense(false); };

            return (
                <div className="flex flex-col md:flex-row h-full gap-4 p-4 overflow-hidden">
                    <div className="w-full md:w-1/3 bg-white rounded-xl shadow border overflow-hidden flex flex-col h-1/3 md:h-full shrink-0">
                        <div className="p-3 bg-gray-50 font-bold border-b flex justify-between items-center shrink-0">
                            <span className="text-gray-700">Tickets ({tickets.length})</span>
                            <div className="flex gap-1">
                                <Button onClick={() => setShowAttendance(true)} variant="blueLight" className="text-xs px-3 py-1 h-auto rounded-full">Asistencia</Button>
                                <Button onClick={() => setShowSnack(true)} variant="orangeLight" className="text-xs px-3 py-1 h-auto rounded-full">Snack</Button>
                                <Button onClick={() => setShowExpense(true)} variant="danger" className="text-xs px-3 py-1 h-auto rounded-full">Gasto</Button>
                            </div>
                        </div>
                        <div className="overflow-y-auto flex-1 p-2 space-y-2">
                            {tickets.map(ticket => (
                                <div key={ticket.id} onClick={() => setActiveId(ticket.id)} className={`p-4 rounded-lg border cursor-pointer transition-all ${activeId === ticket.id ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50'}`}>
                                    <div className="flex justify-between font-bold text-gray-800"><span>#{ticket.id.slice(-4).toUpperCase()}</span><span>{formatCurrency(ticket.price)}</span></div>
                                    <div className="text-sm text-gray-600 mt-1">{ticket.service?.label || 'Extras'} <span className="bg-gray-200 px-1.5 rounded text-xs">{ticket.size?.label || '-'}</span></div>
                                    {ticket.vehicleDesc && <div className="text-xs text-blue-600 italic mt-1">{ticket.vehicleDesc}</div>}
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex-1 bg-white rounded-xl shadow border p-4 md:p-6 flex flex-col items-center justify-center h-2/3 md:h-full overflow-y-auto">
                        {t ? (
                            <div className="w-full max-w-md">
                                <h2 className="text-4xl font-bold text-center mb-2 text-gray-800">{formatCurrency(t.price)}</h2>
                                <p className="text-center text-gray-500 mb-6 font-medium">{t.vehicleDesc} • {t.washers?.join(', ')}</p>
                                <div className="flex justify-center items-center gap-3 mb-6 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                    <span className="font-bold text-sm text-orange-800 uppercase tracking-wide">Snacks Cliente</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) - 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl text-gray-600">-</button>
                                    <span className="font-bold text-xl w-8 text-center">{t.snackCount || 0}</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) + 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl text-green-600">+</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div><label className="text-xs font-bold text-gray-500 mb-1 block">MXN</label><input type="number" inputMode="decimal" value={payment.mxn} onChange={e => setPayment({ ...payment, mxn: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" /></div>
                                    <div><label className="text-xs font-bold text-gray-500 mb-1 block">USD (Rate: {exRate})</label><input type="number" inputMode="decimal" value={payment.usd} onChange={e => setPayment({ ...payment, usd: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" /></div>
                                </div>
                                <div className="text-center font-bold mb-6 text-xl bg-gray-50 p-3 rounded-lg border">
                                    Cambio: <span className={calculateChange(payment.mxn, payment.usd, exRate, t.price) < 0 ? 'text-red-500' : 'text-green-600'}>{formatCurrency(calculateChange(payment.mxn, payment.usd, exRate, t.price))}</span>
                                </div>
                                <div className="flex gap-3">
                                    <Button onClick={() => deleteTicket(t.id)} variant="danger" title="Borrar"><Trash2 className="w-6 h-6" /></Button>
                                    <Button onClick={() => startEdit(t)} variant="warning" title="Editar"><Pencil className="w-6 h-6" /></Button>
                                    <Button onClick={processPayment} disabled={isSubmitting} variant="success" className="flex-1 shadow-lg">{isSubmitting ? <Loader2 className="animate-spin" /> : <><Printer className="w-6 h-6" /> COBRAR</>}</Button>
                                    {role === 'CASHIER' && <Button onClick={processCardPayment} disabled={isSubmitting} title="Tarjeta"><CreditCard className="w-6 h-6" /></Button>}
                                </div>
                            </div>
                        ) : <div className="text-gray-400 flex flex-col items-center"><LogOut className="w-16 h-16 opacity-20 mb-2" />Selecciona un ticket</div>}
                    </div>

                    {showSnack && <Modal title={`Snack Empleado ($${snackPrice})`} icon={Coffee} onClose={() => setShowSnack(false)} footer={<div className="flex gap-3"><Button onClick={() => setShowSnack(false)} variant="secondary" className="flex-1">Cancelar</Button><Button onClick={() => { if (snackEmp) { addDebt(snackEmp, 1); setShowSnack(false); setSnackEmp(''); } }} disabled={!snackEmp} variant="warning" className="flex-1">Confirmar</Button></div>}><select className="w-full border p-3 rounded-lg mb-6 text-lg bg-white" onChange={e => setSnackEmp(e.target.value)} value={snackEmp}><option value="">Seleccionar Empleado...</option>{employees.map(e => <option key={e.id || e.name} value={e.name}>{e.name}</option>)}</select></Modal>}

                    {showAttendance && <Modal title="Asistencia" icon={UserCheck} onClose={() => setShowAttendance(false)} footer={<Button onClick={() => setShowAttendance(false)} variant="secondary" className="w-full">Cerrar</Button>}><div className="max-h-80 overflow-y-auto space-y-2">{employees.map(e => <div key={e.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span className="font-medium text-lg">{e.name}</span><button onClick={() => toggleAttendance(e.id, e.name, !e.active)} className={`px-4 py-2 rounded-lg font-bold ${e.active ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`}>{e.active ? 'PRESENTE' : 'AUSENTE'}</button></div>)}</div></Modal>}

                    {showExpense && <Modal title="Registrar Gasto" icon={TrendingDown} onClose={() => setShowExpense(false)} footer={<div className="flex gap-3"><Button onClick={() => setShowExpense(false)} variant="secondary" className="flex-1">Cancelar</Button><Button onClick={handleAddExpense} variant="danger" className="flex-1">Registrar</Button></div>}><div className="space-y-3"><div><label className="block text-sm font-bold text-gray-600 mb-1">Concepto</label><input value={expDesc} onChange={e => setExpDesc(e.target.value)} className="w-full border p-3 rounded-lg" placeholder="Ej. Jabón" /></div><div><label className="block text-sm font-bold text-gray-600 mb-1">Monto ($)</label><input type="number" value={expAmt} onChange={e => setExpAmt(e.target.value)} className="w-full border p-3 rounded-lg" placeholder="0.00" /></div></div></Modal>}
                </div>
            );
        };

        const HistoryView = () => {
            const { history, tickets, deductions } = useContext(AppContext);
            const allPaid = history.concat(tickets.filter(t => t.status === 'PAID'));
            return (
                <div className="p-4 h-full overflow-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex items-center"><CheckCircle className="w-4 h-4 mr-2 text-green-600" /> Tickets Pagados</div>
                        <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                            <table className="w-full text-sm text-left"><thead className="bg-gray-50 font-bold text-gray-700 sticky top-0"><tr><th className="p-3">ID</th><th className="p-3">Hora</th><th className="p-3">Servicio</th><th className="p-3 text-right">Total</th></tr></thead><tbody>{allPaid.map(t => <tr key={t.id} className="border-t hover:bg-gray-50"><td className="p-3 font-mono text-xs">#{t.id.slice(-4).toUpperCase()}</td><td className="p-3">{t.timestamp instanceof Date ? t.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...'}</td><td className="p-3"><div className="font-medium">{t.service?.label || 'Extras'}</div>{t.snackCount > 0 && <span className="text-xs text-orange-600 font-bold block">(+{t.snackCount} Snacks)</span>}</td><td className="p-3 font-bold text-green-600 text-right">{formatCurrency(t.price)}</td></tr>)}</tbody></table>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center"><span>Snacks Empleados</span><Coffee className="w-4 h-4 text-orange-500" /></div>
                        <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                            <table className="w-full text-sm text-left"><thead className="bg-orange-50 font-bold text-orange-800 sticky top-0"><tr><th className="p-3">Fecha</th><th className="p-3">Empleado</th><th className="p-3 text-right">Monto</th></tr></thead><tbody>{deductions.filter(d => d.amount > 0).map(d => <tr key={d.id} className="border-t hover:bg-orange-50"><td className="p-3">{d.timestamp instanceof Date ? d.timestamp.toLocaleDateString() : '...'}</td><td className="p-3 font-bold">{d.employee}</td><td className="p-3 font-bold text-red-500 text-right">-{formatCurrency(d.amount)}</td></tr>)}</tbody></table>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminCorte = () => {
            const { history, tickets, expenses, exRate, initialCash, updateExpense, resolveExpense } = useContext(AppContext);
            const [corteMode, setCorteMode] = useState('DAY');
            const [corteDate, setCorteDate] = useState(getLocalDateStr());
            const [corteMonth, setCorteMonth] = useState(getMonthStr());
            const [editingExpenseId, setEditingExpenseId] = useState(null);
            const [editExpDesc, setEditExpDesc] = useState('');
            const [editExpAmt, setEditExpAmt] = useState('');

            const allPaidForCorte = history.concat(tickets.filter(t => t.status === 'PAID'));
            const corteTickets = allPaidForCorte.filter(t => { const d = new Date(t.paidAt ? t.paidAt : t.timestamp); return corteMode === 'DAY' ? getLocalDateStr(d) === corteDate : getMonthStr(d) === corteMonth; });
            const corteExpenses = expenses.filter(e => { const d = new Date(e.timestamp); return corteMode === 'DAY' ? getLocalDateStr(d) === corteDate : getMonthStr(d) === corteMonth; });

            const calculateCorteTotals = () => {
                let revenueCard = 0, revenueCashTickets = 0, collectedUsd = 0;
                corteTickets.forEach(t => { if (t.paymentDetails?.method === 'CARD') revenueCard += t.price; else { revenueCashTickets += t.price; collectedUsd += (t.paymentDetails?.usd || 0); } });
                const impliedMxnSales = revenueCashTickets - (collectedUsd * exRate);
                const approvedExpensesTotal = corteExpenses.filter(e => e.status === 'APPROVED').reduce((a, b) => a + (b.amount || 0), 0);
                const initMxn = parseFloat(initialCash.mxn) || 0;
                const initUsd = parseFloat(initialCash.usd) || 0;
                return { total: revenueCard + revenueCashTickets, card: revenueCard, cashTotal: revenueCashTickets, cashMxn: impliedMxnSales, cashUsd: collectedUsd, expenses: approvedExpensesTotal, initialMxn: initMxn, initialUsd: initUsd, cashNetMxn: (impliedMxnSales + initMxn) - approvedExpensesTotal, cashNetUsd: collectedUsd + initUsd };
            };
            const corteTotals = calculateCorteTotals();

            const printCorte = () => {
                const html = PrintService.getCorteHtml({
                    type: corteMode === 'DAY' ? 'Diario' : 'Mensual',
                    dateLabel: corteMode === 'DAY' ? corteDate : corteMonth,
                    totals: corteTotals,
                    tickets: corteTickets,
                    expenses: corteExpenses.filter(e => e.status === 'APPROVED')
                });
                PrintService.print(html);
            };
            const saveEditedExpense = () => { if (editingExpenseId) { updateExpense(editingExpenseId, { description: editExpDesc, amount: parseFloat(editExpAmt) || 0 }); setEditingExpenseId(null); } };

            return (
                <div className="max-w-4xl mx-auto space-y-6">
                    <div className="bg-white p-4 rounded-xl shadow-sm border flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex gap-2 bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => setCorteMode('DAY')} className={`px-3 py-1 rounded-md text-sm font-bold ${corteMode === 'DAY' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Día</button>
                            <button onClick={() => setCorteMode('MONTH')} className={`px-3 py-1 rounded-md text-sm font-bold ${corteMode === 'MONTH' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Mes</button>
                        </div>
                        <div className="flex items-center gap-2">{corteMode === 'DAY' ? <input type="date" value={corteDate} onChange={e => setCorteDate(e.target.value)} className="font-bold text-lg bg-transparent outline-none border p-2 rounded" /> : <input type="month" value={corteMonth} onChange={e => setCorteMonth(e.target.value)} className="font-bold text-lg bg-transparent outline-none border p-2 rounded" />}</div>
                        <Button onClick={printCorte}><Printer size={18} /> IMPRIMIR</Button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-gradient-to-br from-green-500 to-emerald-600 text-white p-6 rounded-xl shadow-lg"><div className="flex items-center gap-2 mb-1 opacity-90"><TrendingUp size={18} /> Venta Total</div><div className="text-3xl font-bold">{formatCurrency(corteTotals.total)}</div><div className="text-sm opacity-80 mt-1">{corteTickets.length} Tickets</div></div>
                        <div className="bg-white p-6 rounded-xl shadow border border-gray-100"><div className="flex items-center gap-2 mb-1 text-gray-500 font-bold text-sm"><Banknote size={18} /> En Caja (Neto MXN)</div><div className="text-3xl font-bold text-gray-800">{formatCurrency(corteTotals.cashNetMxn)}</div><div className="text-xs text-gray-400 mt-1">Incluye Fondo Inicial</div></div>
                        <div className="bg-white p-6 rounded-xl shadow border border-gray-100"><div className="flex items-center gap-2 mb-1 text-gray-500 font-bold text-sm"><DollarSign size={18} /> Dólares (Neto)</div><div className="text-3xl font-bold text-green-700">${corteTotals.cashNetUsd.toFixed(2)}</div><div className="text-xs text-gray-400 mt-1">Incluye Fondo Inicial</div></div>
                        <div className="bg-white p-6 rounded-xl shadow border border-gray-100"><div className="flex items-center gap-2 mb-1 text-gray-500 font-bold text-sm"><CreditCard size={18} /> Tarjeta</div><div className="text-3xl font-bold text-blue-600">{formatCurrency(corteTotals.card)}</div></div>
                    </div>
                    <div className="bg-white rounded-xl shadow border overflow-hidden">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center"><span>Gastos</span><span className="text-sm text-red-500 font-bold">Total: {formatCurrency(corteTotals.expenses)}</span></div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-500"><tr><th className="p-3">Concepto</th><th className="p-3">Monto</th><th className="p-3">Estado</th><th className="p-3 text-right">Acción</th></tr></thead><tbody>{corteExpenses.map(e => <tr key={e.id} className="border-t hover:bg-gray-50"><td className="p-3">{editingExpenseId === e.id ? <input value={editExpDesc} onChange={ev => setEditExpDesc(ev.target.value)} className="border p-1 rounded w-full" /> : e.description}</td><td className="p-3 font-bold text-red-600">{editingExpenseId === e.id ? <input type="number" value={editExpAmt} onChange={ev => setEditExpAmt(ev.target.value)} className="border p-1 rounded w-24" /> : `-${formatCurrency(e.amount)}`}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs font-bold ${e.status === 'APPROVED' ? 'bg-green-100 text-green-700' : (e.status === 'REJECTED' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700')}`}>{e.status}</span></td><td className="p-3 text-right">{editingExpenseId === e.id ? <div className="flex justify-end gap-2"><button onClick={saveEditedExpense} className="bg-blue-100 text-blue-700 p-1 rounded hover:bg-blue-200"><Save size={16} /></button><button onClick={() => setEditingExpenseId(null)} className="bg-gray-100 text-gray-700 p-1 rounded hover:bg-gray-200"><X size={16} /></button></div> : <div className="flex justify-end gap-2 items-center">{e.status === 'APPROVED' && <button onClick={() => { setEditingExpenseId(e.id); setEditExpDesc(e.description); setEditExpAmt(e.amount); }} className="text-gray-400 hover:text-blue-500"><Pencil size={14} /></button>}{e.status === 'PENDING' && <><button onClick={() => resolveExpense(e.id, 'APPROVED')} className="bg-green-100 text-green-700 p-1 rounded hover:bg-green-200"><Check size={16} /></button><button onClick={() => resolveExpense(e.id, 'REJECTED')} className="bg-red-100 text-red-700 p-1 rounded hover:bg-red-200"><X size={16} /></button></>}</div>}</td></tr>)}</tbody></table>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminNomina = () => {
            const { employees, history, deductions, commissions, extrasList, db, tickets } = useContext(AppContext);
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setDate(d.getDate() - 7); return d.toISOString().split('T')[0]; });
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);

            const start = new Date(startDate); start.setHours(0, 0, 0, 0);
            const end = new Date(endDate); end.setHours(23, 59, 59, 999);
            const filterRange = (ts) => { if (!ts) return true; const date = new Date(ts.toDate ? ts.toDate() : ts); return date >= start && date <= end; };

            const rangeHistory = history.filter(t => t.status === 'PAID' && filterRange(t.timestamp));
            const rangeDeductions = deductions.filter(d => d.status === 'PENDING' && filterRange(d.timestamp));
            const payroll = calculatePayroll(employees, rangeHistory, rangeDeductions, commissions, extrasList);
            const totalNomina = Object.values(payroll).reduce((acc, p) => acc + p.netPay, 0);

            const printNomina = () => {
                let html = `<html><head><title>Nomina</title>
                <style>
                    body { font-family: sans-serif; padding: 20px; color: #333; }
                    h2, h3 { margin-bottom: 5px; margin-top: 20px; }
                    
                    /* Grid Table Styling */
                    .grid-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 11px; }
                    .grid-table th, .grid-table td { border: 1px solid #ccc; padding: 4px; text-align: center; }
                    .grid-table th { background: #f3f4f6; }
                    .grid-table .svc-label { text-align: left; font-weight: bold; }
                    
                    /* Multiplier List Styling */
                    .multiplier-list { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 15px; }
                    .multiplier-list td { padding: 2px 0; border-bottom: 1px dotted #eee; }
                    .total-row { font-weight: bold; font-size: 14px; border-top: 1px solid #000; margin-top: 10px; padding-top: 5px; }
                    .deductions { color: #cc0000; }
                    
                    .page-break { page-break-after: always; }
                    .header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
                </style>
                </head><body>`;

                Object.keys(payroll).forEach(name => {
                    const p = payroll[name];
                    if (p.count === 0 && p.deductionTotal === 0) return;

                    // Header
                    html += `
                        <div class="header">
                            <div>
                                <h2 style="margin:0">${name}</h2>
                                <small>${startDate} a ${endDate}</small>
                            </div>
                            <div style="text-align:right">
                                <h2 style="margin:0">${formatCurrency(p.netPay)}</h2>
                                <small>TOTAL A PAGAR</small>
                            </div>
                        </div>
                    `;

                    // 1. Grid (Counts)
                    html += `<h4>Cantidad de Servicios</h4>`;
                    html += `<table class="grid-table">
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                ${SIZES.map(s => `<th>${s.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>`;

                    SERVICES.forEach(svc => {
                        const rowCounts = SIZES.map(sz => p.serviceGrid[svc.id][sz.id] || 0);
                        // Only show rows that have data
                        if (rowCounts.some(c => c > 0)) {
                            html += `<tr>
                                <td class="svc-label">${svc.label}</td>
                                ${rowCounts.map(c => `<td style="${c > 0 ? 'font-weight:bold;' : 'color:#ccc'}">${c || '-'}</td>`).join('')}
                            </tr>`;
                        }
                    });
                    html += `</tbody></table>`;

                    // 2. Extras
                    const extraKeys = Object.keys(p.extrasData).sort();
                    if (extraKeys.length > 0) {
                        html += `<h4>Extras</h4>`;
                        html += `<table class="multiplier-list" style="width:100%; border-collapse:collapse; font-size:11px;">
                            <thead><tr style="background:#f3f4f6;"><th style="text-align:left; padding:4px;">Concepto</th><th style="text-align:center; padding:4px;">Cant.</th><th style="text-align:right; padding:4px;">Total</th></tr></thead>
                            <tbody>`;
                        extraKeys.forEach(label => {
                            const item = p.extrasData[label];
                            html += `<tr>
                                <td style="padding:4px; border-bottom:1px solid #eee;">${label}</td>
                                <td style="text-align:center; padding:4px; border-bottom:1px solid #eee;">${item.count}</td>
                                <td style="text-align:right; padding:4px; border-bottom:1px solid #eee;">${formatCurrency(item.total)}</td>
                            </tr>`;
                        });
                        html += `</tbody></table>`;
                    }

                    // 3. Deductions (Renamed to Varios)
                    if (p.deductionTotal > 0) {
                        html += `<div style="margin-top: 15px; border-top: 1px dotted #ccc; padding-top: 5px; display: flex; justify-content: space-between; font-size: 12px; color: #cc0000;">
                            <span>Varios (Snacks, Prestamos, etc.)</span>
                            <span>-${formatCurrency(p.deductionTotal)}</span>
                         </div>`;
                    }

                    // 4. Legal Text & Signature
                    html += `
                        <div style="margin-top: 30px; font-size: 10px; text-align: justify;">
                            Recibí de LAVAMEX la cantidad descrita a mi entera satisfacción por concepto de pago por servicios de lavado realizados. No reservándome acción ni derecho alguno que ejercitar por ninguna vía laboral, civil o mercantil.
                        </div>
                        <div style="margin-top: 40px; text-align: center;">
                            _______________________________<br>
                            Firma del Empleado
                        </div>
                    `;

                    html += `<hr class="page-break" />`;
                });
                html += `</body></html>`;
                PrintService.print(html);
            };

            const closeWeek = async () => { if (!confirm("¿Archivar semana?")) return; const batch = writeBatch(db); rangeHistory.forEach(t => batch.update(doc(db, "tickets", t.id), { status: 'ARCHIVED' })); rangeDeductions.forEach(d => batch.update(doc(db, "deductions", d.id), { status: 'ARCHIVED' })); await batch.commit(); alert("Semana Cerrada"); };

            return (
                <div>
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6 rounded-xl shadow-lg mb-6 flex justify-between items-center">
                        <div><h2 className="text-2xl font-bold m-0 flex items-center gap-2"><Users className="w-6 h-6" /> Total Nómina</h2></div>
                        <div className="text-4xl font-bold">{formatCurrency(totalNomina)}</div>
                    </div>
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100 gap-4">
                        <div className="flex flex-wrap gap-3 items-end">
                            <div><label className="text-xs font-bold text-gray-500 block mb-1">Inicio</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                            <div><label className="text-xs font-bold text-gray-500 block mb-1">Fin</label><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                            <Button onClick={printNomina} variant="success"><Printer className="w-4 h-4" /> PDF</Button>
                        </div>
                        <Button onClick={closeWeek} variant="danger"><Archive className="w-4 h-4" /> CERRAR SEMANA</Button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {Object.keys(payroll).map(name => (
                            <div key={name} className="bg-white p-5 rounded-xl shadow-sm border border-l-4 border-l-blue-500">
                                <div className="font-bold text-xl text-gray-800 mb-1">{name}</div>
                                <div className="text-3xl font-bold text-green-700">{formatCurrency(payroll[name].netPay)}</div>
                                <div className="text-sm text-gray-500 mt-2 flex justify-between border-t pt-2"><span>Com: {formatCurrency(payroll[name].total)}</span><span className="text-red-500 font-medium">Ded: {formatCurrency(payroll[name].deductionTotal)}</span></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AdminAsistencia = () => {
            const { db, employees } = useContext(AppContext);
            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));

            const generateAttendanceReport = async () => {
                const q = query(collection(db, "attendance"), where("month", "==", reportMonth));
                const snapshot = await getDocs(q);
                const attendanceData = {};
                snapshot.forEach(doc => { attendanceData[doc.id] = doc.data().records; });

                const daysInMonth = new Date(reportMonth.split('-')[0], reportMonth.split('-')[1], 0).getDate();
                const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

                const tableRows = employees.map(emp => {
                    const cells = days.map(day => {
                        const dateStr = `${reportMonth}-${String(day).padStart(2, '0')}`;
                        const status = attendanceData[dateStr]?.[emp.name];
                        return `<td style="text-align:center; padding: 2px;">${status ? '✔️' : ''}</td>`;
                    }).join('');
                    return `<tr><td style="font-weight:bold; padding:4px;">${emp.name}</td>${cells}</tr>`;
                }).join('');

                const html = `<h2 style="text-align:center">Asistencia: ${reportMonth}</h2><table style="width:100%; border-collapse: collapse; font-size: 10px;" border="1"><thead><tr><th>Empleado</th>${days.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody>${tableRows}</tbody></table>`;
                PrintService.print(html, true);
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-lg mx-auto">
                    <h3 className="font-bold mb-4 text-gray-800 flex items-center"><Calendar className="mr-2" /> Reporte de Asistencia</h3>
                    <div className="mb-4"><label className="block text-sm font-bold text-gray-600 mb-2">Mes</label><input type="month" value={reportMonth} onChange={e => setReportMonth(e.target.value)} className="border p-3 rounded-lg w-full text-lg" /></div>
                    <Button onClick={generateAttendanceReport} className="w-full">Imprimir Reporte Mensual</Button>
                </div>
            );
        };

        const AdminConfig = () => {
            const { exRate, snackPrice, initialCash, updateGlobalSettings, employees, addEmployee } = useContext(AppContext);
            const [localExRate, setLocalExRate] = useState(exRate);
            const [localSnackPrice, setLocalSnackPrice] = useState(snackPrice);
            const [localInitMxn, setLocalInitMxn] = useState(initialCash.mxn);
            const [localInitUsd, setLocalInitUsd] = useState(initialCash.usd);
            const [newEmpName, setNewEmpName] = useState('');
            useEffect(() => { setLocalExRate(exRate); setLocalSnackPrice(snackPrice); setLocalInitMxn(initialCash.mxn); setLocalInitUsd(initialCash.usd); }, [exRate, snackPrice, initialCash]);
            const handleAddEmployee = () => { if (newEmpName.trim()) { addEmployee(newEmpName.trim()); setNewEmpName(''); } };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-lg mx-auto">
                    <h3 className="font-bold mb-4 text-gray-800">General</h3>
                    <div className="mb-6 flex flex-col gap-4">
                        <div><label className="block text-sm font-bold text-gray-600 mb-2">Cambio de Dólar ($)</label><input type="number" value={localExRate} onChange={e => setLocalExRate(e.target.value)} className="border p-3 rounded-lg w-full text-lg" /></div>
                        <div><label className="block text-sm font-bold text-gray-600 mb-2">Precio Snack ($)</label><input type="number" value={localSnackPrice} onChange={e => setLocalSnackPrice(e.target.value)} className="border p-3 rounded-lg w-full text-lg" /></div>
                        <div className="border-t pt-4"><h4 className="font-bold text-gray-700 mb-3 flex items-center"><Briefcase className="w-4 h-4 mr-2" /> Fondo de Caja (Inicial)</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-gray-500 mb-1">Pesos (MXN)</label><input type="number" value={localInitMxn} onChange={e => setLocalInitMxn(e.target.value)} className="border p-3 rounded-lg w-full text-lg bg-gray-50" /></div><div><label className="block text-xs font-bold text-gray-500 mb-1">Dólares (USD)</label><input type="number" value={localInitUsd} onChange={e => setLocalInitUsd(e.target.value)} className="border p-3 rounded-lg w-full text-lg bg-gray-50" /></div></div></div>
                        <Button onClick={() => { updateGlobalSettings(parseFloat(localExRate), parseFloat(localSnackPrice), parseFloat(localInitMxn), parseFloat(localInitUsd)); alert("Ajustes actualizados"); }} className="w-full mt-2">Guardar Cambios</Button>
                    </div>
                    <h3 className="font-bold mb-4 border-t pt-4 text-gray-800">Empleados</h3>
                    <div className="flex gap-2 mb-4"><input value={newEmpName} onChange={(e) => setNewEmpName(e.target.value)} placeholder="Nuevo Empleado" className="border p-3 rounded-lg flex-1" /><Button onClick={handleAddEmployee}><PlusCircle className="w-5 h-5" /></Button></div>
                    <div className="space-y-2">{employees.map((e) => (<div key={e.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span className="font-medium">{e.name}</span><span className={`text-xs font-bold px-2 py-1 rounded ${e.active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{e.active ? 'Presente' : 'Ausente'}</span></div>))}</div>
                </div>
            );
        };

        const AdminPrecios = () => {
            const { prices, commissions, extrasList, db } = useContext(AppContext);
            const [editPrices, setEditPrices] = useState({});
            const [editComms, setEditComms] = useState({});
            const [editExtras, setEditExtras] = useState([]);

            useEffect(() => {
                setEditPrices(JSON.parse(JSON.stringify(prices)));
                setEditComms(JSON.parse(JSON.stringify(commissions)));
                setEditExtras(JSON.parse(JSON.stringify(extrasList)));
            }, [prices, commissions, extrasList]);

            const updateLocalPrice = (type, svcId, sizeId, val) => {
                const target = type === 'prices' ? editPrices : editComms;
                const setTarget = type === 'prices' ? setEditPrices : setEditComms;
                const newObj = { ...target };
                if (!newObj[svcId]) newObj[svcId] = {};
                newObj[svcId][sizeId] = parseFloat(val) || 0;
                setTarget(newObj);
            };

            const updateLocalExtra = (index, field, val) => {
                const arr = [...editExtras];
                arr[index][field] = val;
                setEditExtras(arr);
            };

            const saveAllSettings = () => handleDbAction(async () => {
                if (!confirm("¿Aplicar nuevos precios?")) return;
                const batch = writeBatch(db);

                // 1. Save Prices & Commissions (Maps)
                batch.set(doc(db, "settings", "prices"), editPrices);
                batch.set(doc(db, "settings", "commissions"), editComms);

                // 2. Process Extras Updates/Inserts
                editExtras.forEach(e => {
                    if (e.docId) {
                        batch.update(doc(db, "extras", e.docId), {
                            label: e.label,
                            price: parseFloat(e.price) || 0,
                            commission: parseFloat(e.commission) || 0,
                            id: e.id
                        });
                    } else {
                        const newRef = doc(collection(db, "extras"));
                        batch.set(newRef, {
                            id: e.id || `EXTRA_${Date.now()}`,
                            label: e.label,
                            price: parseFloat(e.price) || 0,
                            commission: parseFloat(e.commission) || 0
                        });
                    }
                });

                await batch.commit();
                alert("¡Precios Actualizados!");
            });

            return (
                <div className="space-y-6">
                    <div className="bg-blue-50 border-blue-200 border p-4 rounded-xl flex justify-between items-center">
                        <div><h3 className="font-bold text-blue-800">Edición de Precios</h3><p className="text-sm text-blue-600">Edita los valores y guarda para aplicar.</p></div>
                        <Button onClick={saveAllSettings} className="px-6 py-3 shadow-lg"><Upload className="w-5 h-5" /> GUARDAR</Button>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                        <table className="w-full text-sm text-left border-collapse">
                            <thead><tr className="bg-gray-100"><th className="p-3 border">Servicio</th>{SIZES.map(s => <th key={s.id} className="p-3 border">{s.label}</th>)}</tr></thead>
                            <tbody>
                                {SERVICES.map(svc => (
                                    <tr key={svc.id}>
                                        <td className="p-3 border font-medium">{svc.label}</td>
                                        {SIZES.map(size => (
                                            <td key={size.id} className="p-2 border">
                                                <div className="flex flex-col gap-1">
                                                    <input type="number" value={editPrices[svc.id]?.[size.id] || 0} onChange={(e) => updateLocalPrice('prices', svc.id, size.id, e.target.value)} className="border p-1 rounded w-full text-center text-green-700 font-bold" placeholder="Precio" />
                                                    <input type="number" value={editComms[svc.id]?.[size.id] || 0} onChange={(e) => updateLocalPrice('commissions', svc.id, size.id, e.target.value)} className="border p-1 rounded w-full text-center text-blue-600 text-xs" placeholder="Com" />
                                                </div>
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto mt-6">
                        <div className="flex justify-between items-center mb-4">
                            <h4 className="font-bold text-gray-700">Extras (Lista Fija)</h4>
                        </div>
                        <table className="w-full text-sm text-left border-collapse">
                            <thead>
                                <tr className="bg-gray-100">
                                    <th className="p-3 border">Nombre / Etiqueta</th>
                                    <th className="p-3 border text-center">Precio ($)</th>
                                    <th className="p-3 border text-center">Comisión ($)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {editExtras.map((ex, idx) => (
                                    <tr key={idx}>
                                        <td className="p-3 border font-bold text-gray-700 bg-gray-50">
                                            {ex.label}
                                        </td>
                                        <td className="p-2 border">
                                            <input type="number" value={ex.price} onChange={(e) => updateLocalExtra(idx, 'price', e.target.value)} className="border p-2 rounded w-full text-center text-green-700 font-bold" />
                                        </td>
                                        <td className="p-2 border">
                                            <input type="number" value={ex.commission} onChange={(e) => updateLocalExtra(idx, 'commission', e.target.value)} className="border p-2 rounded w-full text-center text-blue-600 font-bold" />
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const AdminPanel = () => {
            const [tab, setTab] = useState('CORTE');
            return (
                <div className="p-4 md:p-6 h-full overflow-y-auto">
                    <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-1">
                        {['CORTE', 'NOMINA', 'CONFIG', 'PRECIOS'].map(t => <button key={t} onClick={() => setTab(t)} className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === t ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>{t}</button>)}
                    </div>
                    {tab === 'CORTE' && <AdminCorte />}
                    {tab === 'NOMINA' && <AdminNomina />}
                    {tab === 'CONFIG' && <AdminConfig />}
                    {tab === 'PRECIOS' && <AdminPrecios />}
                </div>
            );
        };

        // ------------------------------------------------------------------
        // SECTION 10: MAIN LAYOUT
        // ------------------------------------------------------------------
        const LavamexPOS = () => {
            const { role, view, setView, logout } = useContext(AppContext);
            if (!role) return <LoginScreen />;
            return (
                <div className="h-screen flex flex-col bg-gray-100 font-sans">
                    <header className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md shrink-0 z-50">
                        <a href="https://lavamex.work/menu" className="flex items-center gap-2 font-bold text-lg md:text-xl truncate hover:opacity-80 transition-opacity">
                            <Car className="text-blue-400 shrink-0" /> <span>LAVAMEX</span>
                        </a>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            <button onClick={() => setView('GREETER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'GREETER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><CheckCircle size={18} /> <span className="hidden sm:inline">Entrada</span></button>
                            {(role === 'CASHIER' || role === 'ADMIN') && <><button onClick={() => setView('CASHIER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'CASHIER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Calculator size={18} /> <span className="hidden sm:inline">Caja</span></button><button onClick={() => setView('HISTORY')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'HISTORY' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><History size={18} /> <span className="hidden sm:inline">Historial</span></button></>}
                            {role === 'ADMIN' && <button onClick={() => setView('ADMIN')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'ADMIN' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Settings size={18} /> <span className="hidden sm:inline">Admin</span></button>}
                            <button onClick={logout} className="bg-red-900/80 px-3 rounded ml-2 hover:bg-red-700 shrink-0"><LogOut size={18} /></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden relative">
                        {view === 'GREETER' && <GreeterView />}
                        {view === 'CASHIER' && <CashierView />}
                        {view === 'HISTORY' && <HistoryView />}
                        {view === 'ADMIN' && <AdminPanel />}
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<AppProvider><LavamexPOS /></AppProvider>);
    </script>
</body>

</html>