<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lavamex POS</title>
    <!-- UTILITIES: Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- COMPILER: Babel for in-browser JSX transformation (Dev only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- IMPORTS: ES Modules for React and Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <style>
        /* Utility to hide scrollbars while maintaining functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ------------------------------------------------------------------
        // SECTION 1: IMPORTS & SETUP
        // ------------------------------------------------------------------
        import React, { useState, useEffect, useContext, createContext } from 'react';
        import { createRoot } from 'react-dom/client';
        import { User, DollarSign, Car, CheckCircle, FileText, Settings, Trash2, LogOut, Users, Calculator, Printer, Wifi, WifiOff, Lock, Archive, Pencil, PlusCircle, Coffee, History, ArrowLeft, Save, Baby, Calendar, UserCheck, Activity, Database, PlayCircle, AlertTriangle, Edit3, Upload } from 'lucide-react';
        import { initializeApp, getApps, getApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp, writeBatch, setDoc, getDocs, where, getDoc, deleteDoc } from 'firebase/firestore';

        // ------------------------------------------------------------------
        // SECTION 2: FIREBASE CONFIGURATION
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyByIvJpBZv32Zd22fxlYWL9etzBa66Q2rE",
            authDomain: "poslavamex.firebaseapp.com",
            projectId: "poslavamex",
            storageBucket: "poslavamex.firebasestorage.app",
            messagingSenderId: "883264129",
            appId: "1:883264129:web:39a352e2ade3888b4f1b80"
        };
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);

        // ------------------------------------------------------------------
        // SECTION 3: CONSTANTS & DEFAULTS
        // MOVED PRICES/COMMISSIONS HERE AS SEED DATA ONLY
        // ------------------------------------------------------------------
        const SIZES = [{ id: 'AUTO', label: 'Auto' }, { id: 'SUV_CHICA', label: 'SUV Chica' }, { id: 'PICKUP', label: 'Pick-Up / SUV MD' }, { id: 'SUV_GDE', label: 'SUV Gde' }];
        const SERVICES = [{ id: 'GENERAL', label: 'Lavado General' }, { id: 'WAX', label: 'Lavado + Cera' }, { id: 'COMPLETE', label: 'Paquete Completo' }, { id: 'PREMIUM', label: 'Paquete Premium' }, { id: 'PRESIDENTIAL', label: 'Paquete Presidencial' }];
        const SNACK_PRICE = 25;

        const DEFAULTS = {
            PINS: {
                GREETER: '0000',
                CASHIER: '1234',
                ADMIN: '9999'
            },
            EXCHANGE_RATE: 18.10,
            INITIAL_EMPLOYEES: [
                { name: 'Aldo', active: true },
                { name: 'Sergio', active: true },
                { name: 'Juan', active: true },
                { name: 'Rodrigo', active: true }
            ],
            // Default Data for seeding Firestore
            PRICES: {
                GENERAL: { AUTO: 200, SUV_CHICA: 240, PICKUP: 360, SUV_GDE: 360 },
                WAX: { AUTO: 540, SUV_CHICA: 640, PICKUP: 820, SUV_GDE: 820 },
                COMPLETE: { AUTO: 840, SUV_CHICA: 1040, PICKUP: 1160, SUV_GDE: 1640 },
                PREMIUM: { AUTO: 1180, SUV_CHICA: 1440, PICKUP: 1620, SUV_GDE: 2100 },
                PRESIDENTIAL: { AUTO: 1540, SUV_CHICA: 1940, PICKUP: 2320, SUV_GDE: 2320 },
            },
            COMMISSIONS: {
                GENERAL: { AUTO: 70, SUV_CHICA: 84, PICKUP: 126, SUV_GDE: 126 },
                WAX: { AUTO: 189, SUV_CHICA: 224, PICKUP: 287, SUV_GDE: 287 },
                COMPLETE: { AUTO: 294, SUV_CHICA: 364, PICKUP: 406, SUV_GDE: 574 },
                PREMIUM: { AUTO: 413, SUV_CHICA: 504, PICKUP: 567, SUV_GDE: 735 },
                PRESIDENTIAL: { AUTO: 539, SUV_CHICA: 679, PICKUP: 812, SUV_GDE: 812 },
            },
            EXTRAS: [
                { id: 'MOTOR', label: 'Lavado Motor', price: 400, commission: 140 },
                { id: 'CHASIS', label: 'Chasis', price: 150, commission: 52.50 },
                { id: 'AROMA', label: 'Aroma', price: 30, commission: 10.50 },
                { id: 'BOLEADA', label: 'Boleada', price: 50, commission: 17.50 },
                { id: 'TAPICERIA', label: 'Limpieza Tapicería', price: 600, commission: 210 },
                { id: 'BABY_SEAT', label: 'Asiento de Bebé', price: 200, commission: 70 },
            ]
        };

        // ------------------------------------------------------------------
        // SECTION 4: HELPER FUNCTIONS (Business Logic)
        // Refactored to accept dynamic data
        // ------------------------------------------------------------------
        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);

        const calculateTicketTotals = (serviceId, sizeId, extraList, prices, commissions, snackCount = 0) => {
            const basePrice = prices[serviceId]?.[sizeId] || 0;
            const baseComm = commissions[serviceId]?.[sizeId] || 0;
            const extrasPrice = extraList.reduce((a, b) => a + b.price, 0);
            const extrasComm = extraList.reduce((a, b) => a + b.commission, 0);
            const snackCost = snackCount * SNACK_PRICE;
            return {
                basePrice, // useful for history/printing
                totalPrice: basePrice + extrasPrice + snackCost,
                totalCommission: baseComm + extrasComm
            };
        };

        const calculatePayroll = (employees, history, deductions) => {
            const payroll = {};
            employees.forEach(emp => {
                payroll[emp.name] = { count: 0, total: 0, details: [], deductionTotal: 0, deductionDetails: [], netPay: 0 };
            });

            history.forEach(item => {
                const washersList = item.washers || (item.washer ? [item.washer] : []);
                if (washersList.length === 0) return;
                const splitCommission = item.commission / washersList.length;
                washersList.forEach(washerName => {
                    if (!payroll[washerName]) payroll[washerName] = { count: 0, total: 0, details: [], deductionTotal: 0, deductionDetails: [], netPay: 0 };
                    payroll[washerName].count += 1;
                    payroll[washerName].total += splitCommission;
                    payroll[washerName].details.push({
                        date: item.timestamp,
                        service: `${item.service.label} (${item.size.label})`,
                        desc: item.vehicleDesc || 'Sin descripción',
                        amount: splitCommission
                    });
                });
            });

            deductions.forEach(d => {
                if (payroll[d.employee]) {
                    payroll[d.employee].deductionTotal += d.amount;
                    payroll[d.employee].deductionDetails.push({ date: d.timestamp, desc: d.description, amount: d.amount });
                }
            });

            Object.keys(payroll).forEach(key => {
                payroll[key].netPay = payroll[key].total - payroll[key].deductionTotal;
            });
            return payroll;
        };

        // ------------------------------------------------------------------
        // SECTION 5: PRINTING SERVICE
        // ------------------------------------------------------------------
        const PrintService = {
            open: () => {
                const win = window.open('', '', 'height=600,width=800');
                if (win) {
                    win.document.write('<html><body style="font-family:sans-serif; text-align:center; padding-top:50px;"><h3>Generando Ticket...</h3></body></html>');
                } else {
                    alert("Popups blocked. Please allow popups for this site.");
                }
                return win;
            },
            print: (win, content, landscape = false) => {
                if (!win) return;
                const orientation = landscape ? '@page { size: landscape; }' : '';
                win.document.open();
                win.document.write(`<html><head><title>Print</title><style>${orientation} body{font-family:'Courier New', sans-serif;font-size:12px;margin:0;padding:5px;}</style></head><body>${content}</body></html>`);
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 500);
            },
            getJobTicketHtml: (ticket, shortId) => {
                const washers = ticket.washers ? ticket.washers.join(', ') : ticket.washer;
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? `<div style="text-align:center;font-size:12px; margin-top:5px; font-weight:bold;">+ ${ticket.extras.map(e => e.label).join('<br>+ ')}</div>`
                    : '';
                return `
                    <div style="width:58mm; text-align:center; font-weight:bold;">LAVAMEX - ORDEN</div>
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>TICKET:</span><b>#${shortId}</b></div>
                    <div style="text-align:center; font-weight:bold; font-size:16px; margin:10px 0; width:58mm;">${washers}</div>
                    <div style="text-align:center; font-weight:bold; font-size:14px; width:58mm;">${ticket.size.label}<br>${ticket.service.label}</div>
                    <div style="width:58mm;">${extrasHtml}</div>
                    ${ticket.vehicleDesc ? `<div style="text-align:center; width:58mm;">(${ticket.vehicleDesc})</div>` : ''}
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="text-align:center; width:58mm;">.. TABLERO ..</div>
                `;
            },
            getReceiptHtml: (ticket, payment, shortId) => {
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? `<div style="font-size:10px;">${ticket.extras.map(e => `<div style="display:flex;justify-content:space-between;"><span>+ ${e.label}</span><span>${formatCurrency(e.price)}</span></div>`).join('')}</div>`
                    : '';
                // Fallback for tickets created before basePrice was stored
                const displayBasePrice = ticket.basePrice || 0;

                return `
                    <div style="width:58mm; text-align:center; font-weight:bold;">LAVAMEX</div>
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>Ticket:</span><span>#${shortId}</span></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>Fecha:</span><span>${new Date().toLocaleDateString()}</span></div>
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>${ticket.service.label}</span><span>${formatCurrency(displayBasePrice)}</span></div>
                    <div style="width:58mm;">${extrasHtml}</div>
                    ${ticket.snackCount > 0 ? `<div style="display:flex; justify-content:space-between; width:58mm;"><span>+ Snacks (${ticket.snackCount})</span><span>${formatCurrency(ticket.snackCount * SNACK_PRICE)}</span></div>` : ''}
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm; font-weight:bold;"><span>TOTAL:</span><span>${formatCurrency(ticket.price)}</span></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>Recibido:</span><span>${formatCurrency(payment.mxn + (payment.usd * payment.rate))}</span></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>Cambio:</span><span>${formatCurrency(payment.change)}</span></div>
                    <div style="text-align:center; margin-top:10px; width:58mm;">¡Gracias!</div>
                `;
            }
        };

        // ------------------------------------------------------------------
        // SECTION 6: UNIT TESTS
        // ------------------------------------------------------------------
        const TestRunner = {
            runLogicTests: () => {
                const results = [];
                const assert = (name, actual, expected) => {
                    const passed = JSON.stringify(actual) === JSON.stringify(expected);
                    results.push({ name, passed, details: passed ? 'OK' : `Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}` });
                };

                // Use Defaults for testing as Live data might change
                const T_PRICES = DEFAULTS.PRICES;
                const T_COMM = DEFAULTS.COMMISSIONS;
                const T_EXTRAS = DEFAULTS.EXTRAS;

                SERVICES.forEach(svc => {
                    SIZES.forEach(size => {
                        const price = T_PRICES[svc.id]?.[size.id];
                        const comm = T_COMM[svc.id]?.[size.id];
                        if (price === undefined || comm === undefined) results.push({ name: `Data Check ${svc.id}-${size.id}`, passed: false, details: 'Missing Data' });
                        else if (comm >= price) results.push({ name: `Profit Check ${svc.id}-${size.id}`, passed: false, details: 'Commission > Price' });
                    });
                });
                results.push({ name: 'Data Integrity Scan', passed: true, details: 'Checked all Price/Commission pairs' });

                const calcResult = calculateTicketTotals('GENERAL', 'SUV_GDE', [T_EXTRAS.find(e => e.id === 'BABY_SEAT')], T_PRICES, T_COMM, 1);
                assert('Calc: SUV GDE + Baby + Snack', calcResult.totalPrice, 585);

                const cujTotals = calculateTicketTotals('GENERAL', 'AUTO', [], T_PRICES, T_COMM, 1);
                assert('CUJ: Price (Base+Snack)', cujTotals.totalPrice, 225);
                assert('CUJ: Comm (Base only)', cujTotals.totalCommission, 70);

                const cujPayroll = calculatePayroll([{ name: 'TestWasher', active: true }], [{ id: '1', service: { label: 'Gen' }, size: { label: 'Auto' }, washers: ['TestWasher'], commission: 70, timestamp: new Date() }], [{ employee: 'TestWasher', amount: 25, timestamp: new Date() }]);
                assert('CUJ: Payroll Net', cujPayroll['TestWasher']?.netPay, 45);
                return results;
            },
            runPrintTests: () => {
                const results = [];
                const assertHtml = (name, html, snippets) => {
                    const missing = snippets.filter(s => !html.includes(s));
                    if (missing.length === 0) results.push({ name, passed: true, details: 'Content verified successfully' });
                    else results.push({ name, passed: false, details: `Missing content: ${missing.join(', ')}` });
                };
                try {
                    const mockTicket = { service: { id: 'GENERAL', label: 'Lavado General' }, size: { id: 'AUTO', label: 'Auto' }, washers: ['TestWasher'], extras: [{ label: 'Aroma', price: 30 }], vehicleDesc: 'Blue Ford', timestamp: new Date(), basePrice: 200 };
                    const ticketHtml = PrintService.getJobTicketHtml(mockTicket, 'TEST-ID');
                    assertHtml('Job Ticket HTML', ticketHtml, ['LAVAMEX - ORDEN', 'TEST-ID', 'Blue Ford', 'Aroma']);
                    const mockPayment = { mxn: 500, usd: 0, rate: 18, change: 50 };
                    const mockReceiptTicket = { ...mockTicket, price: 450, snackCount: 2 };
                    const receiptHtml = PrintService.getReceiptHtml(mockReceiptTicket, mockPayment, 'REC-999');
                    assertHtml('Receipt HTML', receiptHtml, ['Recibido:', '$500.00', 'Cambio:', '$50.00', 'Snacks (2)']);
                } catch (e) { results.push({ name: 'Print Logic Crash', passed: false, details: e.message }); }
                return results;
            },
            runDbTest: async () => {
                try {
                    const ref = await addDoc(collection(db, "_diagnostics"), { t: serverTimestamp() });
                    await deleteDoc(doc(db, "_diagnostics", ref.id));
                    return { passed: true, details: 'Write/Read/Delete Successful' };
                } catch (e) { return { passed: false, details: e.message }; }
            }
        };

        // ------------------------------------------------------------------
        // SECTION 7: CONTEXT & PROVIDER
        // ------------------------------------------------------------------

        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [role, setRole] = useState(() => localStorage.getItem('lavamex_role') || null);
            const [view, setView] = useState('GREETER');
            const [employees, setEmployees] = useState([]);
            const [exRate, setExRate] = useState(DEFAULTS.EXCHANGE_RATE);
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [deductions, setDeductions] = useState([]);
            const [editingTicket, setEditingTicket] = useState(null);

            // Dynamic Business Data
            const [prices, setPrices] = useState({});
            const [commissions, setCommissions] = useState({});
            const [extrasList, setExtrasList] = useState([]);

            // Cashier specific state
            const [payment, setPayment] = useState({ mxn: '', usd: '' });
            const [activeId, setActiveId] = useState(null);

            const login = (r) => {
                setRole(r);
                localStorage.setItem('lavamex_role', r);
                if (r) setView(r === 'ADMIN' ? 'ADMIN' : (r === 'CASHIER' ? 'CASHIER' : 'GREETER'));
            };

            const logout = () => {
                setRole(null);
                localStorage.removeItem('lavamex_role');
                setView('GREETER');
            };

            const restoreView = () => {
                setView(role ? (role === 'ADMIN' ? 'ADMIN' : (role === 'CASHIER' ? 'CASHIER' : 'GREETER')) : 'GREETER');
            }

            // Data Listeners
            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, "employees"), orderBy("name")), (snap) => {
                    if (snap.empty && employees.length === 0) {
                        DEFAULTS.INITIAL_EMPLOYEES.forEach(e => addDoc(collection(db, "employees"), e));
                    }
                    setEmployees(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, []);

            // Pricing Listeners
            useEffect(() => {
                const unsubP = onSnapshot(doc(db, "settings", "prices"), (docSnap) => {
                    if (docSnap.exists()) setPrices(docSnap.data());
                    else setDoc(doc(db, "settings", "prices"), DEFAULTS.PRICES); // Seed
                });
                const unsubC = onSnapshot(doc(db, "settings", "commissions"), (docSnap) => {
                    if (docSnap.exists()) setCommissions(docSnap.data());
                    else setDoc(doc(db, "settings", "commissions"), DEFAULTS.COMMISSIONS); // Seed
                });
                const unsubE = onSnapshot(collection(db, "extras"), (snap) => {
                    if (snap.empty) {
                        DEFAULTS.EXTRAS.forEach(e => addDoc(collection(db, "extras"), e));
                    } else {
                        setExtrasList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    }
                });
                return () => { unsubP(); unsubC(); unsubE(); };
            }, []);

            useEffect(() => {
                const qT = query(collection(db, "tickets"), orderBy("timestamp", "desc"));
                const unsubT = onSnapshot(qT, (snap) => {
                    const active = [], hist = [];
                    snap.forEach(d => {
                        const dat = { id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate() || new Date() };
                        if (dat.status === 'PENDING') active.push(dat);
                        else hist.push(dat);
                    });
                    setTickets(active); setHistory(hist);
                });
                const unsubD = onSnapshot(collection(db, "deductions"), (snap) => {
                    setDeductions(snap.docs.map(d => {
                        const data = d.data();
                        return { id: d.id, ...data, timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : (data.timestamp || new Date()) };
                    }));
                });
                return () => { unsubT(); unsubD(); };
            }, []);

            // Business Actions
            const saveTicket = async (data) => {
                const snacks = editingTicket ? (editingTicket.snackCount || 0) : 0;
                // Pass current state prices/commissions
                const totals = calculateTicketTotals(data.service.id, data.size.id, data.extras, prices, commissions, snacks);

                const ticketData = {
                    ...data,
                    price: totals.totalPrice,
                    commission: totals.totalCommission,
                    basePrice: totals.basePrice, // Store snapshot of base price
                    snackCount: snacks,
                    status: 'PENDING',
                    timestamp: serverTimestamp()
                };

                if (editingTicket) {
                    await updateDoc(doc(db, "tickets", editingTicket.id), ticketData);
                    setEditingTicket(null); if (role === 'CASHIER') setView('CASHIER');
                } else {
                    const win = PrintService.open();
                    const ref = await addDoc(collection(db, "tickets"), ticketData);
                    if (win) {
                        // For print preview, we mix in the date for display
                        const html = PrintService.getJobTicketHtml({ ...ticketData, timestamp: new Date() }, ref.id.slice(-4).toUpperCase());
                        PrintService.print(win, html);
                    }
                }
            };

            const updateSnacks = async (id, count) => {
                const t = tickets.find(x => x.id === id); if (!t) return;
                const newCount = Math.max(0, count);
                // Recalculate based on CURRENT prices (or should it be historical? For snacks, current is usually fine)
                const totals = calculateTicketTotals(t.service.id, t.size.id, t.extras || [], prices, commissions, newCount);
                await updateDoc(doc(db, "tickets", id), { snackCount: newCount, price: totals.totalPrice });
            };

            const toggleAttendance = async (empId, empName, isActive) => {
                await updateDoc(doc(db, "employees", empId), { active: isActive });
                const today = new Date();
                const dateKey = today.toISOString().split('T')[0];
                const monthKey = dateKey.slice(0, 7);
                await setDoc(doc(db, "attendance", dateKey), {
                    date: dateKey, month: monthKey, records: { [empName]: isActive }
                }, { merge: true });
            };

            const addEmployee = async (name) => {
                await addDoc(collection(db, "employees"), { name, active: true });
            };

            const deleteTicket = async (id) => {
                if (confirm("¿Seguro que deseas borrar este ticket?")) {
                    await updateDoc(doc(db, "tickets", id), { status: 'CANCELLED' });
                }
            };

            const addDebt = async (e, c) => {
                await addDoc(collection(db, "deductions"), { employee: e, amount: c * SNACK_PRICE, status: 'PENDING', timestamp: serverTimestamp() });
            };

            const startEdit = (ticket) => { setEditingTicket(ticket); setView('GREETER'); };
            const cancelEdit = () => { setEditingTicket(null); if (role === 'CASHIER') setView('CASHIER'); };

            const processPayment = async () => {
                const t = tickets.find(x => x.id === activeId); if (!t) return;
                const total = (parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate);
                if (total < t.price) return alert("Falta dinero");

                const win = PrintService.open();
                const details = { mxn: parseFloat(payment.mxn) || 0, usd: parseFloat(payment.usd) || 0, rate: exRate, change: total - t.price };
                await updateDoc(doc(db, "tickets", t.id), { status: 'PAID', paidAt: serverTimestamp(), paymentDetails: details });

                if (win) {
                    const html = PrintService.getReceiptHtml(t, details, t.id.slice(-4).toUpperCase());
                    PrintService.print(win, html);
                }
                setActiveId(null); setPayment({ mxn: '', usd: '' });
            };

            // Admin Settings Actions
            const updatePricing = async (type, serviceId, sizeId, value) => {
                const docRef = doc(db, "settings", type); // type = 'prices' or 'commissions'
                const numVal = parseFloat(value) || 0;
                // Using dot notation for nested update in Firestore
                await updateDoc(docRef, { [`${serviceId}.${sizeId}`]: numVal });
            };

            const updateExtra = async (id, field, value) => {
                const numVal = field === 'price' || field === 'commission' ? (parseFloat(value) || 0) : value;
                await updateDoc(doc(db, "extras", id), { [field]: numVal });
            };

            const value = {
                role, login, logout,
                view, setView, restoreView,
                employees, tickets, history, deductions,
                prices, commissions, extrasList,
                exRate, setExRate,
                editingTicket, startEdit, cancelEdit,
                activeId, setActiveId,
                payment, setPayment,
                saveTicket, updateSnacks, toggleAttendance, addEmployee, deleteTicket, addDebt, processPayment,
                updatePricing, updateExtra,
                db
            };

            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };

        // ------------------------------------------------------------------
        // SECTION 8: COMPONENTS
        // ------------------------------------------------------------------

        // ... [TestDashboard, LoginScreen unchanged] ...
        const TestDashboard = () => { const { restoreView } = useContext(AppContext); const [logicResults, setLogicResults] = useState(null); const [printResults, setPrintResults] = useState(null); const [dbResult, setDbResult] = useState(null); const [loading, setLoading] = useState(false); const runDb = async () => { setLoading(true); const res = await TestRunner.runDbTest(); setDbResult(res); setLoading(false); }; return (<div className="min-h-screen bg-gray-50 p-6"><div className="max-w-4xl mx-auto"><div className="flex items-center gap-4 mb-8"><button onClick={restoreView} className="bg-white p-2 rounded-full shadow hover:bg-gray-100"><ArrowLeft /></button><h1 className="text-3xl font-bold text-gray-800 flex items-center"><Activity className="mr-3 text-blue-600" /> System Status & Tests</h1></div><div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 className="font-bold text-lg mb-4 flex items-center"><Calculator className="mr-2 text-purple-500" /> Business Logic</h3><button onClick={() => setLogicResults(TestRunner.runLogicTests())} className="w-full py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 flex justify-center items-center gap-2"><PlayCircle size={18} /> Run Logic Suite</button></div><div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 className="font-bold text-lg mb-4 flex items-center"><Printer className="mr-2 text-teal-500" /> Print System</h3><button onClick={() => setPrintResults(TestRunner.runPrintTests())} className="w-full py-3 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 flex justify-center items-center gap-2"><FileText size={18} /> Run Print Tests</button></div><div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 className="font-bold text-lg mb-4 flex items-center"><Database className="mr-2 text-orange-500" /> Database</h3><button onClick={runDb} disabled={loading} className="w-full py-3 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 flex justify-center items-center gap-2">{loading ? 'Running...' : <><Wifi size={18} /> Test Connection</>}</button></div></div><div className="space-y-6">{dbResult && (<div className={`p-4 rounded-xl border-l-4 shadow-sm ${dbResult.passed ? 'bg-green-50 border-green-500 text-green-800' : 'bg-red-50 border-red-500 text-red-800'}`}><h4 className="font-bold flex items-center">{dbResult.passed ? <CheckCircle className="mr-2" /> : <AlertTriangle className="mr-2" />} Database Connectivity</h4><p className="ml-8 mt-1 text-sm opacity-90">{dbResult.details}</p></div>)}{printResults && (<div className="bg-white rounded-xl shadow border border-gray-200 overflow-hidden"><div className="p-4 bg-gray-50 border-b font-bold text-gray-700">Print System Results</div><div className="divide-y">{printResults.map((res, i) => (<div key={i} className="p-4 flex items-start gap-3 hover:bg-gray-50"><div className={`mt-1 ${res.passed ? 'text-green-500' : 'text-red-500'}`}>{res.passed ? <CheckCircle size={18} /> : <AlertTriangle size={18} />}</div><div><div className="font-medium text-gray-800">{res.name}</div><div className={`text-sm mt-1 ${res.passed ? 'text-gray-500' : 'text-red-600 font-bold'}`}>{res.details}</div></div></div>))}</div></div>)}{logicResults && (<div className="bg-white rounded-xl shadow border border-gray-200 overflow-hidden"><div className="p-4 bg-gray-50 border-b font-bold text-gray-700">Logic Test Results</div><div className="divide-y">{logicResults.map((res, i) => (<div key={i} className="p-4 flex items-start gap-3 hover:bg-gray-50"><div className={`mt-1 ${res.passed ? 'text-green-500' : 'text-red-500'}`}>{res.passed ? <CheckCircle size={18} /> : <AlertTriangle size={18} />}</div><div><div className="font-medium text-gray-800">{res.name}</div>{!res.passed && <div className="text-sm text-red-600 font-mono mt-1 bg-red-50 p-2 rounded">{res.details}</div>}</div></div>))}</div></div>)}</div></div></div>); };
        const LoginScreen = () => { const { login, setView } = useContext(AppContext); const [pin, setPin] = useState(''); const handleLogin = () => { if (pin === DEFAULTS.PINS.GREETER) login('GREETER'); else if (pin === DEFAULTS.PINS.CASHIER) login('CASHIER'); else if (pin === DEFAULTS.PINS.ADMIN) login('ADMIN'); else { alert('PIN Incorrecto'); setPin(''); } }; return (<div className="flex h-screen bg-gray-900 justify-center items-center p-4 relative"><button onClick={() => setView('TESTS')} className="absolute top-4 right-4 text-gray-600 hover:text-gray-400 flex items-center text-xs gap-1 opacity-50 hover:opacity-100 transition-opacity"><Activity size={14} /> System Status</button><div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center"><h1 className="text-3xl font-bold mb-6 text-gray-800">LAVAMEX POS</h1><div className="flex flex-col gap-4"><input type="password" pattern="[0-9]*" inputMode="numeric" value={pin} onChange={e => setPin(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleLogin()} placeholder="PIN" className="w-full p-4 border rounded-lg text-center text-3xl tracking-widest mb-2" autoFocus /><button onClick={handleLogin} className="w-full p-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition-transform text-lg">ENTRAR</button></div></div></div>); };

        const GreeterView = () => {
            const { employees, saveTicket, editingTicket, cancelEdit, prices, extrasList } = useContext(AppContext);
            const [size, setSize] = useState(null);
            const [service, setService] = useState(null);
            const [washers, setWashers] = useState([]);
            const [extras, setExtras] = useState([]);
            const [desc, setDesc] = useState('');

            useEffect(() => {
                if (editingTicket) {
                    setSize(editingTicket.size); setService(editingTicket.service); setWashers(editingTicket.washers || (editingTicket.washer ? [editingTicket.washer] : [])); setExtras(editingTicket.extras || []); setDesc(editingTicket.vehicleDesc || '');
                } else {
                    setSize(null); setService(null); setWashers([]); setExtras([]); setDesc('');
                }
            }, [editingTicket]);

            const toggle = (list, item, set) => {
                const isObj = typeof item !== 'string';
                const exists = isObj ? list.some(x => x.id === item.id) : list.includes(item);
                set(exists ? list.filter(x => isObj ? x.id !== item.id : x !== item) : [...list, item]);
            };

            const handleSubmit = () => {
                if (!size || !service || washers.length === 0) return;
                saveTicket({ size, service, washers, extras, desc });
                if (!editingTicket) { setSize(null); setService(null); setWashers([]); setExtras([]); setDesc(''); }
            };

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    {editingTicket && (
                        <div className="bg-yellow-200 p-3 text-center font-bold text-yellow-900 flex justify-between items-center px-4 shadow-sm z-10 shrink-0">
                            <span className="flex items-center gap-2 text-sm"><Pencil className="w-4 h-4" /> EDITANDO #{editingTicket.id.slice(-4).toUpperCase()}</span>
                            <button onClick={cancelEdit} className="bg-white px-3 py-1 rounded text-xs hover:bg-yellow-50 border border-yellow-300">Cancelar</button>
                        </div>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 flex-1 overflow-y-auto">
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><Car className="w-5 h-5 mr-2" /> 1. Tamaño</h3>
                            <div className="space-y-2">{SIZES.map(s => <button key={s.id} onClick={() => setSize(s)} className={`w-full p-4 text-left rounded-lg border-2 transition-all ${size?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 hover:bg-gray-50'}`}>{s.label}</button>)}</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><FileText className="w-5 h-5 mr-2" /> 2. Servicio</h3>
                            <div className="space-y-2 mb-4">{SERVICES.map(s => {
                                const price = size && prices[s.id] ? prices[s.id][size.id] : null;
                                return (
                                    <button key={s.id} disabled={!size} onClick={() => setService(s)} className={`w-full p-3 text-left rounded-lg border-2 flex justify-between items-center transition-all ${service?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 opacity-90 hover:bg-gray-50'}`}><span>{s.label}</span>{price !== null && <span className="bg-white px-2 py-1 rounded text-sm shadow-sm border">${price}</span>}</button>
                                )
                            })}</div>
                            <h3 className="font-bold mb-2 text-gray-700 text-sm">Extras</h3>
                            <div className="grid grid-cols-1 gap-2">{extrasList.map(e => <button key={e.id} onClick={() => toggle(extras, e, setExtras)} className={`w-full p-3 rounded-lg border text-sm flex justify-between items-center transition-all ${extras.some(x => x.id === e.id) ? 'bg-indigo-50 border-indigo-600 font-bold text-indigo-800' : 'border-gray-200 hover:bg-gray-50'}`}><span>{e.label}</span><span>+${e.price}</span></button>)}</div>
                        </div>
                        <div className="md:col-span-2 bg-white p-4 rounded-xl shadow border flex flex-col h-full">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><User className="w-5 h-5 mr-2" /> 3. Lavadores ({washers.length})</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">{employees.filter(e => e.active).map(e => <button key={e.name} onClick={() => toggle(washers, e.name, setWashers)} className={`p-4 rounded-lg border-2 text-center font-medium transition-all ${washers.includes(e.name) ? 'bg-green-100 border-green-600 text-green-800 shadow-inner' : 'border-gray-200 hover:bg-gray-50'}`}>{e.name}</button>)}</div>
                            <div className="mt-auto pt-4 border-t">
                                <input value={desc} onChange={e => setDesc(e.target.value)} placeholder="Descripción (Opcional)" className="w-full p-3 border rounded-lg mb-4 text-lg" />
                                <button onClick={handleSubmit} disabled={!size || !service || washers.length === 0} className={`w-full py-5 rounded-xl font-bold text-white text-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform ${!size || !service || washers.length === 0 ? 'bg-gray-300' : 'bg-blue-600 hover:bg-blue-700'}`}>{editingTicket ? <><Save className="w-6 h-6" /> GUARDAR</> : <><Printer className="w-6 h-6" /> CREAR ORDEN</>}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CashierView = () => {
            const { tickets, activeId, setActiveId, payment, setPayment, processPayment, deleteTicket, startEdit, updateSnacks, addDebt, employees, exRate, toggleAttendance } = useContext(AppContext);
            const t = tickets.find(x => x.id === activeId);
            const [showSnack, setShowSnack] = useState(false);
            const [showAttendance, setShowAttendance] = useState(false);
            const [snackEmp, setSnackEmp] = useState('');

            return (
                <div className="flex flex-col md:flex-row h-full gap-4 p-4 overflow-hidden">
                    <div className="w-full md:w-1/3 bg-white rounded-xl shadow border overflow-hidden flex flex-col h-1/3 md:h-full shrink-0">
                        <div className="p-3 bg-gray-50 font-bold border-b flex justify-between items-center shrink-0">
                            <span className="text-gray-700">Tickets ({tickets.length})</span>
                            <div className="flex gap-1">
                                <button onClick={() => setShowAttendance(true)} className="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold border border-blue-200 active:bg-blue-200">Asistencia</button>
                                <button onClick={() => setShowSnack(true)} className="text-xs bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-bold border border-orange-200 active:bg-orange-200">Snack</button>
                            </div>
                        </div>
                        <div className="overflow-y-auto flex-1 p-2 space-y-2">
                            {tickets.map(ticket => (
                                <div key={ticket.id} onClick={() => setActiveId(ticket.id)} className={`p-4 rounded-lg border cursor-pointer transition-all ${activeId === ticket.id ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50'}`}>
                                    <div className="flex justify-between font-bold text-gray-800"><span>#{ticket.id.slice(-4).toUpperCase()}</span><span>{formatCurrency(ticket.price)}</span></div>
                                    <div className="text-sm text-gray-600 mt-1">{ticket.service.label} <span className="bg-gray-200 px-1.5 rounded text-xs">{ticket.size.label}</span></div>
                                    {ticket.vehicleDesc && <div className="text-xs text-blue-600 italic mt-1">{ticket.vehicleDesc}</div>}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 bg-white rounded-xl shadow border p-4 md:p-6 flex flex-col items-center justify-center h-2/3 md:h-full overflow-y-auto">
                        {t ? (
                            <div className="w-full max-w-md">
                                <h2 className="text-4xl font-bold text-center mb-2 text-gray-800">{formatCurrency(t.price)}</h2>
                                <p className="text-center text-gray-500 mb-6 font-medium">{t.vehicleDesc} • {t.washers?.join(', ')}</p>
                                <div className="flex justify-center items-center gap-3 mb-6 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                    <span className="font-bold text-sm text-orange-800 uppercase tracking-wide">Snacks Cliente</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) - 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl shadow-sm text-gray-600 active:bg-gray-100">-</button>
                                    <span className="font-bold text-xl w-8 text-center">{t.snackCount || 0}</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) + 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl shadow-sm text-green-600 active:bg-gray-100">+</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div><label className="text-xs font-bold text-gray-500 mb-1 block">MXN</label><input type="number" inputMode="decimal" value={payment.mxn} onChange={e => setPayment({ ...payment, mxn: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" /></div>
                                    <div><label className="text-xs font-bold text-gray-500 mb-1 block">USD (Rate: {exRate})</label><input type="number" inputMode="decimal" value={payment.usd} onChange={e => setPayment({ ...payment, usd: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" /></div>
                                </div>
                                <div className="text-center font-bold mb-6 text-xl bg-gray-50 p-3 rounded-lg border">
                                    Cambio: <span className={((parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate)) - t.price < 0 ? 'text-red-500' : 'text-green-600'}>
                                        {formatCurrency(((parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate)) - t.price)}
                                    </span>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => deleteTicket(t.id)} className="p-4 border border-red-200 text-red-500 rounded-xl hover:bg-red-50 active:bg-red-100" title="Borrar"><Trash2 className="w-6 h-6" /></button>
                                    <button onClick={() => startEdit(t)} className="p-4 border border-yellow-200 text-yellow-600 rounded-xl bg-yellow-50 hover:bg-yellow-100 active:bg-yellow-200" title="Editar"><Pencil className="w-6 h-6" /></button>
                                    <button onClick={processPayment} className="flex-1 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><Printer className="w-6 h-6" /> COBRAR</button>
                                </div>
                            </div>
                        ) : <div className="text-gray-400 flex flex-col items-center"><LogOut className="w-16 h-16 opacity-20 mb-2" />Selecciona un ticket</div>}
                    </div>

                    {showSnack && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                                <h3 className="font-bold mb-4 text-lg text-gray-800 flex items-center"><Coffee className="mr-2 text-orange-500" /> Snack Empleado</h3>
                                <select className="w-full border p-3 rounded-lg mb-6 text-lg bg-white" onChange={e => setSnackEmp(e.target.value)} value={snackEmp}>
                                    <option value="">Seleccionar Empleado...</option>
                                    {employees.map(e => <option key={e.id || e.name} value={e.name}>{e.name}</option>)}
                                </select>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSnack(false)} className="flex-1 border p-3 rounded-xl font-bold text-gray-600">Cancelar</button>
                                    <button onClick={() => { if (snackEmp) { addDebt(snackEmp, 1); setShowSnack(false); setSnackEmp(''); } }} disabled={!snackEmp} className="flex-1 bg-orange-600 text-white p-3 rounded-xl font-bold shadow active:bg-orange-700 disabled:opacity-50">Confirmar ($25)</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAttendance && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                                <h3 className="font-bold mb-4 text-lg text-gray-800 flex items-center"><UserCheck className="mr-2 text-blue-500" /> Asistencia de Hoy</h3>
                                <div className="max-h-80 overflow-y-auto mb-4 space-y-2">
                                    {employees.map(e => (
                                        <div key={e.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <span className="font-medium text-lg">{e.name}</span>
                                            <button onClick={() => toggleAttendance(e.id, e.name, !e.active)} className={`px-4 py-2 rounded-lg font-bold shadow-sm transition-colors ${e.active ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`}>{e.active ? 'PRESENTE' : 'AUSENTE'}</button>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setShowAttendance(false)} className="w-full border p-3 rounded-xl font-bold text-gray-600 hover:bg-gray-50">Cerrar</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = () => {
            const { history, tickets, deductions } = useContext(AppContext);
            const allPaid = history.concat(tickets.filter(t => t.status === 'PAID'));
            return (
                <div className="p-4 h-full overflow-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex items-center"><CheckCircle className="w-4 h-4 mr-2 text-green-600" /> Tickets Pagados</div>
                        <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 font-bold text-gray-700 sticky top-0"><tr><th className="p-3">ID</th><th className="p-3">Hora</th><th className="p-3">Servicio</th><th className="p-3 text-right">Total</th></tr></thead>
                                <tbody>{allPaid.map(t => (<tr key={t.id} className="border-t hover:bg-gray-50"><td className="p-3 font-mono text-xs">#{t.id.slice(-4).toUpperCase()}</td><td className="p-3">{t.timestamp instanceof Date ? t.timestamp.toLocaleString('es-MX', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '...'}</td><td className="p-3"><div className="font-medium">{t.service.label}</div>{t.snackCount > 0 && <span className="text-xs text-orange-600 font-bold block">(+{t.snackCount} Snacks)</span>}</td><td className="p-3 font-bold text-green-600 text-right">{formatCurrency(t.price)}</td></tr>))}</tbody>
                            </table>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center"><span>Snacks Empleados</span><Coffee className="w-4 h-4 text-orange-500" /></div>
                        <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-orange-50 font-bold text-orange-800 sticky top-0"><tr><th className="p-3">Fecha</th><th className="p-3">Empleado</th><th className="p-3 text-right">Monto</th></tr></thead>
                                <tbody>
                                    {deductions.filter(d => d.amount > 0).map(d => (<tr key={d.id} className="border-t hover:bg-orange-50"><td className="p-3">{d.timestamp instanceof Date ? d.timestamp.toLocaleString('es-MX', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '...'}</td><td className="p-3 font-bold">{d.employee}</td><td className="p-3 font-bold text-red-500 text-right">-{formatCurrency(d.amount)}</td></tr>))}
                                    {deductions.filter(d => d.amount > 0).length === 0 && (<tr><td colSpan="3" className="p-4 text-center text-gray-400 italic">Sin registros recientes</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = () => {
            const { employees, history, deductions, db, exRate, setExRate, addEmployee, prices, commissions, extrasList, updatePricing, updateExtra } = useContext(AppContext);
            const [tab, setTab] = useState('NOMINA');
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setDate(d.getDate() - 7); return d.toISOString().split('T')[0]; });
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [newEmpName, setNewEmpName] = useState('');
            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));

            // Buffered State for Pricing Edit
            const [editPrices, setEditPrices] = useState({});
            const [editComms, setEditComms] = useState({});
            const [editExtras, setEditExtras] = useState([]);

            // Sync state when entering tab or when data loads
            useEffect(() => {
                if (tab === 'PRICES') {
                    setEditPrices(JSON.parse(JSON.stringify(prices)));
                    setEditComms(JSON.parse(JSON.stringify(commissions)));
                    setEditExtras(JSON.parse(JSON.stringify(extrasList)));
                }
            }, [tab, prices, commissions, extrasList]);

            const parseDate = (str) => { const [y, m, d] = str.split('-').map(Number); return new Date(y, m - 1, d); };
            const start = parseDate(startDate); start.setHours(0, 0, 0, 0);
            const end = parseDate(endDate); end.setHours(23, 59, 59, 999);
            const filterRange = (ts) => { if (!ts) return true; const date = ts.toDate ? ts.toDate() : new Date(ts); return date >= start && date <= end; };

            const rangeHistory = history.filter(t => t.status === 'PAID' && filterRange(t.timestamp));
            const rangeDeductions = deductions.filter(d => d.status === 'PENDING' && filterRange(d.timestamp));
            const payroll = calculatePayroll(employees, rangeHistory, rangeDeductions);

            // ... [printNomina, generateAttendanceReport, closeWeek, handleAddEmployee kept same] ...
            const printNomina = () => { const styles = `<style>body{font-family:sans-serif;padding:20px}.payslip{border:2px solid #333;padding:20px;margin-bottom:30px;page-break-inside:avoid;page-break-after:always}.header{text-align:center;border-bottom:2px solid #333;margin-bottom:15px;padding-bottom:10px}.emp-name{font-size:18px;font-weight:bold;margin-bottom:10px}table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:15px}th,td{border:1px solid #ccc;padding:6px 8px;text-align:left}th{background-color:#f2f2f2}.amount{text-align:right}.total-row{font-weight:bold;background-color:#eee}.signature{margin-top:40px;border-top:1px solid #000;padding-top:5px;text-align:center;width:60%;margin-left:auto;margin-right:auto}.net-pay{font-size:16px;font-weight:bold;text-align:right;margin-top:10px}.sub-header{font-weight:bold;margin-bottom:5px;font-size:13px}</style>`; let html = `<html><head><title>Nómina</title>${styles}</head><body>`; Object.keys(payroll).forEach(name => { const p = payroll[name]; if (p.count === 0 && p.deductionTotal === 0) return; html += `<div class="payslip"><div class="header"><h3>LAVAMEX - RECIBO DE NÓMINA</h3><div>Periodo: ${startDate} al ${endDate}</div></div><div class="emp-name">Empleado: ${name}</div><div class="sub-header">Detalle de Servicios</div><table><thead><tr><th style="width:30%">Fecha</th><th style="width:50%">Servicio</th><th style="width:20%" class="amount">Pago</th></tr></thead><tbody>`; p.details.forEach(det => { const dateStr = new Date(det.date).toLocaleDateString('es-MX', { weekday: 'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }); html += `<tr><td>${dateStr}</td><td>${det.service}</td><td class="amount">${formatCurrency(det.amount)}</td></tr>`; }); html += `<tr class="total-row"><td colspan="2" style="text-align:right">Subtotal Servicios:</td><td class="amount">${formatCurrency(p.total)}</td></tr>`; if (p.deductionTotal > 0) html += `<tr class="total-row" style="color:red;"><td colspan="2" style="text-align:right">Total Deducciones:</td><td class="amount">-${formatCurrency(p.deductionTotal)}</td></tr>`; html += `</tbody></table><div class="net-pay">TOTAL A PAGAR: ${formatCurrency(p.netPay)}</div><div class="signature">Firma de Recibido</div></div>`; }); html += `</body></html>`; const win = PrintService.open(); PrintService.print(win, html); };
            const generateAttendanceReport = async () => { const win = PrintService.open(); const q = query(collection(db, "attendance"), where("month", "==", reportMonth)); const snapshot = await getDocs(q); const attendanceData = {}; snapshot.forEach(doc => { attendanceData[doc.id] = doc.data().records; }); const daysInMonth = new Date(reportMonth.split('-')[0], reportMonth.split('-')[1], 0).getDate(); const days = Array.from({ length: daysInMonth }, (_, i) => i + 1); const tableRows = employees.map(emp => { const cells = days.map(day => { const dateStr = `${reportMonth}-${String(day).padStart(2, '0')}`; const status = attendanceData[dateStr]?.[emp.name]; return `<td style="text-align:center; padding: 2px;">${status ? '✔️' : ''}</td>`; }).join(''); return `<tr><td style="font-weight:bold; padding:4px;">${emp.name}</td>${cells}</tr>`; }).join(''); const headerRow = days.map(d => `<th style="width:20px;">${d}</th>`).join(''); const html = `<h2 style="text-align:center">Reporte de Asistencia: ${reportMonth}</h2><table style="width:100%; border-collapse: collapse; font-size: 10px;" border="1"><thead><tr><th>Empleado</th>${headerRow}</tr></thead><tbody>${tableRows}</tbody></table>`; PrintService.print(win, html, true); };
            const closeWeek = async () => { if (!confirm("¿Archivar semana? Esto limpiará la nómina actual.")) return; const batch = writeBatch(db); const pendingHistory = history.filter(t => t.status === 'PAID'); pendingHistory.forEach(t => batch.update(doc(db, "tickets", t.id), { status: 'ARCHIVED' })); deductions.filter(d => d.status === 'PENDING').forEach(d => batch.update(doc(db, "deductions", d.id), { status: 'ARCHIVED' })); await batch.commit(); alert("Semana Cerrada"); };
            const handleAddEmployee = () => { if (newEmpName.trim()) { addEmployee(newEmpName.trim()); setNewEmpName(''); } };

            const saveAllSettings = async () => {
                if (!confirm("¿Aplicar nuevos precios al sistema?")) return;
                try {
                    const batch = writeBatch(db);
                    // Overwrite full price/commission objects to ensure consistency
                    batch.set(doc(db, "settings", "prices"), editPrices);
                    batch.set(doc(db, "settings", "commissions"), editComms);

                    editExtras.forEach(e => {
                        // Use update for existing docs, assuming 'e.id' is valid
                        batch.update(doc(db, "extras", e.id), {
                            price: parseFloat(e.price) || 0,
                            commission: parseFloat(e.commission) || 0
                        });
                    });
                    await batch.commit();
                    alert("¡Precios Actualizados!");
                } catch (e) {
                    console.error(e);
                    alert("Error al guardar: " + e.message);
                }
            };

            const updateLocalPrice = (type, svcId, sizeId, val) => {
                const target = type === 'prices' ? editPrices : editComms;
                const setTarget = type === 'prices' ? setEditPrices : setEditComms;
                const newObj = { ...target };
                if (!newObj[svcId]) newObj[svcId] = {};
                newObj[svcId][sizeId] = parseFloat(val) || 0;
                setTarget(newObj);
            };

            const updateLocalExtra = (id, field, val) => {
                setEditExtras(prev => prev.map(e => e.id === id ? { ...e, [field]: val } : e));
            };

            return (
                <div className="p-4 md:p-6 h-full overflow-y-auto">
                    <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-1">
                        <button onClick={() => setTab('NOMINA')} className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === 'NOMINA' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>Nómina</button>
                        <button onClick={() => setTab('CONFIG')} className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === 'CONFIG' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>Configuración</button>
                        <button onClick={() => setTab('PRICES')} className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === 'PRICES' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>Precios</button>
                        <button onClick={() => setTab('REPORT')} className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === 'REPORT' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>Reportes</button>
                    </div>
                    {tab === 'NOMINA' && (
                        <div>
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100 gap-4">
                                <div className="flex flex-wrap gap-3 items-end">
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Inicio</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Fin</label><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                                    <button onClick={printNomina} className="bg-green-600 text-white px-5 py-2.5 rounded-lg font-bold shadow hover:bg-green-700 flex items-center"><Printer className="w-4 h-4 mr-2" /> PDF</button>
                                </div>
                                <button onClick={closeWeek} className="w-full md:w-auto bg-red-600 text-white px-5 py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 shadow hover:bg-red-700"><Archive className="w-4 h-4" /> CERRAR SEMANA</button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {Object.keys(payroll).map(name => (
                                    <div key={name} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-blue-500">
                                        <div className="font-bold text-xl text-gray-800 mb-1">{name}</div>
                                        <div className="text-3xl font-bold text-green-700">{formatCurrency(payroll[name].netPay)}</div>
                                        <div className="text-sm text-gray-500 mt-2 flex justify-between border-t pt-2"><span>Com: {formatCurrency(payroll[name].total)}</span><span className="text-red-500 font-medium">Ded: {formatCurrency(payroll[name].deductionTotal)}</span></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {tab === 'REPORT' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-lg mx-auto">
                            <h3 className="font-bold mb-4 text-gray-800 flex items-center"><Calendar className="mr-2" /> Reporte de Asistencia</h3>
                            <div className="mb-4"><label className="block text-sm font-bold text-gray-600 mb-2">Mes</label><input type="month" value={reportMonth} onChange={e => setReportMonth(e.target.value)} className="border p-3 rounded-lg w-full text-lg" /></div>
                            <button onClick={generateAttendanceReport} className="w-full bg-blue-600 text-white font-bold p-3 rounded-xl shadow hover:bg-blue-700">Imprimir Reporte Mensual</button>
                        </div>
                    )}
                    {tab === 'CONFIG' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-lg mx-auto">
                            <h3 className="font-bold mb-4 text-gray-800">General</h3>
                            <div className="mb-6"><label className="block text-sm font-bold text-gray-600 mb-2">Dólar (Rate)</label><input type="number" value={exRate} onChange={e => setExRate(parseFloat(e.target.value))} className="border p-3 rounded-lg w-full text-lg" /></div>
                            <h3 className="font-bold mb-4 border-t pt-4 text-gray-800">Empleados (Solo Admin)</h3>
                            <div className="flex gap-2 mb-4"><input value={newEmpName} onChange={(e) => setNewEmpName(e.target.value)} placeholder="Nombre Nuevo Empleado" className="border p-3 rounded-lg flex-1" /><button onClick={handleAddEmployee} className="bg-blue-600 text-white px-5 rounded-lg font-bold"><PlusCircle className="w-5 h-5" /></button></div>
                            <div className="space-y-2">{employees.map((e, i) => (<div key={e.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span className="font-medium">{e.name}</span><span className={`text-xs font-bold px-2 py-1 rounded ${e.active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{e.active ? 'Presente' : 'Ausente'}</span></div>))}</div>
                        </div>
                    )}
                    {tab === 'PRICES' && (
                        <div className="space-y-6">
                            <div className="bg-blue-50 border-blue-200 border p-4 rounded-xl flex justify-between items-center">
                                <div>
                                    <h3 className="font-bold text-blue-800">Edición de Precios</h3>
                                    <p className="text-sm text-blue-600">Edita los valores y guarda para aplicar.</p>
                                </div>
                                <button onClick={saveAllSettings} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 flex items-center gap-2 active:scale-95 transition-transform">
                                    <Upload className="w-5 h-5" /> GUARDAR CAMBIOS
                                </button>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                                <h3 className="font-bold mb-4 text-gray-800 text-lg">Matriz de Precios</h3>
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="p-3 border">Servicio</th>
                                            {SIZES.map(s => <th key={s.id} className="p-3 border">{s.label}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {SERVICES.map(svc => (
                                            <tr key={svc.id}>
                                                <td className="p-3 border font-medium">{svc.label}</td>
                                                {SIZES.map(size => (
                                                    <td key={size.id} className="p-2 border">
                                                        <div className="flex flex-col gap-1">
                                                            <input
                                                                type="number"
                                                                value={editPrices[svc.id]?.[size.id] || 0}
                                                                onChange={(e) => updateLocalPrice('prices', svc.id, size.id, e.target.value)}
                                                                className="border p-1 rounded w-full text-center text-green-700 font-bold"
                                                                placeholder="Precio"
                                                            />
                                                            <input
                                                                type="number"
                                                                value={editComms[svc.id]?.[size.id] || 0}
                                                                onChange={(e) => updateLocalPrice('commissions', svc.id, size.id, e.target.value)}
                                                                className="border p-1 rounded w-full text-center text-blue-600 text-xs"
                                                                placeholder="Comisión"
                                                            />
                                                        </div>
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <div className="text-xs text-gray-500 mt-2 text-right">* Arriba: Precio Público | Abajo: Comisión</div>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 className="font-bold mb-4 text-gray-800 text-lg">Extras</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {editExtras.map(extra => (
                                        <div key={extra.id} className="border p-3 rounded-lg bg-gray-50">
                                            <div className="font-bold mb-2">{extra.label}</div>
                                            <div className="flex gap-2">
                                                <div className="flex-1">
                                                    <label className="block text-xs font-bold text-gray-500">Precio</label>
                                                    <input
                                                        type="number"
                                                        value={extra.price}
                                                        onChange={(e) => updateLocalExtra(extra.id, 'price', e.target.value)}
                                                        className="w-full border p-1 rounded"
                                                    />
                                                </div>
                                                <div className="flex-1">
                                                    <label className="block text-xs font-bold text-gray-500">Comisión</label>
                                                    <input
                                                        type="number"
                                                        value={extra.commission}
                                                        onChange={(e) => updateLocalExtra(extra.id, 'commission', e.target.value)}
                                                        className="w-full border p-1 rounded"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ------------------------------------------------------------------
        // SECTION 9: MAIN LAYOUT (Uses Context)
        // ------------------------------------------------------------------

        const LavamexPOS = () => {
            const { role, view, setView, logout } = useContext(AppContext);

            if (view === 'TESTS') return <TestDashboard />;
            if (!role) return <LoginScreen />;

            return (
                <div className="h-screen flex flex-col bg-gray-100 font-sans">
                    <header className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md shrink-0 z-50">
                        <div className="flex items-center gap-2 font-bold text-lg md:text-xl truncate">
                            <Car className="text-blue-400 shrink-0" /> <span>LAVAMEX</span>
                            <span className="hidden sm:inline text-xs bg-gray-800 px-2 py-1 rounded font-normal text-gray-300 ml-2">{role}</span>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            <button onClick={() => setView('GREETER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'GREETER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><CheckCircle size={18} /> <span className="hidden sm:inline">Entrada</span></button>
                            {(role === 'CASHIER' || role === 'ADMIN') && (
                                <>
                                    <button onClick={() => setView('CASHIER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'CASHIER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Calculator size={18} /> <span className="hidden sm:inline">Caja</span></button>
                                    <button onClick={() => setView('HISTORY')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'HISTORY' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><History size={18} /> <span className="hidden sm:inline">Historial</span></button>
                                </>
                            )}
                            {role === 'ADMIN' && (
                                <button onClick={() => setView('ADMIN')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'ADMIN' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Settings size={18} /> <span className="hidden sm:inline">Admin</span></button>
                            )}
                            <button onClick={logout} className="bg-red-900/80 px-3 rounded ml-2 hover:bg-red-700 shrink-0"><LogOut size={18} /></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden relative">
                        {view === 'GREETER' && <GreeterView />}
                        {view === 'CASHIER' && <CashierView />}
                        {view === 'HISTORY' && <HistoryView />}
                        {view === 'ADMIN' && <AdminPanel />}
                    </main>
                </div>
            );
        };

        const App = () => (
            <AppProvider>
                <LavamexPOS />
            </AppProvider>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>