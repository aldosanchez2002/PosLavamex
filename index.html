<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lavamex POS</title>

    <!-- UTILITIES: Tailwind for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- COMPILER: Babel for in-browser JSX transformation (Dev only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- IMPORTS: ES Modules for React and Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>

    <style>
        /* Utility to hide scrollbars while maintaining functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ------------------------------------------------------------------
        // SECTION 1: IMPORTS & SETUP
        // ------------------------------------------------------------------
        import React, { useState, useEffect, useContext, createContext } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            User, DollarSign, Car, CheckCircle, FileText, Settings, Trash2,
            LogOut, Users, Calculator, Printer, Wifi, Lock, Archive, Pencil,
            PlusCircle, Coffee, History, ArrowLeft, Save, UserCheck, Activity,
            Database, PlayCircle, AlertTriangle, Upload, Loader2, Calendar, CreditCard
        } from 'lucide-react';

        import { initializeApp, getApps, getApp } from 'firebase/app';
        import {
            getFirestore, collection, addDoc, updateDoc, doc, onSnapshot,
            query, orderBy, serverTimestamp, writeBatch, setDoc, getDocs,
            where, deleteDoc
        } from 'firebase/firestore';

        // ------------------------------------------------------------------
        // SECTION 2: FIREBASE CONFIGURATION
        // ------------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyByIvJpBZv32Zd22fxlYWL9etzBa66Q2rE",
            authDomain: "poslavamex.firebaseapp.com",
            projectId: "poslavamex",
            storageBucket: "poslavamex.firebasestorage.app",
            messagingSenderId: "883264129",
            appId: "1:883264129:web:39a352e2ade3888b4f1b80"
        };

        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);

        // ------------------------------------------------------------------
        // SECTION 3: CONSTANTS & DEFAULTS
        // ------------------------------------------------------------------
        const SIZES = [
            { id: 'AUTO', label: 'Auto' },
            { id: 'SUV_CHICA', label: 'SUV Chica' },
            { id: 'PICKUP', label: 'Pick-Up / SUV MD' },
            { id: 'SUV_GDE', label: 'SUV Gde' }
        ];

        const SERVICES = [
            { id: 'GENERAL', label: 'Lavado General' },
            { id: 'WAX', label: 'Lavado + Cera' },
            { id: 'COMPLETE', label: 'Paquete Completo' },
            { id: 'PREMIUM', label: 'Paquete Premium' },
            { id: 'PRESIDENTIAL', label: 'Paquete Presidencial' }
        ];

        const DEFAULTS = {
            // Obfuscated PINs (Base64)
            PINS: {
                GREETER: 'MDAwMA==', // 0000
                CASHIER: 'MTIzNA==', // 1234
                ADMIN: 'OTk5OQ=='    // 9999
            },
            EXCHANGE_RATE: 18.10,
            SNACK_PRICE: 25,
            INITIAL_EMPLOYEES: [
                { name: 'Aldo', active: true },
                { name: 'Sergio', active: true },
                { name: 'Juan', active: true },
                { name: 'Rodrigo', active: true }
            ],
            PRICES: {
                GENERAL: { AUTO: 200, SUV_CHICA: 240, PICKUP: 360, SUV_GDE: 360 },
                WAX: { AUTO: 540, SUV_CHICA: 640, PICKUP: 820, SUV_GDE: 820 },
                COMPLETE: { AUTO: 840, SUV_CHICA: 1040, PICKUP: 1160, SUV_GDE: 1640 },
                PREMIUM: { AUTO: 1180, SUV_CHICA: 1440, PICKUP: 1620, SUV_GDE: 2100 },
                PRESIDENTIAL: { AUTO: 1540, SUV_CHICA: 1940, PICKUP: 2320, SUV_GDE: 2320 },
            },
            COMMISSIONS: {
                GENERAL: { AUTO: 70, SUV_CHICA: 84, PICKUP: 126, SUV_GDE: 126 },
                WAX: { AUTO: 189, SUV_CHICA: 224, PICKUP: 287, SUV_GDE: 287 },
                COMPLETE: { AUTO: 294, SUV_CHICA: 364, PICKUP: 406, SUV_GDE: 574 },
                PREMIUM: { AUTO: 413, SUV_CHICA: 504, PICKUP: 567, SUV_GDE: 735 },
                PRESIDENTIAL: { AUTO: 539, SUV_CHICA: 679, PICKUP: 812, SUV_GDE: 812 },
            },
            EXTRAS: [
                { id: 'MOTOR', label: 'Lavado Motor', price: 400, commission: 140 },
                { id: 'CHASIS', label: 'Chasis', price: 150, commission: 52.50 },
                { id: 'AROMA', label: 'Aroma', price: 30, commission: 10.50 },
                { id: 'BOLEADA', label: 'Boleada', price: 50, commission: 25 },
                { id: 'TAPICERIA', label: 'Limpieza Tapicería', price: 600, commission: 210 },
                { id: 'BABY_SEAT', label: 'Asiento de Bebé', price: 200, commission: 70 },
            ]
        };

        // ------------------------------------------------------------------
        // SECTION 4: HELPER FUNCTIONS (Business Logic)
        // ------------------------------------------------------------------
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        };

        const getLocalDateStr = (d = new Date()) => {
            // Manual YYYY-MM-DD construction to avoid TZ issues
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        };

        const calculateTicketTotals = (serviceId, sizeId, extraList, prices, commissions, snackCount = 0, currentSnackPrice = 25) => {
            const basePrice = (serviceId && sizeId && prices[serviceId]?.[sizeId]) || 0;
            const baseComm = (serviceId && sizeId && commissions[serviceId]?.[sizeId]) || 0;
            const extrasPrice = extraList.reduce((a, b) => a + b.price, 0);
            const extrasComm = extraList.reduce((a, b) => a + b.commission, 0);
            const snackCost = snackCount * currentSnackPrice;

            return {
                basePrice,
                totalPrice: basePrice + extrasPrice + snackCost,
                totalCommission: baseComm + extrasComm
            };
        };

        const calculatePayroll = (employees, history, deductions) => {
            const payroll = {};

            // Initialize structure
            employees.forEach(emp => {
                // Initialize Grid (Service x Size)
                const serviceGrid = {};
                SERVICES.forEach(svc => {
                    serviceGrid[svc.id] = {};
                    SIZES.forEach(sz => serviceGrid[svc.id][sz.id] = 0);
                });

                payroll[emp.name] = {
                    count: 0,
                    total: 0,
                    serviceGrid,
                    earningsBreakdown: {}, // Key: "Label", Value: { count, total }
                    deductionTotal: 0,
                    deductionDetails: [],
                    netPay: 0
                };
            });

            // Process History
            history.forEach(item => {
                const washersList = item.washers || (item.washer ? [item.washer] : []);
                if (washersList.length === 0) return;

                const washerCount = washersList.length;

                // 1. Calculate Extras Commission Share
                let extrasCommissionTotal = 0;
                const extrasShares = (item.extras || []).map(ex => {
                    const share = (ex.commission || 0) / washerCount;
                    extrasCommissionTotal += (ex.commission || 0);
                    return { label: ex.label, share };
                });

                // 2. Calculate Base Service Commission Share
                const totalStoredCommission = item.commission || 0;
                const baseCommissionTotal = totalStoredCommission - extrasCommissionTotal;
                const baseShare = baseCommissionTotal / washerCount;

                washersList.forEach(washerName => {
                    if (!payroll[washerName]) return; // Skip if employee deleted

                    const p = payroll[washerName];
                    p.count += 1;
                    p.total += (totalStoredCommission / washerCount);

                    // A. Update Matrix Grid (Counts only)
                    if (item.service && item.size) {
                        p.serviceGrid[item.service.id][item.size.id] = (p.serviceGrid[item.service.id][item.size.id] || 0) + 1;
                    }

                    // B. Update Breakdown (Not strictly needed for grid but good for debug)
                    // ... (omitted for brevity as we removed the detailed list from print)
                });
            });

            // Process Deductions
            deductions.forEach(d => {
                if (payroll[d.employee]) {
                    payroll[d.employee].deductionTotal += d.amount;
                    payroll[d.employee].deductionDetails.push({
                        date: d.timestamp, desc: d.description, amount: d.amount
                    });
                }
            });

            // Calculate Net Pay
            Object.keys(payroll).forEach(key => {
                payroll[key].netPay = payroll[key].total - payroll[key].deductionTotal;
            });

            return payroll;
        };

        const validatePin = (input) => {
            try {
                const encoded = btoa(input);
                if (encoded === DEFAULTS.PINS.GREETER) return 'GREETER';
                if (encoded === DEFAULTS.PINS.CASHIER) return 'CASHIER';
                if (encoded === DEFAULTS.PINS.ADMIN) return 'ADMIN';
            } catch (e) {
                return null;
            }
            return null;
        };

        const calculateChange = (mxn, usd, rate, totalCost) => {
            const mxnVal = parseFloat(mxn) || 0;
            const usdVal = parseFloat(usd) || 0;
            const totalGiven = mxnVal + (usdVal * rate);
            return totalGiven - totalCost;
        };

        const toggleSelection = (list, item, limit = null) => {
            const isObj = typeof item !== 'string';
            const exists = isObj ? list.some(x => x.id === item.id) : list.includes(item);

            if (!exists && limit && list.length >= limit) return list;

            return exists
                ? list.filter(x => isObj ? x.id !== item.id : x !== item)
                : [...list, item];
        };

        // ------------------------------------------------------------------
        // SECTION 5: PRINTING SERVICE
        // ------------------------------------------------------------------
        const PrintService = {
            open: () => {
                const win = window.open('', '', 'height=600,width=800');
                if (win) {
                    win.document.write('<html><body style="font-family:sans-serif; text-align:center; padding-top:50px;"><h3>Generando Ticket...</h3></body></html>');
                } else {
                    alert("Popups blocked. Please allow popups for this site.");
                }
                return win;
            },
            print: (win, content, landscape = false) => {
                if (!win) return;
                const orientation = landscape ? '@page { size: landscape; }' : '';
                win.document.open();
                win.document.write(`
                    <html>
                        <head>
                            <title>Print</title>
                            <style>
                                ${orientation} 
                                body{font-family:'Courier New', sans-serif;font-size:12px;margin:0;padding:5px;}
                            </style>
                        </head>
                        <body>${content}</body>
                    </html>
                `);
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 500);
            },
            getJobTicketHtml: (ticket, shortId) => {
                const washers = ticket.washers ? ticket.washers.join(', ') : ticket.washer;
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? `<div style="text-align:center;font-size:12px; margin-top:5px; font-weight:bold;">+ ${ticket.extras.map(e => e.label).join('<br>+ ')}</div>`
                    : '';
                return `
                    <div style="width:58mm; text-align:center; font-weight:bold;">LAVAMEX - ORDEN</div>
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>TICKET:</span><b>#${shortId}</b></div>
                    <div style="text-align:center; font-weight:bold; font-size:16px; margin:10px 0; width:58mm;">${washers}</div>
                    <div style="text-align:center; font-weight:bold; font-size:14px; width:58mm;">${ticket.size ? ticket.size.label : ''}<br>${ticket.service ? ticket.service.label : 'Extras Only'}</div>
                    <div style="width:58mm;">${extrasHtml}</div>
                    ${ticket.vehicleDesc ? `<div style="text-align:center; width:58mm;">(${ticket.vehicleDesc})</div>` : ''}
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="text-align:center; width:58mm;">.. TABLERO ..</div>
                `;
            },
            getReceiptHtml: (ticket, payment, shortId, currentSnackPrice) => {
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? `<div style="font-size:10px;">${ticket.extras.map(e => `<div style="display:flex;justify-content:space-between;"><span>+ ${e.label}</span><span>${formatCurrency(e.price)}</span></div>`).join('')}</div>`
                    : '';
                const displayBasePrice = ticket.basePrice || 0;
                const method = payment.method === 'CARD' ? 'TARJETA' : 'EFECTIVO';
                // Use stored snack price if available on ticket (for history), else current
                const effSnackPrice = currentSnackPrice || 25;

                return `
                    <div style="width:58mm; text-align:center; font-weight:bold;">LAVAMEX</div>
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>Ticket:</span><span>#${shortId}</span></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>Fecha:</span><span>${new Date().toLocaleDateString()}</span></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>Metodo:</span><span>${method}</span></div>
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm;"><span>${ticket.service ? ticket.service.label : 'Servicio General'}</span><span>${formatCurrency(displayBasePrice)}</span></div>
                    <div style="width:58mm;">${extrasHtml}</div>
                    ${ticket.snackCount > 0 ? `<div style="display:flex; justify-content:space-between; width:58mm;"><span>+ Snacks (${ticket.snackCount})</span><span>${formatCurrency(ticket.snackCount * effSnackPrice)}</span></div>` : ''}
                    <div style="width:58mm; border-top:1px dashed #000; margin:5px 0;"></div>
                    <div style="display:flex; justify-content:space-between; width:58mm; font-weight:bold;"><span>TOTAL:</span><span>${formatCurrency(ticket.price)}</span></div>
                    ${payment.method === 'CARD' ?
                        `<div style="text-align:center; margin-top:5px; font-style:italic;">Cargo a Tarjeta</div>` :
                        `<div style="display:flex; justify-content:space-between; width:58mm;"><span>Recibido:</span><span>${formatCurrency(payment.mxn + (payment.usd * payment.rate))}</span></div>
                         <div style="display:flex; justify-content:space-between; width:58mm;"><span>Cambio:</span><span>${formatCurrency(payment.change)}</span></div>`
                    }
                    <div style="text-align:center; margin-top:10px; width:58mm;">¡Gracias!</div>
                `;
            }
        };

        // ------------------------------------------------------------------
        // SECTION 6: UNIT TESTS (Brief)
        // ------------------------------------------------------------------
        const TestRunner = {
            runDbTest: async () => {
                try {
                    const ref = await addDoc(collection(db, "_diagnostics"), { t: serverTimestamp() });
                    await deleteDoc(doc(db, "_diagnostics", ref.id));
                    return { passed: true, details: 'Write/Read/Delete Successful' };
                } catch (e) { return { passed: false, details: e.message }; }
            }
        };

        // ------------------------------------------------------------------
        // SECTION 7: CONTEXT & PROVIDER
        // ------------------------------------------------------------------
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [role, setRole] = useState(() => localStorage.getItem('lavamex_role') || null);
            const [view, setView] = useState('GREETER');
            const [employees, setEmployees] = useState([]);
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [deductions, setDeductions] = useState([]);
            const [editingTicket, setEditingTicket] = useState(null);

            // Global settings
            const [exRate, setExRate] = useState(DEFAULTS.EXCHANGE_RATE);
            const [snackPrice, setSnackPrice] = useState(DEFAULTS.SNACK_PRICE);
            const [prices, setPrices] = useState({});
            const [commissions, setCommissions] = useState({});
            const [extrasList, setExtrasList] = useState([]);

            // UI State
            const [payment, setPayment] = useState({ mxn: '', usd: '' });
            const [activeId, setActiveId] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Auth Logic
            const login = (r) => {
                setRole(r);
                localStorage.setItem('lavamex_role', r);
                if (r) setView(r === 'ADMIN' ? 'ADMIN' : (r === 'CASHIER' ? 'CASHIER' : 'GREETER'));
            };

            const logout = () => {
                setRole(null);
                localStorage.removeItem('lavamex_role');
                setView('GREETER');
            };

            // --- FIREBASE LISTENERS ---

            // 1. Employees
            useEffect(() => {
                const unsub = onSnapshot(query(collection(db, "employees"), orderBy("name")), (snap) => {
                    if (snap.empty && employees.length === 0) {
                        DEFAULTS.INITIAL_EMPLOYEES.forEach(e => addDoc(collection(db, "employees"), e));
                    }
                    setEmployees(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => unsub();
            }, []);

            // 2. Settings (Prices, Commissions, Extras, General)
            useEffect(() => {
                // Prices
                const unsubP = onSnapshot(doc(db, "settings", "prices"), (docSnap) => {
                    if (docSnap.exists()) setPrices(docSnap.data());
                    else setDoc(doc(db, "settings", "prices"), DEFAULTS.PRICES);
                });

                // Commissions
                const unsubC = onSnapshot(doc(db, "settings", "commissions"), (docSnap) => {
                    if (docSnap.exists()) setCommissions(docSnap.data());
                    else setDoc(doc(db, "settings", "commissions"), DEFAULTS.COMMISSIONS);
                });

                // Extras List
                const unsubE = onSnapshot(collection(db, "extras"), (snap) => {
                    if (snap.empty) {
                        DEFAULTS.EXTRAS.forEach(e => addDoc(collection(db, "extras"), e));
                    } else {
                        setExtrasList(snap.docs.map(d => ({ ...d.data(), docId: d.id })));
                    }
                });

                // General Settings (Exchange Rate & Snack Price)
                const unsubG = onSnapshot(doc(db, "settings", "general"), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.exchangeRate) setExRate(data.exchangeRate);
                        if (data.snackPrice) setSnackPrice(data.snackPrice);
                    } else {
                        // Create defaults if missing
                        setDoc(doc(db, "settings", "general"), {
                            exchangeRate: DEFAULTS.EXCHANGE_RATE,
                            snackPrice: DEFAULTS.SNACK_PRICE
                        });
                    }
                });

                return () => { unsubP(); unsubC(); unsubE(); unsubG(); };
            }, []);

            // 3. Tickets & Deductions
            useEffect(() => {
                const qT = query(collection(db, "tickets"), orderBy("timestamp", "desc"));
                const unsubT = onSnapshot(qT, (snap) => {
                    const active = [], hist = [];
                    snap.forEach(d => {
                        const dat = {
                            id: d.id, ...d.data(),
                            timestamp: d.data().timestamp?.toDate() || new Date()
                        };
                        if (dat.status === 'PENDING') active.push(dat);
                        else hist.push(dat);
                    });
                    setTickets(active);
                    setHistory(hist);
                });

                const unsubD = onSnapshot(collection(db, "deductions"), (snap) => {
                    setDeductions(snap.docs.map(d => {
                        const data = d.data();
                        return {
                            id: d.id, ...data,
                            timestamp: data.timestamp?.toDate
                                ? data.timestamp.toDate()
                                : (data.timestamp || new Date())
                        };
                    }));
                });
                return () => { unsubT(); unsubD(); };
            }, []);

            // --- ACTIONS ---

            const updateGlobalSettings = async (newRate, newSnackPrice) => {
                try {
                    await setDoc(doc(db, "settings", "general"), {
                        exchangeRate: newRate,
                        snackPrice: newSnackPrice
                    }, { merge: true });
                } catch (e) {
                    alert("Error updating settings: " + e.message);
                }
            };

            const saveTicket = async (data) => {
                if (isSubmitting) return;
                setIsSubmitting(true);
                try {
                    const snacks = editingTicket ? (editingTicket.snackCount || 0) : 0;
                    const serviceId = data.service ? data.service.id : null;
                    const sizeId = data.size ? data.size.id : null;
                    const totals = calculateTicketTotals(serviceId, sizeId, data.extras, prices, commissions, snacks, snackPrice);

                    const ticketData = {
                        ...data,
                        price: totals.totalPrice,
                        commission: totals.totalCommission,
                        basePrice: totals.basePrice,
                        snackCount: snacks,
                        status: 'PENDING',
                        timestamp: serverTimestamp()
                    };

                    if (editingTicket) {
                        await updateDoc(doc(db, "tickets", editingTicket.id), ticketData);
                        setEditingTicket(null);
                        if (role === 'CASHIER') setView('CASHIER');
                    } else {
                        const win = PrintService.open();
                        const ref = await addDoc(collection(db, "tickets"), ticketData);
                        if (win) {
                            const html = PrintService.getJobTicketHtml(
                                { ...ticketData, timestamp: new Date() },
                                ref.id.slice(-4).toUpperCase()
                            );
                            PrintService.print(win, html);
                        }
                    }
                } catch (e) {
                    alert("Error saving ticket: " + e.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const updateSnacks = async (id, count) => {
                try {
                    const t = tickets.find(x => x.id === id); if (!t) return;
                    const newCount = Math.max(0, count);
                    const totals = calculateTicketTotals(t.service.id, t.size.id, t.extras || [], prices, commissions, newCount, snackPrice);
                    await updateDoc(doc(db, "tickets", id), { snackCount: newCount, price: totals.totalPrice });
                } catch (e) { alert("Error updating snacks: " + e.message); }
            };

            const toggleAttendance = async (empId, empName, isActive) => {
                try {
                    await updateDoc(doc(db, "employees", empId), { active: isActive });
                    const dateKey = getLocalDateStr();
                    const monthKey = dateKey.slice(0, 7);
                    await setDoc(doc(db, "attendance", dateKey), {
                        date: dateKey, month: monthKey, records: { [empName]: isActive }
                    }, { merge: true });
                } catch (e) { alert("Error toggling attendance: " + e.message); }
            };

            const addEmployee = async (name) => {
                try {
                    await addDoc(collection(db, "employees"), { name, active: true });
                } catch (e) { alert("Error adding employee: " + e.message); }
            };

            const deleteTicket = async (id) => {
                if (confirm("¿Seguro que deseas borrar este ticket?")) {
                    try {
                        await updateDoc(doc(db, "tickets", id), { status: 'CANCELLED' });
                    } catch (e) { alert("Error deleting ticket: " + e.message); }
                }
            };

            const addDebt = async (e, c) => {
                try {
                    await addDoc(collection(db, "deductions"), {
                        employee: e, amount: c * snackPrice,
                        status: 'PENDING', timestamp: serverTimestamp()
                    });
                } catch (err) { alert("Error adding snack debt: " + err.message); }
            };

            const startEdit = (ticket) => { setEditingTicket(ticket); setView('GREETER'); };
            const cancelEdit = () => { setEditingTicket(null); if (role === 'CASHIER') setView('CASHIER'); };

            const processPayment = async () => {
                if (isSubmitting) return;
                const t = tickets.find(x => x.id === activeId); if (!t) return;
                const total = (parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate);
                if (total < t.price) return alert("Falta dinero");

                setIsSubmitting(true);
                try {
                    const win = PrintService.open();
                    const details = {
                        mxn: parseFloat(payment.mxn) || 0,
                        usd: parseFloat(payment.usd) || 0,
                        rate: exRate,
                        change: total - t.price,
                        method: 'CASH'
                    };
                    await updateDoc(doc(db, "tickets", t.id), {
                        status: 'PAID', paidAt: serverTimestamp(), paymentDetails: details
                    });

                    if (win) {
                        const html = PrintService.getReceiptHtml(t, details, t.id.slice(-4).toUpperCase(), snackPrice);
                        PrintService.print(win, html);
                    }
                    setActiveId(null); setPayment({ mxn: '', usd: '' });
                } catch (e) {
                    alert("Error processing payment: " + e.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const processCardPayment = async () => {
                if (isSubmitting) return;
                const t = tickets.find(x => x.id === activeId); if (!t) return;

                setIsSubmitting(true);
                try {
                    const win = PrintService.open();
                    const details = {
                        mxn: t.price,
                        usd: 0,
                        rate: exRate,
                        change: 0,
                        method: 'CARD'
                    };
                    await updateDoc(doc(db, "tickets", t.id), {
                        status: 'PAID', paidAt: serverTimestamp(), paymentDetails: details
                    });

                    if (win) {
                        const html = PrintService.getReceiptHtml(t, details, t.id.slice(-4).toUpperCase(), snackPrice);
                        PrintService.print(win, html);
                    }
                    setActiveId(null); setPayment({ mxn: '', usd: '' });
                } catch (e) {
                    alert("Error processing payment: " + e.message);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const value = {
                role, login, logout,
                view, setView,
                employees, tickets, history, deductions,
                prices, commissions, extrasList,
                exRate, snackPrice, updateGlobalSettings,
                editingTicket, startEdit, cancelEdit,
                activeId, setActiveId,
                payment, setPayment,
                saveTicket, updateSnacks, toggleAttendance, addEmployee, deleteTicket, addDebt, processPayment, processCardPayment,
                db, isSubmitting
            };

            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        };

        // ------------------------------------------------------------------
        // SECTION 8: COMPONENTS
        // ------------------------------------------------------------------

        const LoginScreen = () => {
            const { login } = useContext(AppContext);
            const [pin, setPin] = useState('');

            const handleLogin = () => {
                const role = validatePin(pin);
                if (role) login(role);
                else { alert('PIN Incorrecto'); setPin(''); }
            };

            return (
                <div className="flex h-screen bg-gray-900 justify-center items-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                        <h1 className="text-3xl font-bold mb-6 text-gray-800">LAVAMEX POS</h1>
                        <div className="flex flex-col gap-4">
                            <input
                                type="password" inputMode="numeric"
                                value={pin} onChange={e => setPin(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && handleLogin()}
                                placeholder="PIN"
                                className="w-full p-4 border rounded-lg text-center text-3xl tracking-widest mb-2"
                                autoFocus
                            />
                            <button onClick={handleLogin} className="w-full p-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition-transform text-lg">ENTRAR</button>
                        </div>
                    </div>
                </div>
            );
        };

        const GreeterView = () => {
            const { employees, saveTicket, editingTicket, cancelEdit, prices, extrasList, isSubmitting } = useContext(AppContext);
            const [size, setSize] = useState(null);
            const [service, setService] = useState(null);
            const [washers, setWashers] = useState([]);
            const [extras, setExtras] = useState([]);
            const [desc, setDesc] = useState('');
            const [vDesc, setVDesc] = useState('');
            const [vPrice, setVPrice] = useState('');

            useEffect(() => {
                if (editingTicket) {
                    setSize(editingTicket.size);
                    setService(editingTicket.service);
                    setWashers(editingTicket.washers || (editingTicket.washer ? [editingTicket.washer] : []));
                    setExtras(editingTicket.extras || []);
                    setDesc(editingTicket.vehicleDesc || '');
                } else {
                    setSize(null); setService(null); setWashers([]); setExtras([]); setDesc('');
                }
            }, [editingTicket]);

            const toggle = (item) => setWashers(prev => toggleSelection(prev, item, 2));
            const toggleExtra = (item) => setExtras(prev => toggleSelection(prev, item));

            const addExtra = (item) => setExtras(prev => [...prev, item]);
            const removeExtra = (item) => setExtras(prev => {
                const idx = prev.findIndex(x => x.id === item.id);
                if (idx === -1) return prev;
                const newArr = [...prev];
                newArr.splice(idx, 1);
                return newArr;
            });

            const addVarios = () => {
                const price = parseFloat(vPrice);
                if (!vDesc || !price || price <= 0) return alert("Ingrese una descripción y un precio válido.");
                const newItem = { id: `VARIOS-${Date.now()}`, label: vDesc, price: price, commission: 0 };
                setExtras(prev => [...prev, newItem]);
                setVDesc(''); setVPrice('');
            };

            const hasBoleada = extras.some(e => e.id === 'BOLEADA');
            const hasVarios = extras.some(e => e.id.startsWith('VARIOS'));
            const canSubmit = washers.length > 0 && ((size && service) || hasBoleada || hasVarios);

            const handleSubmit = () => {
                if (!canSubmit) return;
                saveTicket({ size, service, washers, extras, desc });
                if (!editingTicket) { setSize(null); setService(null); setWashers([]); setExtras([]); setDesc(''); }
            };

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    {editingTicket && (
                        <div className="bg-yellow-200 p-3 text-center font-bold text-yellow-900 flex justify-between items-center px-4 shadow-sm z-10 shrink-0">
                            <span className="flex items-center gap-2 text-sm"><Pencil className="w-4 h-4" /> EDITANDO #{editingTicket.id.slice(-4).toUpperCase()}</span>
                            <button onClick={cancelEdit} className="bg-white px-3 py-1 rounded text-xs hover:bg-yellow-50 border border-yellow-300">Cancelar</button>
                        </div>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 flex-1 overflow-y-auto">
                        {/* Column 1: Sizes */}
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><Car className="w-5 h-5 mr-2" /> 1. Tamaño</h3>
                            <div className="space-y-2">
                                {SIZES.map(s => (
                                    <button key={s.id} onClick={() => setSize(s)}
                                        className={`w-full p-4 text-left rounded-lg border-2 transition-all ${size?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 hover:bg-gray-50'}`}>
                                        {s.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Column 2: Services & Extras */}
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><FileText className="w-5 h-5 mr-2" /> 2. Servicio</h3>
                            <div className="space-y-2 mb-4">
                                {SERVICES.map(s => {
                                    const price = size && prices[s.id] ? prices[s.id][size.id] : null;
                                    return (
                                        <button key={s.id} disabled={!size} onClick={() => setService(s)}
                                            className={`w-full p-3 text-left rounded-lg border-2 flex justify-between items-center transition-all ${service?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 opacity-90 hover:bg-gray-50'}`}>
                                            <span>{s.label}</span>
                                            {price !== null && <span className="bg-white px-2 py-1 rounded text-sm shadow-sm border">${price}</span>}
                                        </button>
                                    );
                                })}
                            </div>

                            <h3 className="font-bold mb-2 text-gray-700 text-sm">Extras</h3>
                            <div className="grid grid-cols-1 gap-2">
                                {extrasList.map(e => {
                                    if (e.id === 'BOLEADA') {
                                        const count = extras.filter(x => x.id === e.id).length;
                                        return (
                                            <div key={e.id} className={`w-full p-2 rounded-lg border text-sm flex justify-between items-center transition-all ${count > 0 ? 'bg-indigo-50 border-indigo-600 font-bold text-indigo-800' : 'border-gray-200 hover:bg-gray-50'}`}>
                                                <span className="flex-1">{e.label} (+${e.price})</span>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => removeExtra(e)} disabled={count === 0} className="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded-full font-bold">-</button>
                                                    <span className="w-6 text-center font-bold">{count}</span>
                                                    <button onClick={() => addExtra(e)} className="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded-full font-bold">+</button>
                                                </div>
                                            </div>
                                        );
                                    }
                                    return (
                                        <button key={e.id} onClick={() => toggleExtra(e)} className={`w-full p-3 rounded-lg border text-sm flex justify-between items-center transition-all ${extras.some(x => x.id === e.id) ? 'bg-indigo-50 border-indigo-600 font-bold text-indigo-800' : 'border-gray-200 hover:bg-gray-50'}`}>
                                            <span>{e.label}</span><span>+${e.price}</span>
                                        </button>
                                    );
                                })}
                            </div>

                            <div className="mt-4 border-t pt-2">
                                <h3 className="font-bold mb-2 text-gray-700 text-sm">Varios / Extra</h3>
                                <div className="flex gap-2 mb-2">
                                    <input value={vDesc} onChange={e => setVDesc(e.target.value)} placeholder="Descripción" className="w-full p-2 border rounded text-sm" />
                                    <input type="number" value={vPrice} onChange={e => setVPrice(e.target.value)} placeholder="$" className="w-20 p-2 border rounded text-sm" />
                                    <button onClick={addVarios} className="bg-blue-600 text-white p-2 rounded"><PlusCircle size={16} /></button>
                                </div>
                                {extras.filter(e => e.id.startsWith('VARIOS')).map(e => (
                                    <div key={e.id} className="flex justify-between items-center text-sm p-2 bg-gray-50 border rounded mb-1">
                                        <span>{e.label}</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold">${e.price}</span>
                                            <button onClick={() => setExtras(prev => prev.filter(x => x.id !== e.id))} className="text-red-500"><Trash2 size={14} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Column 3 & 4: Washers & Action */}
                        <div className="md:col-span-2 bg-white p-4 rounded-xl shadow border flex flex-col h-full">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><User className="w-5 h-5 mr-2" /> 3. Lavadores ({washers.length}/2)</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                                {employees.filter(e => e.active).map(e => (
                                    <button key={e.name} onClick={() => toggle(e.name)}
                                        className={`p-4 rounded-lg border-2 text-center font-medium transition-all ${washers.includes(e.name) ? 'bg-green-100 border-green-600 text-green-800 shadow-inner' : 'border-gray-200 hover:bg-gray-50'}`}>
                                        {e.name}
                                    </button>
                                ))}
                            </div>
                            <div className="mt-auto pt-4 border-t">
                                <input value={desc} onChange={e => setDesc(e.target.value)} placeholder="Descripción (Opcional)" className="w-full p-3 border rounded-lg mb-4 text-lg" />
                                <button onClick={handleSubmit} disabled={!canSubmit || isSubmitting}
                                    className={`w-full py-5 rounded-xl font-bold text-white text-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform ${!canSubmit || isSubmitting ? 'bg-gray-300' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                    {isSubmitting ? <Loader2 className="animate-spin" /> : (editingTicket ? <><Save className="w-6 h-6" /> GUARDAR</> : <><Printer className="w-6 h-6" /> CREAR ORDEN</>)}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CashierView = () => {
            const { tickets, activeId, setActiveId, payment, setPayment, processPayment, processCardPayment, deleteTicket, startEdit, updateSnacks, addDebt, employees, exRate, toggleAttendance, isSubmitting, role, snackPrice } = useContext(AppContext);
            const t = tickets.find(x => x.id === activeId);
            const [showSnack, setShowSnack] = useState(false);
            const [showAttendance, setShowAttendance] = useState(false);
            const [snackEmp, setSnackEmp] = useState('');

            return (
                <div className="flex flex-col md:flex-row h-full gap-4 p-4 overflow-hidden">
                    {/* Ticket List */}
                    <div className="w-full md:w-1/3 bg-white rounded-xl shadow border overflow-hidden flex flex-col h-1/3 md:h-full shrink-0">
                        <div className="p-3 bg-gray-50 font-bold border-b flex justify-between items-center shrink-0">
                            <span className="text-gray-700">Tickets ({tickets.length})</span>
                            <div className="flex gap-1">
                                <button onClick={() => setShowAttendance(true)} className="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold border border-blue-200 active:bg-blue-200">Asistencia</button>
                                <button onClick={() => setShowSnack(true)} className="text-xs bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-bold border border-orange-200 active:bg-orange-200">Snack</button>
                            </div>
                        </div>
                        <div className="overflow-y-auto flex-1 p-2 space-y-2">
                            {tickets.map(ticket => (
                                <div key={ticket.id} onClick={() => setActiveId(ticket.id)} className={`p-4 rounded-lg border cursor-pointer transition-all ${activeId === ticket.id ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50'}`}>
                                    <div className="flex justify-between font-bold text-gray-800"><span>#{ticket.id.slice(-4).toUpperCase()}</span><span>{formatCurrency(ticket.price)}</span></div>
                                    <div className="text-sm text-gray-600 mt-1">{ticket.service?.label || 'Extras'} <span className="bg-gray-200 px-1.5 rounded text-xs">{ticket.size?.label || '-'}</span></div>
                                    {ticket.vehicleDesc && <div className="text-xs text-blue-600 italic mt-1">{ticket.vehicleDesc}</div>}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Payment Panel */}
                    <div className="flex-1 bg-white rounded-xl shadow border p-4 md:p-6 flex flex-col items-center justify-center h-2/3 md:h-full overflow-y-auto">
                        {t ? (
                            <div className="w-full max-w-md">
                                <h2 className="text-4xl font-bold text-center mb-2 text-gray-800">{formatCurrency(t.price)}</h2>
                                <p className="text-center text-gray-500 mb-6 font-medium">{t.vehicleDesc} • {t.washers?.join(', ')}</p>

                                <div className="flex justify-center items-center gap-3 mb-6 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                    <span className="font-bold text-sm text-orange-800 uppercase tracking-wide">Snacks Cliente</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) - 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl shadow-sm text-gray-600">-</button>
                                    <span className="font-bold text-xl w-8 text-center">{t.snackCount || 0}</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) + 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl shadow-sm text-green-600">+</button>
                                </div>

                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div><label className="text-xs font-bold text-gray-500 mb-1 block">MXN</label><input type="number" inputMode="decimal" value={payment.mxn} onChange={e => setPayment({ ...payment, mxn: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" /></div>
                                    <div><label className="text-xs font-bold text-gray-500 mb-1 block">USD (Rate: {exRate})</label><input type="number" inputMode="decimal" value={payment.usd} onChange={e => setPayment({ ...payment, usd: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" /></div>
                                </div>

                                <div className="text-center font-bold mb-6 text-xl bg-gray-50 p-3 rounded-lg border">
                                    Cambio: <span className={calculateChange(payment.mxn, payment.usd, exRate, t.price) < 0 ? 'text-red-500' : 'text-green-600'}>
                                        {formatCurrency(calculateChange(payment.mxn, payment.usd, exRate, t.price))}
                                    </span>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => deleteTicket(t.id)} className="p-4 border border-red-200 text-red-500 rounded-xl hover:bg-red-50" title="Borrar"><Trash2 className="w-6 h-6" /></button>
                                    <button onClick={() => startEdit(t)} className="p-4 border border-yellow-200 text-yellow-600 rounded-xl bg-yellow-50 hover:bg-yellow-100" title="Editar"><Pencil className="w-6 h-6" /></button>
                                    <button onClick={processPayment} disabled={isSubmitting} className="flex-1 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-lg flex justify-center items-center gap-2">{isSubmitting ? <Loader2 className="animate-spin" /> : <><Printer className="w-6 h-6" /> COBRAR</>}</button>
                                    {role === 'CASHIER' && <button onClick={processCardPayment} disabled={isSubmitting} className="p-4 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg" title="Cobro Tarjeta">{isSubmitting ? <Loader2 className="animate-spin" /> : <CreditCard className="w-6 h-6" />}</button>}
                                </div>
                            </div>
                        ) : <div className="text-gray-400 flex flex-col items-center"><LogOut className="w-16 h-16 opacity-20 mb-2" />Selecciona un ticket</div>}
                    </div>

                    {/* Snack Modal */}
                    {showSnack && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                                <h3 className="font-bold mb-4 text-lg text-gray-800 flex items-center"><Coffee className="mr-2 text-orange-500" /> Snack Empleado (${snackPrice})</h3>
                                <select className="w-full border p-3 rounded-lg mb-6 text-lg bg-white" onChange={e => setSnackEmp(e.target.value)} value={snackEmp}>
                                    <option value="">Seleccionar Empleado...</option>
                                    {employees.map(e => <option key={e.id || e.name} value={e.name}>{e.name}</option>)}
                                </select>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSnack(false)} className="flex-1 border p-3 rounded-xl font-bold text-gray-600">Cancelar</button>
                                    <button onClick={() => { if (snackEmp) { addDebt(snackEmp, 1); setShowSnack(false); setSnackEmp(''); } }} disabled={!snackEmp} className="flex-1 bg-orange-600 text-white p-3 rounded-xl font-bold">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Attendance Modal */}
                    {showAttendance && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                                <h3 className="font-bold mb-4 text-lg text-gray-800 flex items-center"><UserCheck className="mr-2 text-blue-500" /> Asistencia</h3>
                                <div className="max-h-80 overflow-y-auto mb-4 space-y-2">
                                    {employees.map(e => (
                                        <div key={e.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <span className="font-medium text-lg">{e.name}</span>
                                            <button onClick={() => toggleAttendance(e.id, e.name, !e.active)} className={`px-4 py-2 rounded-lg font-bold ${e.active ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`}>{e.active ? 'PRESENTE' : 'AUSENTE'}</button>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => setShowAttendance(false)} className="w-full border p-3 rounded-xl font-bold text-gray-600 hover:bg-gray-50">Cerrar</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = () => {
            const { history, tickets, deductions } = useContext(AppContext);
            const allPaid = history.concat(tickets.filter(t => t.status === 'PAID'));
            return (
                <div className="p-4 h-full overflow-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex items-center"><CheckCircle className="w-4 h-4 mr-2 text-green-600" /> Tickets Pagados</div>
                        <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 font-bold text-gray-700 sticky top-0"><tr><th className="p-3">ID</th><th className="p-3">Hora</th><th className="p-3">Servicio</th><th className="p-3 text-right">Total</th></tr></thead>
                                <tbody>
                                    {allPaid.map(t => (
                                        <tr key={t.id} className="border-t hover:bg-gray-50">
                                            <td className="p-3 font-mono text-xs">#{t.id.slice(-4).toUpperCase()}</td>
                                            <td className="p-3">{t.timestamp instanceof Date ? t.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...'}</td>
                                            <td className="p-3"><div className="font-medium">{t.service?.label || 'Extras'}</div>{t.snackCount > 0 && <span className="text-xs text-orange-600 font-bold block">(+{t.snackCount} Snacks)</span>}</td>
                                            <td className="p-3 font-bold text-green-600 text-right">{formatCurrency(t.price)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                        <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center"><span>Snacks Empleados</span><Coffee className="w-4 h-4 text-orange-500" /></div>
                        <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-orange-50 font-bold text-orange-800 sticky top-0"><tr><th className="p-3">Fecha</th><th className="p-3">Empleado</th><th className="p-3 text-right">Monto</th></tr></thead>
                                <tbody>
                                    {deductions.filter(d => d.amount > 0).map(d => (
                                        <tr key={d.id} className="border-t hover:bg-orange-50">
                                            <td className="p-3">{d.timestamp instanceof Date ? d.timestamp.toLocaleDateString() : '...'}</td>
                                            <td className="p-3 font-bold">{d.employee}</td>
                                            <td className="p-3 font-bold text-red-500 text-right">-{formatCurrency(d.amount)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = () => {
            const {
                employees, history, deductions, db, exRate, snackPrice, updateGlobalSettings,
                addEmployee, prices, commissions, extrasList
            } = useContext(AppContext);

            const [tab, setTab] = useState('NOMINA');
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setDate(d.getDate() - 7); return d.toISOString().split('T')[0]; });
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [newEmpName, setNewEmpName] = useState('');
            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));

            // Buffered State for Editing
            const [editPrices, setEditPrices] = useState({});
            const [editComms, setEditComms] = useState({});
            const [editExtras, setEditExtras] = useState([]);
            const [deletedExtras, setDeletedExtras] = useState([]);

            // Local state for settings to avoid jumping cursor on sync
            const [localExRate, setLocalExRate] = useState(exRate);
            const [localSnackPrice, setLocalSnackPrice] = useState(snackPrice);

            // Sync state when entering tabs
            useEffect(() => {
                if (tab === 'PRICES') {
                    setEditPrices(JSON.parse(JSON.stringify(prices)));
                    setEditComms(JSON.parse(JSON.stringify(commissions)));
                    setEditExtras(JSON.parse(JSON.stringify(extrasList)));
                    setDeletedExtras([]);
                }
                if (tab === 'CONFIG') {
                    setLocalExRate(exRate);
                    setLocalSnackPrice(snackPrice);
                }
            }, [tab, prices, commissions, extrasList, exRate, snackPrice]);

            const parseDate = (str) => { const [y, m, d] = str.split('-').map(Number); return new Date(y, m - 1, d); };
            const start = parseDate(startDate); start.setHours(0, 0, 0, 0);
            const end = parseDate(endDate); end.setHours(23, 59, 59, 999);
            const filterRange = (ts) => { if (!ts) return true; const date = ts.toDate ? ts.toDate() : new Date(ts); return date >= start && date <= end; };

            const rangeHistory = history.filter(t => t.status === 'PAID' && filterRange(t.timestamp));
            const rangeDeductions = deductions.filter(d => d.status === 'PENDING' && filterRange(d.timestamp));
            const payroll = calculatePayroll(employees, rangeHistory, rangeDeductions);

            const printNomina = () => {
                const win = PrintService.open();

                let html = `<html><head><title>Nomina</title>
                <style>
                    body { font-family: sans-serif; padding: 20px; color: #333; }
                    h2, h3 { margin-bottom: 5px; margin-top: 20px; }
                    
                    /* Grid Table Styling */
                    .grid-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 11px; }
                    .grid-table th, .grid-table td { border: 1px solid #ccc; padding: 4px; text-align: center; }
                    .grid-table th { background: #f3f4f6; }
                    .grid-table .svc-label { text-align: left; font-weight: bold; }
                    
                    /* Multiplier List Styling */
                    .multiplier-list { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 15px; }
                    .multiplier-list td { padding: 2px 0; border-bottom: 1px dotted #eee; }
                    .total-row { font-weight: bold; font-size: 14px; border-top: 1px solid #000; margin-top: 10px; padding-top: 5px; }
                    .deductions { color: #cc0000; }
                    
                    .page-break { page-break-after: always; }
                    .header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
                </style>
                </head><body>`;

                Object.keys(payroll).forEach(name => {
                    const p = payroll[name];
                    if (p.count === 0 && p.deductionTotal === 0) return;

                    // Header
                    html += `
                        <div class="header">
                            <div>
                                <h2 style="margin:0">${name}</h2>
                                <small>${startDate} a ${endDate}</small>
                            </div>
                            <div style="text-align:right">
                                <h2 style="margin:0">${formatCurrency(p.netPay)}</h2>
                                <small>TOTAL A PAGAR</small>
                            </div>
                        </div>
                    `;

                    // 1. Grid (Counts)
                    html += `<h4>Cantidad de Servicios</h4>`;
                    html += `<table class="grid-table">
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                ${SIZES.map(s => `<th>${s.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>`;

                    SERVICES.forEach(svc => {
                        const rowCounts = SIZES.map(sz => p.serviceGrid[svc.id][sz.id] || 0);
                        // Only show rows that have data
                        if (rowCounts.some(c => c > 0)) {
                            html += `<tr>
                                <td class="svc-label">${svc.label}</td>
                                ${rowCounts.map(c => `<td style="${c > 0 ? 'font-weight:bold;' : 'color:#ccc'}">${c || '-'}</td>`).join('')}
                            </tr>`;
                        }
                    });
                    html += `</tbody></table>`;

                    // 3. Deductions (Renamed to Varios)
                    if (p.deductionTotal > 0) {
                        html += `<div style="margin-top: 15px; border-top: 1px dotted #ccc; padding-top: 5px; display: flex; justify-content: space-between; font-size: 12px; color: #cc0000;">
                            <span>Varios (Snacks, Prestamos, etc.)</span>
                            <span>-${formatCurrency(p.deductionTotal)}</span>
                         </div>`;
                    }

                    // 4. Legal Text & Signature
                    html += `
                        <div style="margin-top: 30px; font-size: 10px; text-align: justify;">
                            Recibí de LAVAMEX la cantidad descrita a mi entera satisfacción por concepto de pago de comisiones por servicios de lavado realizados. No reservándome acción ni derecho alguno que ejercitar por ninguna vía laboral, civil o mercantil.
                        </div>
                        <div style="margin-top: 40px; text-align: center;">
                            _______________________________<br>
                            Firma del Empleado
                        </div>
                    `;

                    html += `<hr class="page-break" />`;
                });
                html += `</body></html>`;
                PrintService.print(win, html);
            };

            const generateAttendanceReport = async () => {
                const win = PrintService.open();
                const q = query(collection(db, "attendance"), where("month", "==", reportMonth));
                const snapshot = await getDocs(q);
                const attendanceData = {};
                snapshot.forEach(doc => { attendanceData[doc.id] = doc.data().records; });

                const daysInMonth = new Date(reportMonth.split('-')[0], reportMonth.split('-')[1], 0).getDate();
                const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

                const tableRows = employees.map(emp => {
                    const cells = days.map(day => {
                        const dateStr = `${reportMonth}-${String(day).padStart(2, '0')}`;
                        const status = attendanceData[dateStr]?.[emp.name];
                        return `<td style="text-align:center; padding: 2px;">${status ? '✔️' : ''}</td>`;
                    }).join('');
                    return `<tr><td style="font-weight:bold; padding:4px;">${emp.name}</td>${cells}</tr>`;
                }).join('');

                const html = `<h2 style="text-align:center">Asistencia: ${reportMonth}</h2><table style="width:100%; border-collapse: collapse; font-size: 10px;" border="1"><thead><tr><th>Empleado</th>${days.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody>${tableRows}</tbody></table>`;
                PrintService.print(win, html, true);
            };

            const closeWeek = async () => {
                if (!confirm("¿Archivar semana?")) return;
                const batch = writeBatch(db);
                rangeHistory.forEach(t => batch.update(doc(db, "tickets", t.id), { status: 'ARCHIVED' }));
                rangeDeductions.forEach(d => batch.update(doc(db, "deductions", d.id), { status: 'ARCHIVED' }));
                await batch.commit();
                alert("Semana Cerrada");
            };

            const handleAddEmployee = () => { if (newEmpName.trim()) { addEmployee(newEmpName.trim()); setNewEmpName(''); } };

            const saveAllSettings = async () => {
                if (!confirm("¿Aplicar nuevos precios?")) return;
                try {
                    const batch = writeBatch(db);

                    // 1. Save Prices & Commissions (Maps)
                    batch.set(doc(db, "settings", "prices"), editPrices);
                    batch.set(doc(db, "settings", "commissions"), editComms);

                    // 2. Process Extras Updates/Inserts
                    editExtras.forEach(e => {
                        if (e.docId) {
                            // Update existing
                            batch.update(doc(db, "extras", e.docId), {
                                label: e.label,
                                price: parseFloat(e.price) || 0,
                                commission: parseFloat(e.commission) || 0,
                                id: e.id // Ensure ID consistency
                            });
                        } else {
                            // Create new (generate ID if missing)
                            const newRef = doc(collection(db, "extras"));
                            batch.set(newRef, {
                                id: e.id || `EXTRA_${Date.now()}`,
                                label: e.label,
                                price: parseFloat(e.price) || 0,
                                commission: parseFloat(e.commission) || 0
                            });
                        }
                    });

                    // 3. Process Extras Deletions
                    deletedExtras.forEach(docId => {
                        batch.delete(doc(db, "extras", docId));
                    });

                    await batch.commit();
                    alert("¡Precios Actualizados!");
                } catch (e) { alert("Error: " + e.message); }
            };

            const updateLocalPrice = (type, svcId, sizeId, val) => {
                const target = type === 'prices' ? editPrices : editComms;
                const setTarget = type === 'prices' ? setEditPrices : setEditComms;
                const newObj = { ...target };
                if (!newObj[svcId]) newObj[svcId] = {};
                newObj[svcId][sizeId] = parseFloat(val) || 0;
                setTarget(newObj);
            };

            const updateLocalExtra = (index, field, val) => {
                const arr = [...editExtras];
                arr[index][field] = val;
                setEditExtras(arr);
            };

            const addExtraRow = () => {
                setEditExtras([...editExtras, { id: '', label: 'Nuevo Extra', price: 0, commission: 0 }]);
            };

            const removeExtraRow = (index) => {
                const item = editExtras[index];
                if (item.docId) {
                    setDeletedExtras([...deletedExtras, item.docId]);
                }
                const arr = [...editExtras];
                arr.splice(index, 1);
                setEditExtras(arr);
            };

            return (
                <div className="p-4 md:p-6 h-full overflow-y-auto">
                    <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-1">
                        {['NOMINA', 'CONFIG', 'PRICES', 'REPORT'].map(t => (
                            <button key={t} onClick={() => setTab(t)}
                                className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === t ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>
                                {t}
                            </button>
                        ))}
                    </div>

                    {tab === 'NOMINA' && (
                        <div>
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100 gap-4">
                                <div className="flex flex-wrap gap-3 items-end">
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Inicio</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Fin</label><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                                    <button onClick={printNomina} className="bg-green-600 text-white px-5 py-2.5 rounded-lg font-bold shadow flex items-center"><Printer className="w-4 h-4 mr-2" /> PDF</button>
                                </div>
                                <button onClick={closeWeek} className="w-full md:w-auto bg-red-600 text-white px-5 py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 shadow"><Archive className="w-4 h-4" /> CERRAR SEMANA</button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {Object.keys(payroll).map(name => (
                                    <div key={name} className="bg-white p-5 rounded-xl shadow-sm border border-l-4 border-l-blue-500">
                                        <div className="font-bold text-xl text-gray-800 mb-1">{name}</div>
                                        <div className="text-3xl font-bold text-green-700">{formatCurrency(payroll[name].netPay)}</div>
                                        <div className="text-sm text-gray-500 mt-2 flex justify-between border-t pt-2"><span>Com: {formatCurrency(payroll[name].total)}</span><span className="text-red-500 font-medium">Ded: {formatCurrency(payroll[name].deductionTotal)}</span></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {tab === 'REPORT' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-lg mx-auto">
                            <h3 className="font-bold mb-4 text-gray-800 flex items-center"><Calendar className="mr-2" /> Reporte de Asistencia</h3>
                            <div className="mb-4"><label className="block text-sm font-bold text-gray-600 mb-2">Mes</label><input type="month" value={reportMonth} onChange={e => setReportMonth(e.target.value)} className="border p-3 rounded-lg w-full text-lg" /></div>
                            <button onClick={generateAttendanceReport} className="w-full bg-blue-600 text-white font-bold p-3 rounded-xl shadow">Imprimir Reporte Mensual</button>
                        </div>
                    )}

                    {tab === 'CONFIG' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-lg mx-auto">
                            <h3 className="font-bold mb-4 text-gray-800">General</h3>
                            <div className="mb-6 flex flex-col gap-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-600 mb-2">Cambio de Dólar ($)</label>
                                    <input type="number" value={localExRate} onChange={e => setLocalExRate(e.target.value)} className="border p-3 rounded-lg w-full text-lg" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-600 mb-2">Precio Snack ($)</label>
                                    <input type="number" value={localSnackPrice} onChange={e => setLocalSnackPrice(e.target.value)} className="border p-3 rounded-lg w-full text-lg" />
                                </div>
                                <button onClick={() => { updateGlobalSettings(parseFloat(localExRate), parseFloat(localSnackPrice)); alert("Ajustes actualizados"); }} className="bg-blue-600 text-white p-3 rounded-lg font-bold w-full shadow">Guardar Cambios</button>
                            </div>

                            <h3 className="font-bold mb-4 border-t pt-4 text-gray-800">Empleados</h3>
                            <div className="flex gap-2 mb-4"><input value={newEmpName} onChange={(e) => setNewEmpName(e.target.value)} placeholder="Nuevo Empleado" className="border p-3 rounded-lg flex-1" /><button onClick={handleAddEmployee} className="bg-blue-600 text-white px-5 rounded-lg font-bold"><PlusCircle className="w-5 h-5" /></button></div>
                            <div className="space-y-2">{employees.map((e, i) => (<div key={e.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span className="font-medium">{e.name}</span><span className={`text-xs font-bold px-2 py-1 rounded ${e.active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{e.active ? 'Presente' : 'Ausente'}</span></div>))}</div>
                        </div>
                    )}

                    {tab === 'PRICES' && (
                        <div className="space-y-6">
                            <div className="bg-blue-50 border-blue-200 border p-4 rounded-xl flex justify-between items-center">
                                <div><h3 className="font-bold text-blue-800">Edición de Precios</h3><p className="text-sm text-blue-600">Edita los valores y guarda para aplicar.</p></div>
                                <button onClick={saveAllSettings} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2"><Upload className="w-5 h-5" /> GUARDAR</button>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead><tr className="bg-gray-100"><th className="p-3 border">Servicio</th>{SIZES.map(s => <th key={s.id} className="p-3 border">{s.label}</th>)}</tr></thead>
                                    <tbody>
                                        {SERVICES.map(svc => (
                                            <tr key={svc.id}>
                                                <td className="p-3 border font-medium">{svc.label}</td>
                                                {SIZES.map(size => (
                                                    <td key={size.id} className="p-2 border">
                                                        <div className="flex flex-col gap-1">
                                                            <input type="number" value={editPrices[svc.id]?.[size.id] || 0} onChange={(e) => updateLocalPrice('prices', svc.id, size.id, e.target.value)} className="border p-1 rounded w-full text-center text-green-700 font-bold" placeholder="Precio" />
                                                            <input type="number" value={editComms[svc.id]?.[size.id] || 0} onChange={(e) => updateLocalPrice('commissions', svc.id, size.id, e.target.value)} className="border p-1 rounded w-full text-center text-blue-600 text-xs" placeholder="Com" />
                                                        </div>
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 overflow-x-auto mt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="font-bold text-gray-700">Extras</h4>
                                    <button onClick={addExtraRow} className="bg-green-100 text-green-700 px-3 py-1 rounded font-bold text-sm border border-green-200">+ Agregar Extra</button>
                                </div>
                                <table className="w-full text-sm text-left border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="p-3 border">Nombre / Etiqueta</th>
                                            <th className="p-3 border text-center">Precio ($)</th>
                                            <th className="p-3 border text-center">Comisión ($)</th>
                                            <th className="p-3 border text-center w-12"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {editExtras.map((ex, idx) => (
                                            <tr key={idx}>
                                                <td className="p-2 border">
                                                    <input
                                                        value={ex.label}
                                                        onChange={(e) => updateLocalExtra(idx, 'label', e.target.value)}
                                                        className="border p-2 rounded w-full"
                                                        placeholder="Nombre del Extra"
                                                    />
                                                </td>
                                                <td className="p-2 border">
                                                    <input
                                                        type="number"
                                                        value={ex.price}
                                                        onChange={(e) => updateLocalExtra(idx, 'price', e.target.value)}
                                                        className="border p-2 rounded w-full text-center text-green-700 font-bold"
                                                    />
                                                </td>
                                                <td className="p-2 border">
                                                    <input
                                                        type="number"
                                                        value={ex.commission}
                                                        onChange={(e) => updateLocalExtra(idx, 'commission', e.target.value)}
                                                        className="border p-2 rounded w-full text-center text-blue-600 font-bold"
                                                    />
                                                </td>
                                                <td className="p-2 border text-center">
                                                    <button onClick={() => removeExtraRow(idx)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16} /></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ------------------------------------------------------------------
        // SECTION 9: MAIN LAYOUT
        // ------------------------------------------------------------------
        const LavamexPOS = () => {
            const { role, view, setView, logout } = useContext(AppContext);
            if (!role) return <LoginScreen />;

            return (
                <div className="h-screen flex flex-col bg-gray-100 font-sans">
                    <header className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md shrink-0 z-50">
                        <div className="flex items-center gap-2 font-bold text-lg md:text-xl truncate">
                            <Car className="text-blue-400 shrink-0" /> <span>LAVAMEX</span>
                            <span className="hidden sm:inline text-xs bg-gray-800 px-2 py-1 rounded font-normal text-gray-300 ml-2">{role}</span>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            <button onClick={() => setView('GREETER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'GREETER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><CheckCircle size={18} /> <span className="hidden sm:inline">Entrada</span></button>
                            {(role === 'CASHIER' || role === 'ADMIN') && (
                                <>
                                    <button onClick={() => setView('CASHIER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'CASHIER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Calculator size={18} /> <span className="hidden sm:inline">Caja</span></button>
                                    <button onClick={() => setView('HISTORY')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'HISTORY' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><History size={18} /> <span className="hidden sm:inline">Historial</span></button>
                                </>
                            )}
                            {role === 'ADMIN' && (
                                <button onClick={() => setView('ADMIN')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'ADMIN' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Settings size={18} /> <span className="hidden sm:inline">Admin</span></button>
                            )}
                            <button onClick={logout} className="bg-red-900/80 px-3 rounded ml-2 hover:bg-red-700 shrink-0"><LogOut size={18} /></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden relative">
                        {view === 'GREETER' && <GreeterView />}
                        {view === 'CASHIER' && <CashierView />}
                        {view === 'HISTORY' && <HistoryView />}
                        {view === 'ADMIN' && <AdminPanel />}
                    </main>
                </div>
            );
        };

        const App = () => (
            <AppProvider>
                <LavamexPOS />
            </AppProvider>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>