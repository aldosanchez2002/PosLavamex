<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lavamex POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    <style>
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { User, DollarSign, Car, CheckCircle, FileText, Settings, Trash2, LogOut, Users, Calculator, Printer, Wifi, WifiOff, Lock, Archive, Pencil, PlusCircle, Coffee, History, ArrowLeft, Save, Baby } from 'lucide-react';
        import { initializeApp, getApps, getApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp, writeBatch } from 'firebase/firestore';

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyByIvJpBZv32Zd22fxlYWL9etzBa66Q2rE",
            authDomain: "poslavamex.firebaseapp.com",
            projectId: "poslavamex",
            storageBucket: "poslavamex.firebasestorage.app",
            messagingSenderId: "883264129",
            appId: "1:883264129:web:39a352e2ade3888b4f1b80"
        };
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);

        // --- DATA ---
        const SIZES = [{ id: 'AUTO', label: 'Auto' }, { id: 'SUV_CHICA', label: 'SUV Chica' }, { id: 'PICKUP', label: 'Pick-Up / SUV MD' }, { id: 'SUV_GDE', label: 'SUV Gde' }];
        const SERVICES = [{ id: 'GENERAL', label: 'Lavado General' }, { id: 'WAX', label: 'Lavado + Cera' }, { id: 'COMPLETE', label: 'Paquete Completo' }, { id: 'PREMIUM', label: 'Paquete Premium' }, { id: 'PRESIDENTIAL', label: 'Paquete Presidencial' }];
        const EXTRAS = [
            { id: 'MOTOR', label: 'Lavado Motor', price: 400, commission: 140 },
            { id: 'CHASIS', label: 'Chasis', price: 150, commission: 52.50 },
            { id: 'AROMA', label: 'Aroma', price: 30, commission: 10.50 },
            { id: 'BOLEADA', label: 'Boleada', price: 50, commission: 17.50 },
            { id: 'TAPICERIA', label: 'Limpieza Tapicería', price: 600, commission: 210 },
            { id: 'BABY_SEAT', label: 'Asiento de Bebé', price: 200, commission: 70 }, // Added: 35% commission
        ];
        const SNACK_PRICE = 25;
        const PRICES = {
            GENERAL: { AUTO: 200, SUV_CHICA: 240, PICKUP: 360, SUV_GDE: 360 },
            WAX: { AUTO: 540, SUV_CHICA: 640, PICKUP: 820, SUV_GDE: 820 },
            COMPLETE: { AUTO: 840, SUV_CHICA: 1040, PICKUP: 1160, SUV_GDE: 1640 },
            PREMIUM: { AUTO: 1180, SUV_CHICA: 1440, PICKUP: 1620, SUV_GDE: 2100 },
            PRESIDENTIAL: { AUTO: 1540, SUV_CHICA: 1940, PICKUP: 2320, SUV_GDE: 2320 },
        };
        const COMMISSIONS = {
            GENERAL: { AUTO: 70, SUV_CHICA: 84, PICKUP: 126, SUV_GDE: 126 },
            WAX: { AUTO: 189, SUV_CHICA: 224, PICKUP: 287, SUV_GDE: 287 },
            COMPLETE: { AUTO: 294, SUV_CHICA: 364, PICKUP: 406, SUV_GDE: 574 },
            PREMIUM: { AUTO: 413, SUV_CHICA: 504, PICKUP: 567, SUV_GDE: 735 },
            PRESIDENTIAL: { AUTO: 539, SUV_CHICA: 679, PICKUP: 812, SUV_GDE: 812 },
        };

        // --- UTILS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);

        const calculatePayroll = (employees, history, deductions) => {
            const payroll = {};
            employees.forEach(emp => {
                payroll[emp.name] = { count: 0, total: 0, details: [], deductionTotal: 0, deductionDetails: [], netPay: 0 };
            });

            history.forEach(item => {
                const washersList = item.washers || (item.washer ? [item.washer] : []);
                if (washersList.length === 0) return;

                const splitCommission = item.commission / washersList.length;

                washersList.forEach(washerName => {
                    if (!payroll[washerName]) payroll[washerName] = { count: 0, total: 0, details: [], deductionTotal: 0, deductionDetails: [], netPay: 0 };

                    payroll[washerName].count += 1;
                    payroll[washerName].total += splitCommission;

                    payroll[washerName].details.push({
                        date: item.timestamp,
                        service: `${item.service.label} (${item.size.label})`,
                        desc: item.vehicleDesc || 'Sin descripción',
                        amount: splitCommission
                    });
                });
            });

            deductions.forEach(d => {
                if (payroll[d.employee]) {
                    payroll[d.employee].deductionTotal += d.amount;
                    payroll[d.employee].deductionDetails.push({
                        date: d.timestamp,
                        desc: d.description,
                        amount: d.amount
                    });
                }
            });

            Object.keys(payroll).forEach(key => {
                payroll[key].netPay = payroll[key].total - payroll[key].deductionTotal;
                payroll[key].details.sort((a, b) => (a.date > b.date ? 1 : -1));
                payroll[key].deductionDetails.sort((a, b) => (a.date > b.date ? 1 : -1));
            });

            return payroll;
        };

        const PrintService = {
            printHtml: (content) => {
                const win = window.open('', '', 'height=600,width=400');
                if (!win) return alert("Popups blocked.");
                win.document.write(`<html><head><title>Print</title><style>body{font-family:'Courier New';font-size:12px;margin:0;padding:5px;width:58mm}.center{text-align:center}.bold{font-weight:bold}.divider{border-top:1px dashed #000;margin:5px 0}.item{display:flex;justify-content:space-between}</style></head><body>${content}</body></html>`);
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 500);
            },
            jobTicket: (ticket, shortId) => {
                const washers = ticket.washers ? ticket.washers.join(', ') : ticket.washer;
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? `<div class="center" style="font-size:12px; margin-top:5px; font-weight:bold;">+ ${ticket.extras.map(e => e.label).join('<br>+ ')}</div>`
                    : '';

                PrintService.printHtml(`
                    <div class="center bold">LAVAMEX - ORDEN</div><div class="divider"></div>
                    <div class="item"><span>TICKET:</span><b>#${shortId}</b></div>
                    <div class="center bold" style="font-size:16px;margin:10px 0">${washers}</div>
                    <div class="center bold" style="font-size:14px">${ticket.size.label}<br>${ticket.service.label}</div>
                    ${extrasHtml}
                    ${ticket.vehicleDesc ? `<div class="center">(${ticket.vehicleDesc})</div>` : ''}
                    <div class="divider"></div><div class="center">.. TABLERO ..</div>
                `);
            },
            receipt: (ticket, payment, shortId) => {
                const extrasHtml = ticket.extras && ticket.extras.length > 0
                    ? `<div style="font-size:10px;">${ticket.extras.map(e => `<div class="item"><span>+ ${e.label}</span><span>${formatCurrency(e.price)}</span></div>`).join('')}</div>`
                    : '';

                PrintService.printHtml(`
                    <div class="center bold">LAVAMEX</div><div class="divider"></div>
                    <div class="item"><span>Ticket:</span><span>#${shortId}</span></div>
                    <div class="item"><span>Fecha:</span><span>${new Date().toLocaleDateString()}</span></div>
                    <div class="divider"></div>
                    <div class="item"><span>${ticket.service.label}</span><span>${formatCurrency(PRICES[ticket.service.id][ticket.size.id])}</span></div>
                    ${extrasHtml}
                    ${ticket.snackCount > 0 ? `<div class="item"><span>+ Snacks (${ticket.snackCount})</span><span>${formatCurrency(ticket.snackCount * SNACK_PRICE)}</span></div>` : ''}
                    <div class="divider"></div>
                    <div class="item bold"><span>TOTAL:</span><span>${formatCurrency(ticket.price)}</span></div>
                    <div class="item"><span>Recibido:</span><span>${formatCurrency(payment.mxn + (payment.usd * payment.rate))}</span></div>
                    <div class="item"><span>Cambio:</span><span>${formatCurrency(payment.change)}</span></div>
                    <div class="center" style="margin-top:10px">¡Gracias!</div>
                `);
            },
            report: (html) => {
                const win = window.open('', '', 'height=800,width=800');
                if (!win) return alert("Popups blocked");
                win.document.write(`<html><head><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:5px;text-align:left}</style></head><body>${html}</body></html>`);
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 500);
            }
        };

        // --- COMPONENTS ---

        const LoginScreen = ({ login }) => {
            const [pin, setPin] = useState('');

            const handleLogin = (targetRole) => {
                if (targetRole === 'GREETER') return login('GREETER');
                if (targetRole === 'CASHIER') {
                    if (pin === '1234') login('CASHIER');
                    else alert('PIN Incorrecto');
                }
                if (targetRole === 'ADMIN') {
                    if (pin === '9999') login('ADMIN');
                    else alert('PIN Incorrecto');
                }
                setPin('');
            };

            return (
                <div className="flex h-screen bg-gray-900 justify-center items-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                        <h1 className="text-3xl font-bold mb-6 text-gray-800">LAVAMEX POS</h1>
                        <div className="grid grid-cols-1 gap-4">
                            <button onClick={() => handleLogin('GREETER')} className="p-4 bg-blue-100 text-blue-800 rounded-xl font-bold hover:bg-blue-200 active:scale-95 transition-transform">ENTRADA (Sin Clave)</button>
                            <div className="border-t my-2"></div>
                            <input type="number" pattern="[0-9]*" inputMode="numeric" value={pin} onChange={e => setPin(e.target.value)} placeholder="PIN" className="w-full p-4 border rounded-lg text-center text-2xl mb-2" />
                            <div className="flex gap-3">
                                <button onClick={() => handleLogin('CASHIER')} className="flex-1 p-4 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 active:scale-95 transition-transform">CAJA</button>
                                <button onClick={() => handleLogin('ADMIN')} className="flex-1 p-4 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-900 active:scale-95 transition-transform">ADMIN</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const GreeterView = ({ employees, saveTicket, editingTicket, cancelEdit }) => {
            const [size, setSize] = useState(null);
            const [service, setService] = useState(null);
            const [washers, setWashers] = useState([]);
            const [extras, setExtras] = useState([]);
            const [desc, setDesc] = useState('');

            useEffect(() => {
                if (editingTicket) {
                    setSize(editingTicket.size);
                    setService(editingTicket.service);
                    setWashers(editingTicket.washers || (editingTicket.washer ? [editingTicket.washer] : []));
                    setExtras(editingTicket.extras || []);
                    setDesc(editingTicket.vehicleDesc || '');
                } else {
                    setSize(null); setService(null); setWashers([]); setExtras([]); setDesc('');
                }
            }, [editingTicket]);

            const toggle = (list, item, set) => {
                const isObj = typeof item !== 'string';
                const exists = isObj ? list.some(x => x.id === item.id) : list.includes(item);
                set(exists ? list.filter(x => isObj ? x.id !== item.id : x !== item) : [...list, item]);
            };

            const handleSubmit = () => {
                if (!size || !service || washers.length === 0) return;
                saveTicket({ size, service, washers, extras, desc });
                // Reset handled by useEffect when editingTicket becomes null or manually here for new
                if (!editingTicket) { setSize(null); setService(null); setWashers([]); setExtras([]); setDesc(''); }
            };

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    {editingTicket && (
                        <div className="bg-yellow-200 p-3 text-center font-bold text-yellow-900 flex justify-between items-center px-4 shadow-sm z-10 shrink-0">
                            <span className="flex items-center gap-2 text-sm"><Pencil className="w-4 h-4" /> EDITANDO #{editingTicket.id.slice(-4).toUpperCase()}</span>
                            <button onClick={cancelEdit} className="bg-white px-3 py-1 rounded text-xs hover:bg-yellow-50 border border-yellow-300">Cancelar</button>
                        </div>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-4 flex-1 overflow-y-auto">
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><Car className="w-5 h-5 mr-2" /> 1. Tamaño</h3>
                            <div className="space-y-2">
                                {SIZES.map(s => <button key={s.id} onClick={() => setSize(s)} className={`w-full p-4 text-left rounded-lg border-2 transition-all ${size?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 hover:bg-gray-50'}`}>{s.label}</button>)}
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border h-fit">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><FileText className="w-5 h-5 mr-2" /> 2. Servicio</h3>
                            <div className="space-y-2 mb-4">
                                {SERVICES.map(s => <button key={s.id} disabled={!size} onClick={() => setService(s)} className={`w-full p-3 text-left rounded-lg border-2 flex justify-between items-center transition-all ${service?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold text-blue-800 shadow-sm' : 'border-gray-200 opacity-90 hover:bg-gray-50'}`}><span>{s.label}</span>{size && <span className="bg-white px-2 py-1 rounded text-sm shadow-sm border">${PRICES[s.id][size.id]}</span>}</button>)}
                            </div>
                            <h3 className="font-bold mb-2 text-gray-700 text-sm">Extras</h3>
                            <div className="grid grid-cols-1 gap-2">
                                {EXTRAS.map(e => <button key={e.id} onClick={() => toggle(extras, e, setExtras)} className={`w-full p-3 rounded-lg border text-sm flex justify-between items-center transition-all ${extras.some(x => x.id === e.id) ? 'bg-indigo-50 border-indigo-600 font-bold text-indigo-800' : 'border-gray-200 hover:bg-gray-50'}`}><span>{e.label}</span><span>+${e.price}</span></button>)}
                            </div>
                        </div>
                        <div className="md:col-span-2 bg-white p-4 rounded-xl shadow border flex flex-col h-full">
                            <h3 className="font-bold mb-3 text-gray-700 flex items-center"><User className="w-5 h-5 mr-2" /> 3. Lavadores ({washers.length})</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
                                {employees.filter(e => e.active).map(e => <button key={e.name} onClick={() => toggle(washers, e.name, setWashers)} className={`p-4 rounded-lg border-2 text-center font-medium transition-all ${washers.includes(e.name) ? 'bg-green-100 border-green-600 text-green-800 shadow-inner' : 'border-gray-200 hover:bg-gray-50'}`}>{e.name}</button>)}
                            </div>
                            <div className="mt-auto pt-4 border-t">
                                <input value={desc} onChange={e => setDesc(e.target.value)} placeholder="Descripción (Opcional)" className="w-full p-3 border rounded-lg mb-4 text-lg" />
                                <button onClick={handleSubmit} disabled={!size || !service || washers.length === 0} className={`w-full py-5 rounded-xl font-bold text-white text-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform ${!size || !service || washers.length === 0 ? 'bg-gray-300' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                    {editingTicket ? <><Save className="w-6 h-6" /> GUARDAR</> : <><Printer className="w-6 h-6" /> CREAR ORDEN</>}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CashierView = ({ tickets, activeId, setActiveId, payment, setPayment, processPayment, deleteTicket, startEdit, updateSnacks, addDebt, employees, exRate }) => {
            const t = tickets.find(x => x.id === activeId);
            const [showSnack, setShowSnack] = useState(false);
            const [snackEmp, setSnackEmp] = useState('');

            return (
                <div className="flex flex-col md:flex-row h-full gap-4 p-4 overflow-hidden">
                    {/* Ticket List - Stacked on Mobile, Left on Tablet */}
                    <div className="w-full md:w-1/3 bg-white rounded-xl shadow border overflow-hidden flex flex-col h-1/3 md:h-full shrink-0">
                        <div className="p-3 bg-gray-50 font-bold border-b flex justify-between items-center shrink-0">
                            <span className="text-gray-700">Tickets ({tickets.length})</span>
                            <button onClick={() => setShowSnack(true)} className="text-xs bg-orange-100 text-orange-700 px-3 py-1 rounded-full font-bold border border-orange-200 active:bg-orange-200">Snack Emp</button>
                        </div>
                        <div className="overflow-y-auto flex-1 p-2 space-y-2">
                            {tickets.map(ticket => (
                                <div key={ticket.id} onClick={() => setActiveId(ticket.id)} className={`p-4 rounded-lg border cursor-pointer transition-all ${activeId === ticket.id ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50'}`}>
                                    <div className="flex justify-between font-bold text-gray-800"><span>#{ticket.id.slice(-4).toUpperCase()}</span><span>{formatCurrency(ticket.price)}</span></div>
                                    <div className="text-sm text-gray-600 mt-1">{ticket.service.label} <span className="bg-gray-200 px-1.5 rounded text-xs">{ticket.size.label}</span></div>
                                    {ticket.vehicleDesc && <div className="text-xs text-blue-600 italic mt-1">{ticket.vehicleDesc}</div>}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Detail View - Bottom on Mobile, Right on Tablet */}
                    <div className="flex-1 bg-white rounded-xl shadow border p-4 md:p-6 flex flex-col items-center justify-center h-2/3 md:h-full overflow-y-auto">
                        {t ? (
                            <div className="w-full max-w-md">
                                <h2 className="text-4xl font-bold text-center mb-2 text-gray-800">{formatCurrency(t.price)}</h2>
                                <p className="text-center text-gray-500 mb-6 font-medium">{t.vehicleDesc} • {t.washers?.join(', ')}</p>

                                <div className="flex justify-center items-center gap-3 mb-6 bg-orange-50 p-3 rounded-xl border border-orange-100">
                                    <span className="font-bold text-sm text-orange-800 uppercase tracking-wide">Snacks Cliente</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) - 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl shadow-sm text-gray-600 active:bg-gray-100">-</button>
                                    <span className="font-bold text-xl w-8 text-center">{t.snackCount || 0}</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) + 1)} className="w-10 h-10 bg-white border border-gray-200 rounded-lg font-bold text-xl shadow-sm text-green-600 active:bg-gray-100">+</button>
                                </div>

                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">MXN</label>
                                        <input type="number" inputMode="decimal" value={payment.mxn} onChange={e => setPayment({ ...payment, mxn: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">USD (Rate: {exRate})</label>
                                        <input type="number" inputMode="decimal" value={payment.usd} onChange={e => setPayment({ ...payment, usd: e.target.value })} placeholder="0.00" className="w-full p-3 border rounded-lg text-lg" />
                                    </div>
                                </div>

                                <div className="text-center font-bold mb-6 text-xl bg-gray-50 p-3 rounded-lg border">
                                    Cambio: <span className={((parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate)) - t.price < 0 ? 'text-red-500' : 'text-green-600'}>
                                        {formatCurrency(((parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate)) - t.price)}
                                    </span>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => deleteTicket(t.id)} className="p-4 border border-red-200 text-red-500 rounded-xl hover:bg-red-50 active:bg-red-100" title="Borrar"><Trash2 className="w-6 h-6" /></button>
                                    <button onClick={() => startEdit(t)} className="p-4 border border-yellow-200 text-yellow-600 rounded-xl bg-yellow-50 hover:bg-yellow-100 active:bg-yellow-200" title="Editar"><Pencil className="w-6 h-6" /></button>
                                    <button onClick={processPayment} className="flex-1 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><Printer className="w-6 h-6" /> COBRAR</button>
                                </div>
                            </div>
                        ) : <div className="text-gray-400 flex flex-col items-center"><LogOut className="w-16 h-16 opacity-20 mb-2" />Selecciona un ticket</div>}
                    </div>

                    {/* Modal */}
                    {showSnack && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm">
                                <h3 className="font-bold mb-4 text-lg text-gray-800 flex items-center"><Coffee className="mr-2 text-orange-500" /> Snack Empleado</h3>
                                <select className="w-full border p-3 rounded-lg mb-6 text-lg bg-white" onChange={e => setSnackEmp(e.target.value)} value={snackEmp}>
                                    <option value="">Seleccionar Empleado...</option>
                                    {employees.map(e => <option key={e.name} value={e.name}>{e.name}</option>)}
                                </select>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSnack(false)} className="flex-1 border p-3 rounded-xl font-bold text-gray-600">Cancelar</button>
                                    <button onClick={() => { if (snackEmp) { addDebt(snackEmp, 1); setShowSnack(false); setSnackEmp(''); } }} disabled={!snackEmp} className="flex-1 bg-orange-600 text-white p-3 rounded-xl font-bold shadow active:bg-orange-700 disabled:opacity-50">Confirmar ($25)</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = ({ history, deductions }) => (
            <div className="p-4 h-full overflow-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                    <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex items-center"><CheckCircle className="w-4 h-4 mr-2 text-green-600" /> Tickets Pagados</div>
                    <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 font-bold text-gray-700 sticky top-0">
                                <tr>
                                    <th className="p-3">ID</th>
                                    <th className="p-3">Hora</th>
                                    <th className="p-3">Servicio</th>
                                    <th className="p-3 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {history.map(t => (
                                    <tr key={t.id} className="border-t hover:bg-gray-50">
                                        <td className="p-3 font-mono text-xs">#{t.id.slice(-4).toUpperCase()}</td>
                                        <td className="p-3">
                                            {t.timestamp instanceof Date ? t.timestamp.toLocaleString('es-MX', {
                                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                                            }) : '...'}
                                        </td>
                                        <td className="p-3">
                                            <div className="font-medium">{t.service.label}</div>
                                            {t.snackCount > 0 && <span className="text-xs text-orange-600 font-bold block">(+{t.snackCount} Snacks)</span>}
                                        </td>
                                        <td className="p-3 font-bold text-green-600 text-right">{formatCurrency(t.price)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div className="bg-white rounded-xl shadow overflow-hidden h-fit border border-gray-200">
                    <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center">
                        <span>Snacks Empleados</span>
                        <Coffee className="w-4 h-4 text-orange-500" />
                    </div>
                    <div className="overflow-auto max-h-[60vh] md:max-h-[80vh]">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-orange-50 font-bold text-orange-800 sticky top-0">
                                <tr>
                                    <th className="p-3">Fecha</th>
                                    <th className="p-3">Empleado</th>
                                    <th className="p-3 text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {deductions.filter(d => d.amount > 0).map(d => (
                                    <tr key={d.id} className="border-t hover:bg-orange-50">
                                        <td className="p-3">
                                            {d.timestamp instanceof Date ? d.timestamp.toLocaleString('es-MX', {
                                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                                            }) : '...'}
                                        </td>
                                        <td className="p-3 font-bold">{d.employee}</td>
                                        <td className="p-3 font-bold text-red-500 text-right">-{formatCurrency(d.amount)}</td>
                                    </tr>
                                ))}
                                {deductions.filter(d => d.amount > 0).length === 0 && (
                                    <tr><td colSpan="3" className="p-4 text-center text-gray-400 italic">Sin registros recientes</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        const AdminPanel = ({ employees, setEmployees, history, deductions, db, exRate, setExRate }) => {
            const [tab, setTab] = useState('NOMINA');
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setDate(d.getDate() - 7); return d.toISOString().split('T')[0]; });
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [newEmp, setNewEmp] = useState('');

            // -- FILTER LOGIC --
            const parseDate = (str) => {
                const [y, m, d] = str.split('-').map(Number);
                return new Date(y, m - 1, d);
            };
            const start = parseDate(startDate); start.setHours(0, 0, 0, 0);
            const end = parseDate(endDate); end.setHours(23, 59, 59, 999);

            const filterRange = (ts) => {
                if (!ts) return true; // Optimistic for pending writes
                const date = ts.toDate ? ts.toDate() : new Date(ts);
                return date >= start && date <= end;
            };

            const rangeHistory = history.filter(t => t.status === 'PAID' && filterRange(t.timestamp));
            const rangeDeductions = deductions.filter(d => d.status === 'PENDING' && filterRange(d.timestamp));

            const clientSnackTotal = rangeHistory.reduce((acc, t) => acc + ((t.snackCount || 0) * SNACK_PRICE), 0);
            const empSnackTotal = rangeDeductions.reduce((acc, d) => acc + d.amount, 0);

            const payroll = calculatePayroll(employees, rangeHistory, rangeDeductions);

            const printNomina = () => {
                const styles = `
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        .payslip { border: 2px solid #333; padding: 20px; margin-bottom: 30px; page-break-inside: avoid; page-break-after: always; }
                        .header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 15px; padding-bottom: 10px; }
                        .emp-name { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 15px; }
                        th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .amount { text-align: right; }
                        .total-row { font-weight: bold; background-color: #eee; }
                        .signature { margin-top: 40px; border-top: 1px solid #000; padding-top: 5px; text-align: center; width: 60%; margin-left: auto; margin-right: auto; }
                        .net-pay { font-size: 16px; font-weight: bold; text-align: right; margin-top: 10px; }
                        .sub-header { font-weight: bold; margin-bottom: 5px; font-size: 13px; }
                    </style>
                `;

                let html = `<html><head><title>Nómina</title>${styles}</head><body>`;

                Object.keys(payroll).forEach(name => {
                    const p = payroll[name];
                    if (p.count === 0 && p.deductionTotal === 0) return;

                    html += `<div class="payslip">`;
                    html += `<div class="header">
                                <h3>LAVAMEX - RECIBO DE NÓMINA</h3>
                                <div>Periodo: ${startDate} al ${endDate}</div>
                             </div>`;
                    html += `<div class="emp-name">Empleado: ${name}</div>`;

                    html += `<div class="sub-header">Detalle de Servicios</div>`;
                    html += `<table>
                                <thead>
                                    <tr>
                                        <th style="width:30%">Fecha</th>
                                        <th style="width:50%">Servicio</th>
                                        <th style="width:20%" class="amount">Pago</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    p.details.forEach(det => {
                        const dateStr = new Date(det.date).toLocaleDateString('es-MX', { weekday: 'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        html += `<tr>
                                    <td>${dateStr}</td>
                                    <td>${det.service}</td>
                                    <td class="amount">${formatCurrency(det.amount)}</td>
                                 </tr>`;
                    });

                    html += `<tr class="total-row">
                                <td colspan="2" style="text-align:right">Subtotal Servicios:</td>
                                <td class="amount">${formatCurrency(p.total)}</td>
                             </tr>`;

                    if (p.deductionTotal > 0) {
                        html += `<tr class="total-row" style="color:red;">
                                    <td colspan="2" style="text-align:right">Total Deducciones (Snacks/Prestamos):</td>
                                    <td class="amount">-${formatCurrency(p.deductionTotal)}</td>
                                 </tr>`;
                    }

                    html += `</tbody></table>`;

                    html += `<div class="net-pay">TOTAL A PAGAR: ${formatCurrency(p.netPay)}</div>`;
                    html += `<div class="signature">Firma de Recibido</div>`;
                    html += `</div>`;
                });

                html += `</body></html>`;
                PrintService.report(html);
            };

            const closeWeek = async () => {
                if (!confirm("¿Archivar semana? Esto limpiará la nómina actual.")) return;
                const batch = writeBatch(db);
                const pendingHistory = history.filter(t => t.status === 'PAID');
                pendingHistory.forEach(t => batch.update(doc(db, "tickets", t.id), { status: 'ARCHIVED' }));
                deductions.filter(d => d.status === 'PENDING').forEach(d => batch.update(doc(db, "deductions", d.id), { status: 'ARCHIVED' }));
                await batch.commit();
                alert("Semana Cerrada");
            };

            const addEmployee = () => {
                if (newEmp.trim()) {
                    setEmployees([...employees, { name: newEmp.trim(), active: true }]);
                    setNewEmp('');
                }
            };

            return (
                <div className="p-4 md:p-6 h-full overflow-y-auto">
                    <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-1">
                        <button onClick={() => setTab('NOMINA')} className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === 'NOMINA' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>Nómina</button>
                        <button onClick={() => setTab('CONFIG')} className={`px-5 py-2.5 rounded-xl font-bold whitespace-nowrap transition-colors ${tab === 'CONFIG' ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>Configuración</button>
                    </div>

                    {tab === 'NOMINA' && (
                        <div>
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100 gap-4">
                                <div className="flex flex-wrap gap-3 items-end">
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Inicio</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Fin</label><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="border p-2 rounded-lg bg-gray-50" /></div>
                                    <button onClick={printNomina} className="bg-green-600 text-white px-5 py-2.5 rounded-lg font-bold shadow hover:bg-green-700 flex items-center"><Printer className="w-4 h-4 mr-2" /> PDF</button>
                                </div>
                                <button onClick={closeWeek} className="w-full md:w-auto bg-red-600 text-white px-5 py-2.5 rounded-lg font-bold flex items-center justify-center gap-2 shadow hover:bg-red-700"><Archive className="w-4 h-4" /> CERRAR SEMANA</button>
                            </div>

                            <div className="bg-orange-50 border border-orange-200 p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row gap-4 md:gap-8 items-start md:items-center">
                                <h3 className="text-orange-900 font-bold flex items-center shrink-0"><Coffee className="w-5 h-5 mr-2" /> Resumen Snacks</h3>
                                <div className="flex gap-4 md:gap-8 w-full">
                                    <div className="flex-1 md:flex-none">
                                        <div className="text-xs text-orange-700 font-bold uppercase">Clientes</div>
                                        <div className="text-xl font-bold text-orange-900">{formatCurrency(clientSnackTotal)}</div>
                                    </div>
                                    <div className="flex-1 md:flex-none">
                                        <div className="text-xs text-orange-700 font-bold uppercase">Empleados</div>
                                        <div className="text-xl font-bold text-orange-900">{formatCurrency(empSnackTotal)}</div>
                                    </div>
                                    <div className="border-l border-orange-200 pl-4 md:pl-8 flex-1 md:flex-none">
                                        <div className="text-xs text-orange-700 font-bold uppercase">Total</div>
                                        <div className="text-xl font-bold text-orange-900">{formatCurrency(clientSnackTotal + empSnackTotal)}</div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {Object.keys(payroll).map(name => (
                                    <div key={name} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 border-l-4 border-l-blue-500">
                                        <div className="font-bold text-xl text-gray-800 mb-1">{name}</div>
                                        <div className="text-3xl font-bold text-green-700">{formatCurrency(payroll[name].netPay)}</div>
                                        <div className="text-sm text-gray-500 mt-2 flex justify-between border-t pt-2">
                                            <span>Com: {formatCurrency(payroll[name].total)}</span>
                                            <span className="text-red-500 font-medium">Ded: {formatCurrency(payroll[name].deductionTotal)}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {tab === 'CONFIG' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-lg mx-auto">
                            <h3 className="font-bold mb-4 text-gray-800">General</h3>
                            <div className="mb-6"><label className="block text-sm font-bold text-gray-600 mb-2">Dólar (Rate)</label><input type="number" value={exRate} onChange={e => setExRate(parseFloat(e.target.value))} className="border p-3 rounded-lg w-full text-lg" /></div>
                            <h3 className="font-bold mb-4 border-t pt-4 text-gray-800">Empleados</h3>
                            <div className="flex gap-2 mb-4">
                                <input value={newEmp} onChange={(e) => setNewEmp(e.target.value)} placeholder="Nombre del lavador" className="border p-3 rounded-lg flex-1" />
                                <button onClick={addEmployee} className="bg-blue-600 text-white px-5 rounded-lg font-bold"><PlusCircle className="w-5 h-5" /></button>
                            </div>
                            <div className="space-y-2">
                                {employees.map((e, i) => (
                                    <div key={i} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <span className="font-medium">{e.name} <span className="text-xs text-gray-400">({e.active ? 'Activo' : 'Inactivo'})</span></span>
                                        <button onClick={() => { const n = [...employees]; n[i].active = !n[i].active; setEmployees(n) }} className="px-3 py-1 bg-white border rounded shadow-sm text-sm font-bold">{e.active ? <span className="text-green-600">ON</span> : <span className="text-gray-400">OFF</span>}</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [role, setRole] = useState(() => localStorage.getItem('lavamex_role') || null);

            const login = (r) => {
                setRole(r);
                localStorage.setItem('lavamex_role', r);
                if (r === 'GREETER') setView('GREETER');
                if (r === 'CASHIER') setView('CASHIER');
                if (r === 'ADMIN') setView('ADMIN');
            };

            const logout = () => {
                setRole(null);
                localStorage.removeItem('lavamex_role');
                setView('GREETER');
            };

            const [view, setView] = useState('GREETER');
            const [editingTicket, setEditingTicket] = useState(null);

            const [employees, setEmployees] = useState([{ name: 'Aldo', active: true }, { name: 'Sergio', active: true }, { name: 'Juan', active: true }, { name: 'Rodrigo', active: true }]);
            const [exRate, setExRate] = useState(18.10);
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [deductions, setDeductions] = useState([]);
            const [payment, setPayment] = useState({ mxn: '', usd: '' });
            const [activeId, setActiveId] = useState(null);

            useEffect(() => {
                const qT = query(collection(db, "tickets"), orderBy("timestamp", "desc"));
                const unsubT = onSnapshot(qT, (snap) => {
                    const active = [], hist = [];
                    snap.forEach(d => {
                        const dat = { id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate() || new Date() };
                        if (dat.status === 'PENDING') active.push(dat);
                        else hist.push(dat);
                    });
                    setTickets(active); setHistory(hist);
                });
                const unsubD = onSnapshot(collection(db, "deductions"), (snap) => {
                    setDeductions(snap.docs.map(d => {
                        const data = d.data();
                        return { id: d.id, ...data, timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : (data.timestamp || new Date()) };
                    }));
                });
                return () => { unsubT(); unsubD(); };
            }, []);

            const saveTicket = async (data) => {
                const base = PRICES[data.service.id][data.size.id];
                const comm = COMMISSIONS[data.service.id][data.size.id];
                const extrasPrice = data.extras.reduce((a, b) => a + b.price, 0);
                const extrasComm = data.extras.reduce((a, b) => a + b.commission, 0);
                const snacks = editingTicket ? (editingTicket.snackCount || 0) : 0;
                const snackCost = snacks * SNACK_PRICE;
                const totalPrice = base + extrasPrice + snackCost;

                const ticketData = {
                    ...data,
                    price: totalPrice,
                    commission: comm + extrasComm,
                    snackCount: snacks,
                    status: 'PENDING',
                    timestamp: serverTimestamp()
                };

                if (editingTicket) {
                    await updateDoc(doc(db, "tickets", editingTicket.id), ticketData);
                    alert("Actualizado");
                    setEditingTicket(null);
                    if (role === 'CASHIER') setView('CASHIER');
                } else {
                    const ref = await addDoc(collection(db, "tickets"), ticketData);
                    PrintService.jobTicket({ ...ticketData, timestamp: new Date() }, ref.id.slice(-4).toUpperCase());
                    alert("Creada");
                }
            };

            const updateSnacks = async (id, count) => {
                const t = tickets.find(x => x.id === id);
                if (!t) return;
                const newCount = Math.max(0, count);
                const base = PRICES[t.service.id][t.size.id];
                const extras = (t.extras || []).reduce((a, b) => a + b.price, 0);
                const newPrice = base + extras + (newCount * SNACK_PRICE);
                await updateDoc(doc(db, "tickets", id), { snackCount: newCount, price: newPrice });
            };

            const startEdit = (ticket) => { setEditingTicket(ticket); setView('GREETER'); };
            const cancelEdit = () => { setEditingTicket(null); if (role === 'CASHIER') setView('CASHIER'); };

            const processPayment = async () => {
                const t = tickets.find(x => x.id === activeId);
                if (!t) return;
                const total = (parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate);
                if (total < t.price) return alert("Falta dinero");
                const details = { mxn: parseFloat(payment.mxn) || 0, usd: parseFloat(payment.usd) || 0, rate: exRate, change: total - t.price };
                await updateDoc(doc(db, "tickets", t.id), { status: 'PAID', paidAt: serverTimestamp(), paymentDetails: details });
                PrintService.receipt(t, details, t.id.slice(-4).toUpperCase());
                setActiveId(null); setPayment({ mxn: '', usd: '' });
            };

            if (!role) return <LoginScreen login={login} />;

            return (
                <div className="h-screen flex flex-col bg-gray-100 font-sans">
                    <header className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md shrink-0 z-50">
                        <div className="flex items-center gap-2 font-bold text-lg md:text-xl truncate">
                            <Car className="text-blue-400 shrink-0" /> <span>LAVAMEX</span>
                            <span className="hidden sm:inline text-xs bg-gray-800 px-2 py-1 rounded font-normal text-gray-300 ml-2">{role}</span>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            <button onClick={() => setView('GREETER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'GREETER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><CheckCircle size={18} /> <span className="hidden sm:inline">Entrada</span></button>
                            {(role === 'CASHIER' || role === 'ADMIN') && (
                                <>
                                    <button onClick={() => setView('CASHIER')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'CASHIER' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Calculator size={18} /> <span className="hidden sm:inline">Caja</span></button>
                                    <button onClick={() => setView('HISTORY')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'HISTORY' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><History size={18} /> <span className="hidden sm:inline">Historial</span></button>
                                </>
                            )}
                            {role === 'ADMIN' && (
                                <button onClick={() => setView('ADMIN')} className={`px-3 py-2 rounded flex gap-2 items-center text-sm font-bold whitespace-nowrap transition-colors ${view === 'ADMIN' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-800'}`}><Settings size={18} /> <span className="hidden sm:inline">Admin</span></button>
                            )}
                            <button onClick={logout} className="bg-red-900/80 px-3 rounded ml-2 hover:bg-red-700 shrink-0"><LogOut size={18} /></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden relative">
                        {view === 'GREETER' && <GreeterView employees={employees} saveTicket={saveTicket} editingTicket={editingTicket} cancelEdit={cancelEdit} />}
                        {view === 'CASHIER' && <CashierView tickets={tickets} activeId={activeId} setActiveId={setActiveId} payment={payment} setPayment={setPayment} processPayment={processPayment} deleteTicket={async (id) => { if (confirm("Borrar?")) await updateDoc(doc(db, "tickets", id), { status: 'CANCELLED' }) }} updateSnacks={updateSnacks} addDebt={async (e, c) => addDoc(collection(db, "deductions"), { employee: e, amount: c * SNACK_PRICE, status: 'PENDING', timestamp: serverTimestamp() })} employees={employees} exRate={exRate} startEdit={startEdit} />}
                        {view === 'HISTORY' && <HistoryView history={history.concat(tickets.filter(t => t.status === 'PAID'))} deductions={deductions} />}
                        {view === 'ADMIN' && <AdminPanel employees={employees} setEmployees={setEmployees} history={history} deductions={deductions} db={db} exRate={exRate} setExRate={setExRate} />}
                    </main>
                </div>
            );
        }

        // --- TESTS ---
        const runTests = () => {
            console.group('🧪 Running Logic Tests');
            let passed = 0;
            let failed = 0;

            const assert = (desc, actual, expected) => {
                if (JSON.stringify(actual) === JSON.stringify(expected)) {
                    console.log(`✅ ${desc}`);
                    passed++;
                } else {
                    console.error(`❌ ${desc} \nExpected: ${JSON.stringify(expected)}\nActual: ${JSON.stringify(actual)}`);
                    failed++;
                }
            };

            // Mock Data
            const mockEmployees = [{ name: 'Aldo' }, { name: 'Juan' }];
            
            // Scenario: 
            // Ticket 1: Commission 100 split between Aldo/Juan (50 each)
            // Ticket 2: Commission 80 for Aldo only (80)
            // Deduction: Aldo owes 25
            // Expected Aldo: 50 + 80 - 25 = 105
            // Expected Juan: 50
            const mockHistory = [
                { washers: ['Aldo', 'Juan'], commission: 100, service: { label: 'Test' }, size: { label: 'Test' }, timestamp: new Date() },
                { washers: ['Aldo'], commission: 80, service: { label: 'Test' }, size: { label: 'Test' }, timestamp: new Date() }
            ];
            const mockDeductions = [
                { employee: 'Aldo', amount: 25, description: 'Snack', timestamp: new Date() }
            ];

            try {
                const result = calculatePayroll(mockEmployees, mockHistory, mockDeductions);

                // Assertions
                assert('Aldo Net Pay Calculation', result['Aldo'].netPay, 105);
                assert('Juan Net Pay Calculation', result['Juan'].netPay, 50);
                assert('Aldo Deduction Total', result['Aldo'].deductionTotal, 25);
                assert('Juan Deduction Total', result['Juan'].deductionTotal, 0);
                
            } catch (e) {
                console.error('❌ Test Crashed', e);
                failed++;
            }

            console.log(`\nTests Completed: ${passed} Passed, ${failed} Failed.`);
            console.groupEnd();
        };

        window.runTests = runTests; // Expose to console
        runTests(); // Run on startup

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>