<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavamex POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
</head>

<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { User, DollarSign, Car, CheckCircle, FileText, Settings, Trash2, LogOut, Users, Calculator, Printer, Wifi, WifiOff, Lock, Archive, Pencil, PlusCircle, Coffee, History, ArrowLeft, Save } from 'lucide-react';
        import { initializeApp, getApps, getApp } from 'firebase/app';
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, serverTimestamp, writeBatch } from 'firebase/firestore';

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyByIvJpBZv32Zd22fxlYWL9etzBa66Q2rE",
            authDomain: "poslavamex.firebaseapp.com",
            projectId: "poslavamex",
            storageBucket: "poslavamex.firebasestorage.app",
            messagingSenderId: "883264129",
            appId: "1:883264129:web:39a352e2ade3888b4f1b80"
        };
        const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();
        const db = getFirestore(app);

        // --- DATA ---
        const SIZES = [{ id: 'AUTO', label: 'Auto' }, { id: 'SUV_CHICA', label: 'SUV Chica' }, { id: 'PICKUP', label: 'Pick-Up' }, { id: 'SUV_GDE', label: 'SUV Gde' }];
        const SERVICES = [{ id: 'GENERAL', label: 'Lavado General' }, { id: 'WAX', label: 'Lavado + Cera' }, { id: 'COMPLETE', label: 'Paquete Completo' }, { id: 'PREMIUM', label: 'Paquete Premium' }, { id: 'PRESIDENTIAL', label: 'Paquete Presidencial' }];
        const EXTRAS = [
            { id: 'MOTOR', label: 'Lavado Motor', price: 400, commission: 140 },
            { id: 'CHASIS', label: 'Chasis', price: 150, commission: 52.50 },
            { id: 'AROMA', label: 'Aroma', price: 30, commission: 10.50 },
            { id: 'BOLEADA', label: 'Boleada', price: 50, commission: 17.50 },
            { id: 'TAPICERIA', label: 'Limpieza Tapicería', price: 600, commission: 210 },
        ];
        const SNACK_PRICE = 25;
        const PRICES = {
            GENERAL: { AUTO: 200, SUV_CHICA: 240, PICKUP: 360, SUV_GDE: 360 },
            WAX: { AUTO: 540, SUV_CHICA: 640, PICKUP: 820, SUV_GDE: 820 },
            COMPLETE: { AUTO: 840, SUV_CHICA: 1040, PICKUP: 1160, SUV_GDE: 1640 },
            PREMIUM: { AUTO: 1180, SUV_CHICA: 1440, PICKUP: 1620, SUV_GDE: 2100 },
            PRESIDENTIAL: { AUTO: 1540, SUV_CHICA: 1940, PICKUP: 2320, SUV_GDE: 2320 },
        };
        const COMMISSIONS = {
            GENERAL: { AUTO: 70, SUV_CHICA: 84, PICKUP: 126, SUV_GDE: 126 },
            WAX: { AUTO: 189, SUV_CHICA: 224, PICKUP: 287, SUV_GDE: 287 },
            COMPLETE: { AUTO: 294, SUV_CHICA: 364, PICKUP: 406, SUV_GDE: 574 },
            PREMIUM: { AUTO: 413, SUV_CHICA: 504, PICKUP: 567, SUV_GDE: 735 },
            PRESIDENTIAL: { AUTO: 539, SUV_CHICA: 679, PICKUP: 812, SUV_GDE: 812 },
        };

        // --- UTILS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);

        const calculatePayroll = (employees, history, deductions) => {
            const payroll = {};
            employees.forEach(emp => {
                payroll[emp.name] = { count: 0, total: 0, details: [], deductionTotal: 0, deductionDetails: [], netPay: 0 };
            });

            history.forEach(item => {
                const washersList = item.washers || (item.washer ? [item.washer] : []);
                if (washersList.length === 0) return;

                // Calculate pay per person
                const splitCommission = item.commission / washersList.length;

                washersList.forEach(washerName => {
                    if (!payroll[washerName]) payroll[washerName] = { count: 0, total: 0, details: [], deductionTotal: 0, deductionDetails: [], netPay: 0 };

                    payroll[washerName].count += 1;
                    payroll[washerName].total += splitCommission;

                    // Add detailed breakdown for payslip
                    payroll[washerName].details.push({
                        date: item.timestamp,
                        service: `${item.service.label} (${item.size.label})`,
                        desc: item.vehicleDesc || 'Sin descripción',
                        amount: splitCommission
                    });
                });
            });

            deductions.forEach(d => {
                // Using passed deductions (caller handles filtering)
                if (payroll[d.employee]) {
                    payroll[d.employee].deductionTotal += d.amount;
                    payroll[d.employee].deductionDetails.push({
                        date: d.timestamp,
                        desc: d.description,
                        amount: d.amount
                    });
                }
            });

            Object.keys(payroll).forEach(key => {
                payroll[key].netPay = payroll[key].total - payroll[key].deductionTotal;
                // Sort details by date for the report
                payroll[key].details.sort((a, b) => (a.date > b.date ? 1 : -1));
                payroll[key].deductionDetails.sort((a, b) => (a.date > b.date ? 1 : -1));
            });

            return payroll;
        };

        const PrintService = {
            printHtml: (content) => {
                const win = window.open('', '', 'height=600,width=400');
                if (!win) return alert("Popups blocked.");
                win.document.write(`<html><head><title>Print</title><style>body{font-family:'Courier New';font-size:12px;margin:0;padding:5px;width:58mm}.center{text-align:center}.bold{font-weight:bold}.divider{border-top:1px dashed #000;margin:5px 0}.item{display:flex;justify-content:space-between}</style></head><body>${content}</body></html>`);
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 500);
            },
            jobTicket: (ticket, shortId) => {
                const washers = ticket.washers ? ticket.washers.join(', ') : ticket.washer;
                PrintService.printHtml(`
                    <div class="center bold">LAVAMEX - ORDEN</div><div class="divider"></div>
                    <div class="item"><span>TICKET:</span><b>#${shortId}</b></div>
                    <div class="center bold" style="font-size:16px;margin:10px 0">${washers}</div>
                    <div class="center bold" style="font-size:14px">${ticket.size.label}<br>${ticket.service.label}</div>
                    ${ticket.vehicleDesc ? `<div class="center">(${ticket.vehicleDesc})</div>` : ''}
                    <div class="divider"></div><div class="center">.. TABLERO ..</div>
                `);
            },
            receipt: (ticket, payment, shortId) => {
                PrintService.printHtml(`
                    <div class="center bold">LAVAMEX</div><div class="divider"></div>
                    <div class="item"><span>Ticket:</span><span>#${shortId}</span></div>
                    <div class="item"><span>Fecha:</span><span>${new Date().toLocaleDateString()}</span></div>
                    <div class="divider"></div>
                    <div class="item"><span>${ticket.service.label}</span><span>${formatCurrency(ticket.price)}</span></div>
                    <div class="divider"></div>
                    <div class="item bold"><span>TOTAL:</span><span>${formatCurrency(ticket.price)}</span></div>
                    <div class="item"><span>Recibido:</span><span>${formatCurrency(payment.mxn + (payment.usd * payment.rate))}</span></div>
                    <div class="item"><span>Cambio:</span><span>${formatCurrency(payment.change)}</span></div>
                    <div class="center" style="margin-top:10px">¡Gracias!</div>
                `);
            },
            report: (html) => {
                const win = window.open('', '', 'height=800,width=800');
                if (!win) return alert("Popups blocked");
                win.document.write(`<html><head><style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:5px;text-align:left}</style></head><body>${html}</body></html>`);
                win.document.close();
                win.focus();
                setTimeout(() => { win.print(); win.close(); }, 500);
            }
        };

        // --- COMPONENTS ---

        const LoginScreen = ({ login }) => {
            const [pin, setPin] = useState('');

            const handleLogin = (targetRole) => {
                if (targetRole === 'GREETER') return login('GREETER');
                if (targetRole === 'CASHIER') {
                    if (pin === '1234') login('CASHIER');
                    else alert('PIN Incorrecto');
                }
                if (targetRole === 'ADMIN') {
                    if (pin === '9999') login('ADMIN');
                    else alert('PIN Incorrecto');
                }
                setPin('');
            };

            return (
                <div className="flex h-screen bg-gray-900 justify-center items-center">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center">
                        <h1 className="text-3xl font-bold mb-6 text-gray-800">LAVAMEX POS</h1>
                        <div className="grid grid-cols-1 gap-4">
                            <button onClick={() => handleLogin('GREETER')} className="p-4 bg-blue-100 text-blue-800 rounded-xl font-bold hover:bg-blue-200">ENTRADA (Sin Clave)</button>
                            <div className="border-t my-2"></div>
                            <input type="password" value={pin} onChange={e => setPin(e.target.value)} placeholder="Ingrese PIN" className="w-full p-3 border rounded-lg text-center text-xl mb-2" />
                            <div className="flex gap-2">
                                <button onClick={() => handleLogin('CASHIER')} className="flex-1 p-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700">CAJA</button>
                                <button onClick={() => handleLogin('ADMIN')} className="flex-1 p-3 bg-gray-800 text-white rounded-xl font-bold hover:bg-gray-900">ADMIN</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const GreeterView = ({ employees, saveTicket, editingTicket, cancelEdit }) => {
            const [size, setSize] = useState(null);
            const [service, setService] = useState(null);
            const [washers, setWashers] = useState([]);
            const [extras, setExtras] = useState([]);
            const [desc, setDesc] = useState('');

            useEffect(() => {
                if (editingTicket) {
                    setSize(editingTicket.size);
                    setService(editingTicket.service);
                    setWashers(editingTicket.washers || (editingTicket.washer ? [editingTicket.washer] : []));
                    setExtras(editingTicket.extras || []);
                    setDesc(editingTicket.vehicleDesc || '');
                } else {
                    setSize(null); setService(null); setWashers([]); setExtras([]); setDesc('');
                }
            }, [editingTicket]);

            const toggle = (list, item, set) => {
                const isObj = typeof item !== 'string';
                const exists = isObj ? list.some(x => x.id === item.id) : list.includes(item);
                set(exists ? list.filter(x => isObj ? x.id !== item.id : x !== item) : [...list, item]);
            };

            const handleSubmit = () => {
                if (!size || !service || washers.length === 0) return;
                saveTicket({ size, service, washers, extras, desc });
                // Reset handled by useEffect when editingTicket becomes null or manually here for new
                if (!editingTicket) { setSize(null); setService(null); setWashers([]); setExtras([]); setDesc(''); }
            };

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    {editingTicket && (
                        <div className="bg-yellow-200 p-3 text-center font-bold text-yellow-900 flex justify-between items-center px-6 shadow-sm z-10">
                            <span className="flex items-center gap-2"><Pencil className="w-4 h-4" /> EDITANDO TICKET #{editingTicket.id.slice(-4).toUpperCase()}</span>
                            <button onClick={cancelEdit} className="bg-white px-3 py-1 rounded text-sm hover:bg-yellow-50 border border-yellow-300">Cancelar Edición</button>
                        </div>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 flex-1 overflow-auto">
                        <div className="bg-white p-4 rounded-xl shadow border">
                            <h3 className="font-bold mb-2">1. Tamaño</h3>
                            {SIZES.map(s => <button key={s.id} onClick={() => setSize(s)} className={`w-full p-3 mb-2 rounded border-2 ${size?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold' : ''}`}>{s.label}</button>)}
                        </div>
                        <div className="bg-white p-4 rounded-xl shadow border">
                            <h3 className="font-bold mb-2">2. Servicio</h3>
                            {SERVICES.map(s => <button key={s.id} disabled={!size} onClick={() => setService(s)} className={`w-full p-3 mb-2 rounded border-2 flex justify-between ${service?.id === s.id ? 'border-blue-600 bg-blue-50 font-bold' : 'opacity-90'}`}><span>{s.label}</span>{size && <span>${PRICES[s.id][size.id]}</span>}</button>)}
                            <h3 className="font-bold mt-4 mb-2">Extras</h3>
                            {EXTRAS.map(e => <button key={e.id} onClick={() => toggle(extras, e, setExtras)} className={`w-full p-2 mb-1 rounded border text-sm flex justify-between ${extras.some(x => x.id === e.id) ? 'bg-indigo-50 border-indigo-600' : ''}`}><span>{e.label}</span><span>+${e.price}</span></button>)}
                        </div>
                        <div className="md:col-span-2 bg-white p-4 rounded-xl shadow border flex flex-col">
                            <h3 className="font-bold mb-2">3. Lavadores ({washers.length})</h3>
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                {employees.filter(e => e.active).map(e => <button key={e.name} onClick={() => toggle(washers, e.name, setWashers)} className={`p-3 rounded border ${washers.includes(e.name) ? 'bg-green-100 border-green-600 font-bold' : ''}`}>{e.name}</button>)}
                            </div>
                            <input value={desc} onChange={e => setDesc(e.target.value)} placeholder="Descripción (Opcional)" className="w-full p-2 border rounded mb-4" />
                            <button onClick={handleSubmit} disabled={!size || !service || washers.length === 0} className={`mt-auto w-full py-4 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 ${!size || !service || washers.length === 0 ? 'bg-gray-300' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                {editingTicket ? <><Save className="w-5 h-5" /> GUARDAR CAMBIOS</> : <><Printer className="w-5 h-5" /> CREAR ORDEN</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CashierView = ({ tickets, activeId, setActiveId, payment, setPayment, processPayment, deleteTicket, startEdit, updateSnacks, addDebt, employees, exRate }) => {
            const t = tickets.find(x => x.id === activeId);
            const [showSnack, setShowSnack] = useState(false);
            const [snackEmp, setSnackEmp] = useState('');

            return (
                <div className="flex h-full gap-4 p-4">
                    <div className="w-1/3 bg-white rounded-xl shadow border overflow-hidden flex flex-col">
                        <div className="p-3 bg-gray-50 font-bold border-b flex justify-between">
                            <span>Tickets Activos</span>
                            <button onClick={() => setShowSnack(true)} className="text-xs bg-orange-100 text-orange-700 px-2 rounded">Snack Empleado</button>
                        </div>
                        <div className="overflow-auto flex-1 p-2 space-y-2">
                            {tickets.map(ticket => (
                                <div key={ticket.id} onClick={() => setActiveId(ticket.id)} className={`p-3 rounded border cursor-pointer ${activeId === ticket.id ? 'border-blue-500 bg-blue-50' : ''}`}>
                                    <div className="flex justify-between font-bold"><span>#{ticket.id.slice(-4).toUpperCase()}</span><span>{formatCurrency(ticket.price)}</span></div>
                                    <div className="text-xs text-gray-500">{ticket.service.label} ({ticket.size.label})</div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex-1 bg-white rounded-xl shadow border p-6 flex flex-col items-center justify-center">
                        {t ? (
                            <div className="w-full max-w-md">
                                <h2 className="text-3xl font-bold text-center mb-2">{formatCurrency(t.price)}</h2>
                                <p className="text-center text-gray-500 mb-4">{t.vehicleDesc} • {t.washers?.join(', ')}</p>
                                <div className="flex justify-center items-center gap-2 mb-6 bg-orange-50 p-2 rounded">
                                    <span className="font-bold text-sm text-orange-800">Snacks Cliente:</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) - 1)} className="w-6 h-6 bg-white border font-bold">-</button>
                                    <span>{t.snackCount || 0}</span>
                                    <button onClick={() => updateSnacks(t.id, (t.snackCount || 0) + 1)} className="w-6 h-6 bg-white border font-bold">+</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <input type="number" value={payment.mxn} onChange={e => setPayment({ ...payment, mxn: e.target.value })} placeholder="MXN" className="p-2 border rounded" />
                                    <input type="number" value={payment.usd} onChange={e => setPayment({ ...payment, usd: e.target.value })} placeholder="USD" className="p-2 border rounded" />
                                </div>
                                <div className="text-center font-bold mb-4 text-green-600">Cambio: {formatCurrency(((parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate)) - t.price)}</div>
                                <div className="flex gap-2">
                                    <button onClick={() => deleteTicket(t.id)} className="p-3 border border-red-200 text-red-500 rounded" title="Borrar"><Trash2 /></button>
                                    <button onClick={() => startEdit(t)} className="p-3 border border-yellow-200 text-yellow-600 rounded bg-yellow-50" title="Editar"><Pencil /></button>
                                    <button onClick={processPayment} className="flex-1 bg-green-600 text-white font-bold rounded hover:bg-green-700">COBRAR</button>
                                </div>
                            </div>
                        ) : <div className="text-gray-400">Selecciona un ticket</div>}
                    </div>
                    {showSnack && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded shadow-lg w-80">
                                <h3 className="font-bold mb-4">Cobrar Snack a Empleado</h3>
                                <select className="w-full border p-2 mb-4" onChange={e => setSnackEmp(e.target.value)}><option value="">Seleccionar...</option>{employees.map(e => <option key={e.name} value={e.name}>{e.name}</option>)}</select>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSnack(false)} className="flex-1 border p-2">Cancelar</button>
                                    <button onClick={() => { addDebt(snackEmp, 1); setShowSnack(false); }} className="flex-1 bg-orange-600 text-white p-2">Confirmar ($25)</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const HistoryView = ({ history, deductions }) => (
            <div className="p-4 h-full overflow-auto grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-white rounded-xl shadow overflow-hidden h-fit">
                    <div className="p-3 bg-gray-50 border-b font-bold text-gray-700">Tickets Pagados</div>
                    <div className="overflow-auto max-h-[80vh]">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 font-bold text-gray-700">
                                <tr>
                                    <th className="p-3">ID</th>
                                    <th className="p-3">Fecha</th>
                                    <th className="p-3">Servicio</th>
                                    <th className="p-3">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {history.map(t => (
                                    <tr key={t.id} className="border-t hover:bg-gray-50">
                                        <td className="p-3">#{t.id.slice(-4).toUpperCase()}</td>
                                        <td className="p-3">
                                            {t.timestamp instanceof Date ? t.timestamp.toLocaleString('es-MX', {
                                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                                            }) : '...'}
                                        </td>
                                        <td className="p-3">
                                            {t.service.label}
                                            {t.snackCount > 0 && <span className="ml-1 text-xs text-orange-600 font-bold">(+{t.snackCount} Snacks)</span>}
                                        </td>
                                        <td className="p-3 font-bold text-green-600">{formatCurrency(t.price)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div className="bg-white rounded-xl shadow overflow-hidden h-fit">
                    <div className="p-3 bg-gray-50 border-b font-bold text-gray-700 flex justify-between items-center">
                        <span>Historial de Snacks (Empleados)</span>
                        <Coffee className="w-4 h-4 text-orange-500" />
                    </div>
                    <div className="overflow-auto max-h-[80vh]">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-orange-50 font-bold text-orange-800">
                                <tr>
                                    <th className="p-3">Fecha</th>
                                    <th className="p-3">Empleado</th>
                                    <th className="p-3">Descripción</th>
                                    <th className="p-3">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {deductions.filter(d => d.amount > 0).map(d => (
                                    <tr key={d.id} className="border-t hover:bg-orange-50">
                                        <td className="p-3">
                                            {d.timestamp instanceof Date ? d.timestamp.toLocaleString('es-MX', {
                                                month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                                            }) : '...'}
                                        </td>
                                        <td className="p-3 font-bold">{d.employee}</td>
                                        <td className="p-3">{d.description}</td>
                                        <td className="p-3 font-bold text-red-500">-{formatCurrency(d.amount)}</td>
                                    </tr>
                                ))}
                                {deductions.filter(d => d.amount > 0).length === 0 && (
                                    <tr><td colSpan="4" className="p-4 text-center text-gray-400">Sin registros recientes</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        const AdminPanel = ({ employees, setEmployees, history, deductions, db, exRate, setExRate }) => {
            const [tab, setTab] = useState('NOMINA');
            const [startDate, setStartDate] = useState(() => { const d = new Date(); d.setDate(d.getDate() - 7); return d.toISOString().split('T')[0]; });
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [newEmp, setNewEmp] = useState('');

            // -- FILTER LOGIC --
            const parseDate = (str) => {
                const [y, m, d] = str.split('-').map(Number);
                return new Date(y, m - 1, d);
            };
            const start = parseDate(startDate); start.setHours(0, 0, 0, 0);
            const end = parseDate(endDate); end.setHours(23, 59, 59, 999);

            const filterRange = (ts) => {
                if (!ts) return true; // Optimistic for pending writes
                const date = ts.toDate ? ts.toDate() : new Date(ts);
                return date >= start && date <= end;
            };

            // Filter logic MODIFIED for "Active" view:
            // "Close Week" marks items as ARCHIVED. 
            // The view below shows only PAID (active tickets) and PENDING (active debts).
            // When user clicks "Close Week", status changes to ARCHIVED, so they drop from this view.
            const rangeHistory = history.filter(t => t.status === 'PAID' && filterRange(t.timestamp));
            const rangeDeductions = deductions.filter(d => d.status === 'PENDING' && filterRange(d.timestamp));

            // Calculate Snack Totals
            const clientSnackTotal = rangeHistory.reduce((acc, t) => acc + ((t.snackCount || 0) * SNACK_PRICE), 0);
            const empSnackTotal = rangeDeductions.reduce((acc, d) => acc + d.amount, 0);

            // Payroll Logic (using filtered data)
            const payroll = calculatePayroll(employees, rangeHistory, rangeDeductions);

            const printNomina = () => {
                const styles = `
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        .payslip { border: 2px solid #333; padding: 20px; margin-bottom: 30px; page-break-inside: avoid; page-break-after: always; }
                        .header { text-align: center; border-bottom: 2px solid #333; margin-bottom: 15px; padding-bottom: 10px; }
                        .emp-name { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 15px; }
                        th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .amount { text-align: right; }
                        .total-row { font-weight: bold; background-color: #eee; }
                        .signature { margin-top: 40px; border-top: 1px solid #000; padding-top: 5px; text-align: center; width: 60%; margin-left: auto; margin-right: auto; }
                        .net-pay { font-size: 16px; font-weight: bold; text-align: right; margin-top: 10px; }
                        .sub-header { font-weight: bold; margin-bottom: 5px; font-size: 13px; }
                    </style>
                `;

                let html = `<html><head><title>Nómina</title>${styles}</head><body>`;

                Object.keys(payroll).forEach(name => {
                    const p = payroll[name];
                    if (p.count === 0 && p.deductionTotal === 0) return; // Skip empty

                    html += `<div class="payslip">`;
                    html += `<div class="header">
                                <h3>LAVAMEX - RECIBO DE NÓMINA</h3>
                                <div>Periodo: ${startDate} al ${endDate}</div>
                             </div>`;
                    html += `<div class="emp-name">Empleado: ${name}</div>`;

                    // Services Table
                    html += `<div class="sub-header">Detalle de Servicios</div>`;
                    html += `<table>
                                <thead>
                                    <tr>
                                        <th style="width:18%">Fecha</th>
                                        <th style="width:35%">Servicio</th>
                                        <th style="width:32%">Vehículo</th>
                                        <th style="width:15%" class="amount">Pago</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    p.details.forEach(det => {
                        const dateStr = new Date(det.date).toLocaleDateString('es-MX', { weekday: 'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                        html += `<tr>
                                    <td>${dateStr}</td>
                                    <td>${det.service}</td>
                                    <td>${det.desc}</td>
                                    <td class="amount">${formatCurrency(det.amount)}</td>
                                 </tr>`;
                    });

                    html += `<tr class="total-row">
                                <td colspan="3" style="text-align:right">Subtotal Servicios:</td>
                                <td class="amount">${formatCurrency(p.total)}</td>
                             </tr>`;
                    html += `</tbody></table>`;

                    // Deductions
                    if (p.deductionTotal > 0) {
                        html += `<div class="sub-header">Deducciones / Deudas</div>`;
                        html += `<table>
                                    <thead>
                                        <tr>
                                            <th style="width:20%">Fecha</th>
                                            <th style="width:65%">Concepto</th>
                                            <th style="width:15%" class="amount">Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;

                        p.deductionDetails.forEach(d => {
                            const dateStr = new Date(d.date).toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit' });
                            html += `<tr>
                                        <td>${dateStr}</td>
                                        <td>${d.desc}</td>
                                        <td class="amount" style="color:red">-${formatCurrency(d.amount)}</td>
                                      </tr>`;
                        });

                        html += `<tr class="total-row">
                                    <td colspan="2" style="text-align:right">Total Deducciones:</td>
                                    <td class="amount" style="color:red">-${formatCurrency(p.deductionTotal)}</td>
                                 </tr></tbody></table>`;
                    }

                    html += `<div class="net-pay">TOTAL A PAGAR: ${formatCurrency(p.netPay)}</div>`;
                    html += `<div class="signature">Firma de Recibido</div>`;
                    html += `</div>`;
                });

                html += `</body></html>`;
                PrintService.report(html);
            };

            const closeWeek = async () => {
                if (!confirm("¿Archivar semana? Esto limpiará la nómina actual.")) return;
                const batch = writeBatch(db);
                // For closing, we generally only archive pending/active paid items
                const pendingHistory = history.filter(t => t.status === 'PAID');
                pendingHistory.forEach(t => batch.update(doc(db, "tickets", t.id), { status: 'ARCHIVED' }));
                deductions.filter(d => d.status === 'PENDING').forEach(d => batch.update(doc(db, "deductions", d.id), { status: 'ARCHIVED' }));
                await batch.commit();
                alert("Semana Cerrada");
            };

            const addEmployee = () => {
                if (newEmp.trim()) {
                    setEmployees([...employees, { name: newEmp.trim(), active: true }]);
                    setNewEmp('');
                }
            };

            return (
                <div className="p-6 h-full overflow-auto">
                    <div className="flex gap-4 mb-6">
                        <button onClick={() => setTab('NOMINA')} className={`px-4 py-2 rounded font-bold ${tab === 'NOMINA' ? 'bg-blue-600 text-white' : 'bg-white'}`}>Nómina</button>
                        <button onClick={() => setTab('CONFIG')} className={`px-4 py-2 rounded font-bold ${tab === 'CONFIG' ? 'bg-blue-600 text-white' : 'bg-white'}`}>Configuración</button>
                    </div>

                    {tab === 'NOMINA' && (
                        <div>
                            <div className="flex justify-between items-center mb-4 bg-white p-4 rounded shadow">
                                <div className="flex gap-2 items-end">
                                    <div><label className="text-xs font-bold">Inicio</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="border p-1 rounded block" /></div>
                                    <div><label className="text-xs font-bold">Fin</label><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="border p-1 rounded block" /></div>
                                    <button onClick={printNomina} className="bg-green-600 text-white px-4 py-2 rounded font-bold h-10">Imprimir</button>
                                </div>
                                <button onClick={closeWeek} className="bg-red-600 text-white px-4 py-2 rounded font-bold flex items-center gap-2"><Archive className="w-4 h-4" /> CERRAR SEMANA</button>
                            </div>

                            {/* WEEKLY SUMMARY BOX */}
                            <div className="bg-orange-50 border border-orange-200 p-4 rounded-xl shadow-sm mb-6 flex gap-8 items-center">
                                <h3 className="text-orange-900 font-bold flex items-center"><Coffee className="w-5 h-5 mr-2" /> Resumen de Snacks (Semanal)</h3>
                                <div className="flex gap-6">
                                    <div>
                                        <div className="text-xs text-orange-700 font-bold uppercase">Snacks Clientes</div>
                                        <div className="text-xl font-bold text-orange-900">{formatCurrency(clientSnackTotal)}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-orange-700 font-bold uppercase">Snacks Empleados</div>
                                        <div className="text-xl font-bold text-orange-900">{formatCurrency(empSnackTotal)}</div>
                                    </div>
                                    <div className="border-l border-orange-200 pl-6">
                                        <div className="text-xs text-orange-700 font-bold uppercase">Total Venta Snacks</div>
                                        <div className="text-xl font-bold text-orange-900">{formatCurrency(clientSnackTotal + empSnackTotal)}</div>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {Object.keys(payroll).map(name => (
                                    <div key={name} className="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                                        <div className="font-bold text-lg">{name}</div>
                                        <div className="text-2xl font-bold text-green-700">{formatCurrency(payroll[name].netPay)}</div>
                                        <div className="text-xs text-gray-500 mt-2">Com: {formatCurrency(payroll[name].total)} | Ded: {formatCurrency(payroll[name].deductionTotal)}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {tab === 'CONFIG' && (
                        <div className="bg-white p-6 rounded shadow max-w-lg">
                            <h3 className="font-bold mb-4">General</h3>
                            <div className="mb-4"><label>Dólar (Rate)</label><input type="number" value={exRate} onChange={e => setExRate(parseFloat(e.target.value))} className="border p-2 rounded ml-2" /></div>
                            <h3 className="font-bold mb-4 border-t pt-4">Empleados</h3>
                            <div className="flex gap-2 mb-4">
                                <input
                                    value={newEmp}
                                    onChange={(e) => setNewEmp(e.target.value)}
                                    placeholder="Nombre del lavador"
                                    className="border p-2 rounded flex-1"
                                />
                                <button onClick={addEmployee} className="bg-blue-600 text-white px-4 py-2 rounded font-bold">
                                    <PlusCircle className="w-5 h-5" />
                                </button>
                            </div>
                            {employees.map((e, i) => (
                                <div key={i} className="flex justify-between p-2 hover:bg-gray-50">
                                    <span>{e.name} ({e.active ? 'Activo' : 'Inactivo'})</span>
                                    <button onClick={() => { const n = [...employees]; n[i].active = !n[i].active; setEmployees(n) }}>{e.active ? <ToggleRight color="green" /> : <ToggleLeft color="gray" />}</button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const ToggleRight = ({ color }) => <div className={`text-${color}-600 font-bold`}>ON</div>;
        const ToggleLeft = ({ color }) => <div className={`text-${color}-400 font-bold`}>OFF</div>;

        // --- MAIN APP ---
        function App() {
            // -- SESSION PERSISTENCE --
            const [role, setRole] = useState(() => localStorage.getItem('lavamex_role') || null);

            const login = (r) => {
                setRole(r);
                localStorage.setItem('lavamex_role', r);
                // Default view based on role
                if (r === 'GREETER') setView('GREETER');
                if (r === 'CASHIER') setView('CASHIER');
                if (r === 'ADMIN') setView('ADMIN');
            };

            const logout = () => {
                setRole(null);
                localStorage.removeItem('lavamex_role');
                setView('GREETER');
            };

            const [view, setView] = useState('GREETER');
            const [editingTicket, setEditingTicket] = useState(null); // State for ticket being edited

            // Shared State
            const [employees, setEmployees] = useState([{ name: 'Aldo', active: true }, { name: 'Sergio', active: true }, { name: 'Juan', active: true }, { name: 'Rodrigo', active: true }]);
            const [exRate, setExRate] = useState(18.10);
            const [tickets, setTickets] = useState([]);
            const [history, setHistory] = useState([]);
            const [deductions, setDeductions] = useState([]);
            const [payment, setPayment] = useState({ mxn: '', usd: '' });
            const [activeId, setActiveId] = useState(null);

            // Listeners
            useEffect(() => {
                const qT = query(collection(db, "tickets"), orderBy("timestamp", "desc"));
                const unsubT = onSnapshot(qT, (snap) => {
                    const active = [], hist = [];
                    snap.forEach(d => {
                        const dat = { id: d.id, ...d.data(), timestamp: d.data().timestamp?.toDate() || new Date() };
                        if (dat.status === 'PENDING') active.push(dat);
                        else hist.push(dat);
                    });
                    setTickets(active); setHistory(hist);
                });
                const unsubD = onSnapshot(collection(db, "deductions"), (snap) => {
                    setDeductions(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubT(); unsubD(); };
            }, []);

            // Actions
            const saveTicket = async (data) => {
                const base = PRICES[data.service.id][data.size.id];
                const comm = COMMISSIONS[data.service.id][data.size.id];
                const extrasPrice = data.extras.reduce((a, b) => a + b.price, 0);
                const extrasComm = data.extras.reduce((a, b) => a + b.commission, 0);

                // If editing, preserve existing snack count. If new, 0.
                const snacks = editingTicket ? (editingTicket.snackCount || 0) : 0;
                const snackCost = snacks * SNACK_PRICE;
                const totalPrice = base + extrasPrice + snackCost;

                const ticketData = {
                    ...data,
                    price: totalPrice,
                    commission: comm + extrasComm,
                    snackCount: snacks,
                    status: 'PENDING',
                    timestamp: serverTimestamp() // Update timestamp to bring to top? Or keep original? Let's update.
                };

                if (editingTicket) {
                    await updateDoc(doc(db, "tickets", editingTicket.id), ticketData);
                    alert("Ticket Actualizado");
                    setEditingTicket(null);
                    if (role === 'CASHIER') setView('CASHIER'); // Return to cashier view if that's who asked
                } else {
                    const ref = await addDoc(collection(db, "tickets"), ticketData);
                    PrintService.jobTicket({ ...ticketData, timestamp: new Date() }, ref.id.slice(-4).toUpperCase());
                    alert("Orden Creada");
                }
            };

            // --- FIXED UPDATE SNACKS FUNCTION ---
            const updateSnacks = async (id, count) => {
                const t = tickets.find(x => x.id === id);
                if (!t) return;
                const newCount = Math.max(0, count);

                // Recalculate Total Price
                const base = PRICES[t.service.id][t.size.id];
                const extras = (t.extras || []).reduce((a, b) => a + b.price, 0);
                const newPrice = base + extras + (newCount * SNACK_PRICE);

                await updateDoc(doc(db, "tickets", id), {
                    snackCount: newCount,
                    price: newPrice
                });
            };

            const startEdit = (ticket) => {
                setEditingTicket(ticket);
                setView('GREETER');
            };

            const cancelEdit = () => {
                setEditingTicket(null);
                if (role === 'CASHIER') setView('CASHIER');
            }

            const processPayment = async () => {
                const t = tickets.find(x => x.id === activeId);
                if (!t) return;
                const total = (parseFloat(payment.mxn) || 0) + ((parseFloat(payment.usd) || 0) * exRate);
                if (total < t.price) return alert("Falta dinero");
                const details = { mxn: parseFloat(payment.mxn) || 0, usd: parseFloat(payment.usd) || 0, rate: exRate, change: total - t.price };
                await updateDoc(doc(db, "tickets", t.id), { status: 'PAID', paidAt: serverTimestamp(), paymentDetails: details });
                PrintService.receipt(t, details, t.id.slice(-4).toUpperCase());
                setActiveId(null); setPayment({ mxn: '', usd: '' });
            };

            if (!role) return <LoginScreen login={login} />;

            return (
                <div className="h-screen flex flex-col bg-gray-100">
                    <header className="bg-slate-900 text-white p-3 flex justify-between items-center shadow-md">
                        <div className="flex items-center gap-2 font-bold text-xl"><Car className="text-blue-400" /> LAVAMEX <span className="text-xs bg-gray-700 px-2 rounded font-normal text-gray-300 ml-2">Rol: {role}</span></div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('GREETER')} className={`px-4 py-2 rounded flex gap-2 ${view === 'GREETER' ? 'bg-blue-600' : 'hover:bg-gray-800'}`}><CheckCircle size={18} /> Entrada</button>
                            {(role === 'CASHIER' || role === 'ADMIN') && (
                                <>
                                    <button onClick={() => setView('CASHIER')} className={`px-4 py-2 rounded flex gap-2 ${view === 'CASHIER' ? 'bg-blue-600' : 'hover:bg-gray-800'}`}><Calculator size={18} /> Caja</button>
                                    <button onClick={() => setView('HISTORY')} className={`px-4 py-2 rounded flex gap-2 ${view === 'HISTORY' ? 'bg-blue-600' : 'hover:bg-gray-800'}`}><History size={18} /> Historial</button>
                                </>
                            )}
                            {role === 'ADMIN' && (
                                <button onClick={() => setView('ADMIN')} className={`px-4 py-2 rounded flex gap-2 ${view === 'ADMIN' ? 'bg-blue-600' : 'hover:bg-gray-800'}`}><Settings size={18} /> Admin</button>
                            )}
                            <button onClick={logout} className="bg-red-900 px-3 rounded ml-4 hover:bg-red-700"><LogOut size={18} /></button>
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden relative">
                        {view === 'GREETER' && <GreeterView employees={employees} saveTicket={saveTicket} editingTicket={editingTicket} cancelEdit={cancelEdit} />}
                        {view === 'CASHIER' && <CashierView tickets={tickets} activeId={activeId} setActiveId={setActiveId} payment={payment} setPayment={setPayment} processPayment={processPayment} deleteTicket={async (id) => { if (confirm("Borrar?")) await updateDoc(doc(db, "tickets", id), { status: 'CANCELLED' }) }} updateSnacks={updateSnacks} addDebt={async (e, c) => addDoc(collection(db, "deductions"), { employee: e, amount: c * SNACK_PRICE, status: 'PENDING', timestamp: serverTimestamp() })} employees={employees} exRate={exRate} startEdit={startEdit} />}
                        {view === 'HISTORY' && <HistoryView history={history.concat(tickets.filter(t => t.status === 'PAID'))} deductions={deductions} />}
                        {view === 'ADMIN' && <AdminPanel employees={employees} setEmployees={setEmployees} history={history} deductions={deductions} db={db} exRate={exRate} setExRate={setExRate} />}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>